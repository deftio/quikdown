<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>quikdown - Live Demo</title>
    <meta name="description" content="Try quikdown - A lightweight markdown parser with plugin support">
    <link rel="icon" href="../favicon.svg" type="image/svg+xml">
    
    <!-- QuikDown theme CSS files -->
    <link rel="stylesheet" href="../dist/quikdown.light.css">
    <link rel="stylesheet" href="../dist/quikdown.dark.css">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #9550bb 0%, #7c3aed 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2c3e50;
            font-weight: 700;
        }
        
        .version {
            background: #9550bb;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .header-links {
            display: flex;
            gap: 1rem;
        }
        
        .header-links a {
            color: #4a5568;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .header-links a:hover {
            background: #f7fafc;
            color: #9550bb;
        }
        
        .controls {
            background: white;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .example-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .example-btn {
            padding: 0.5rem 1rem;
            background: #f7fafc;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .example-btn:hover {
            background: #9550bb;
            color: white;
            border-color: #9550bb;
        }
        
        .example-btn.active {
            background: #9550bb;
            color: white;
            border-color: #9550bb;
        }
        
        .options {
            display: flex;
            gap: 1.5rem;
            margin-left: auto;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .container {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem 2rem;
            overflow: hidden;
        }
        
        .panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            background: #f7fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        #markdown-input {
            width: 100%;
            height: 100%;
            padding: 1.5rem;
            border: none;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            background: #fafafa;
        }
        
        #markdown-input:focus {
            outline: none;
            background: white;
        }
        
        #html-output {
            overflow: auto;
            outline: none;
            min-height: 100%;
        }
        
        #html-output[contenteditable="true"] {
            background: rgba(102, 126, 234, 0.02);
            cursor: text;
        }
        
        #html-output[contenteditable="true"]:focus {
            background: rgba(102, 126, 234, 0.05);
        }
        
        #raw-html {
            padding: 1.5rem;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            color: #2d3748;
            background: #f7fafc;
            display: none;
        }
        
        .stats {
            font-size: 0.75rem;
            color: #718096;
        }
        
        /* Remove custom styles - all theming comes from QuikDown CSS files */
        
        .mermaid {
            text-align: center;
            margin: 1rem 0;
        }
        
        /* Task list styles */
        input[type="checkbox"][disabled] {
            margin-right: 0.5rem;
        }
        
        .error-badge {
            background: #fc8181;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* No custom theme styles - all theming comes from QuikDown CSS files */
        
        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            header {
                padding: 1rem;
            }
            
            .controls {
                padding: 0.75rem 1rem;
                gap: 1rem;
            }
            
            .container {
                flex-direction: column;
            }
            
            .editor, .output {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
        
        @media (max-width: 768px) {
            body {
                height: auto;
                min-height: 100vh;
            }
            
            header {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .header-left {
                width: 100%;
                justify-content: space-between;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .header-links {
                width: 100%;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .header-links a {
                font-size: 0.875rem;
                padding: 0.375rem 0.75rem;
            }
            
            .controls {
                padding: 0.75rem 1rem;
                gap: 1rem;
            }
            
            .example-buttons {
                display: flex;
                overflow-x: auto;
                width: 100%;
                gap: 0.5rem;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0.25rem;
            }
            
            .example-btn {
                flex-shrink: 0;
                font-size: 0.875rem;
                padding: 0.375rem 0.75rem;
            }
            
            .options {
                display: flex;
                gap: 1rem;
            }
            
            .option {
                font-size: 0.875rem;
            }
            
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .editor, .output {
                width: 100%;
                height: 400px;
                border-right: none;
            }
            
            .editor {
                border-bottom: 1px solid #e2e8f0;
            }
            
            #markdown-input, #html-output, #raw-html {
                font-size: 14px;
                padding: 1rem;
            }
            
            .stats-bar {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            header {
                padding: 0.5rem;
            }
            
            h1 {
                font-size: 1.25rem;
            }
            
            .version {
                font-size: 0.75rem;
                padding: 0.125rem 0.375rem;
            }
            
            .header-links a {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
            
            .controls {
                padding: 0.5rem;
            }
            
            .example-btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
            
            .editor, .output {
                height: 350px;
            }
            
            #markdown-input, #html-output, #raw-html {
                font-size: 13px;
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1 style="font-size: 34pt; color:#9550bb">quikdown</h1>
            <span class="version">v1.0.5dev1</span>
        </div>
        <div class="header-links">
            <a href="https://github.com/deftio/quikdown" target="_blank">GitHub</a>
            <a href="https://www.npmjs.com/package/quikdown" target="_blank">NPM</a>
            <a href="./">More Examples</a>
            <a href="../docs/">Documentation</a>
        </div>
    </header>
    
    <div class="controls">
        <div class="example-buttons">
            <button class="example-btn active" onclick="loadExample('comprehensive')">Full Demo</button>
            <button class="example-btn" onclick="loadExample('basic')">Basic Markdown</button>
            <button class="example-btn" onclick="loadExample('bidirectional')">Bidirectional Test</button>
            <button class="example-btn" onclick="loadExample('lazy')">Lazy Linefeeds</button>
            <button class="example-btn" onclick="loadExample('fence')">Code & Plugins</button>
            <button class="example-btn" onclick="loadExample('tables')">Tables</button>
            <button class="example-btn" onclick="loadExample('tasks')">Task Lists</button>
            <button class="example-btn" onclick="loadExample('security')">XSS Protection</button>
        </div>
        
        <div class="options">
            <label class="option">
                <input type="checkbox" id="show-raw" onchange="toggleRawHtml()">
                <span>Show HTML</span>
            </label>
            <label class="option">
                <input type="checkbox" id="inline-styles" onchange="render('markdown')">
                <span>Inline Styles</span>
            </label>
            <label class="option">
                <input type="checkbox" id="enable-plugins" checked onchange="render('markdown')">
                <span>Enable Plugins</span>
            </label>
            <label class="option">
                <input type="checkbox" id="dark-mode" onchange="toggleTheme()">
                <span>Dark Mode</span>
            </label>
            <label class="option" title="Enable editing in the rendered output">
                <input type="checkbox" id="bidirectional" checked onchange="render('markdown')">
                <span>Bidirectional</span>
            </label>
            <label class="option" title="Single newlines become line breaks">
                <input type="checkbox" id="lazy-linefeeds" onchange="render('markdown')">
                <span>Lazy Linefeeds</span>
            </label>
        </div>
    </div>
    
    <div class="container">
        <div class="panel">
            <div class="panel-header">
                <span>Markdown Input</span>
                <span class="stats" id="input-stats"></span>
            </div>
            <div class="panel-content">
                <textarea id="markdown-input" placeholder="Type your markdown here..." spellcheck="false"></textarea>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <span id="output-label">Rendered Output</span>
                <span class="stats" id="render-time"></span>
            </div>
            <div class="panel-content" id="output-container">
                <div id="html-output" contenteditable="false"></div>
                <pre id="raw-html"></pre>
            </div>
        </div>
    </div>
    
    <!-- Load quikdown from dist -->
    <script src="../dist/quikdown.umd.min.js"></script>
    <script src="../dist/quikdown_bd.umd.min.js"></script>
    
    <script>
        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });
        
        // Example content
        const examples = {
            comprehensive: `# Welcome to quikdown! 🚀

A **lightweight**, *fast* markdown parser with plugin support and built-in XSS protection.

## ✨ Key Features

- [x] **Zero dependencies** - No bloat
- [x] **Plugin system** - Extensible fence blocks
- [x] **XSS protection** - Secure by default
- [ ] Your feature request here!

## 📝 Markdown Support

### Text Formatting
You can use **bold**, *italic*, ~~strikethrough~~, and \`inline code\`.
Combine them for ***bold italic*** text!

### Links and Autolinks
- Regular link: [GitHub Repository](https://github.com/deftio/quikdown)
- Autolink: https://npmjs.com/package/quikdown
- Images: ![Badge](https://img.shields.io/badge/quikdown-awesome-green)

## 📊 Tables Without Trailing Pipes

Feature | Description | Status
:--------|:-------------:|-------:
Tables | Work without pipes | ✅
Alignment | Left, center, right | ✅
Markdown | **Bold** in cells | ✅


## 🎨 Code with Syntax Highlighting

\`\`\`javascript
// quikdown with plugin support
import quikdown from 'quikdown';

const html = quikdown(markdown, {
    fence_plugin: (code, language) => {
        // Custom rendering for fence blocks
        if (language === 'mermaid') {
            return renderMermaid(code);
        }
        return hljs.highlight(code, {language}).value;
    }
});
\`\`\`

## 🔧 Alternative Fence Syntax

~~~python
# Python code with ~~~ fences
def parse_markdown(text):
    """Parse markdown with quikdown"""
    return quikdown(text)
~~~

## 📊 Mermaid Diagram Support
Quikdown can render mermaid via its built-in fence mechanism (which can provide call back for mermaidjs).

\`\`\`mermaid
flowchart TD
    A[Markdown] --> B[quikdown Parser]
    B --> C{Plugins?}
    C -->|Yes| D[Enhanced Output]
    C -->|No| E[Standard Output]
    D --> F[Beautiful HTML]
    E --> F
\`\`\`

## 🛡️ Security Features

quikdown automatically escapes HTML to prevent XSS attacks:  
\<script\>alert('This will be escaped!')\<\/script\>

### Quote of the Day
> "The best markdown parser is one that gets out of your way."
> — Happy Developer

---

Try editing this content to see real-time conversion! 
*Render time is shown in the top-right corner.*`,

            basic: `# Basic Markdown Examples

## Headings

# H1 Heading
## H2 Heading
### H3 Heading
#### H4 Heading
##### H5 Heading
###### H6 Heading

## Text Formatting

This is **bold text** using asterisks.
This is __bold text__ using underscores.

This is *italic text* using asterisks.
This is _italic text_ using underscores.

This is ~~strikethrough text~~.

This is \`inline code\`.

## Lists

### Unordered List
- First item
- Second item
  - Nested item
  - Another nested item
- Third item

### Ordered List
1. First step
2. Second step
   1. Sub-step A
   2. Sub-step B
3. Third step

## Links and Images

[Visit GitHub](https://github.com)  
![Placeholder Image](./palm.png)

## Blockquotes

> This is a blockquote.
> It can span multiple lines.

## Horizontal Rule

---

## Line Breaks

First line with two spaces at the end  
Second line appears on a new line.`,

            fence: `# Code Blocks and Fence Plugins

## Standard Code Blocks

### JavaScript with Syntax Highlighting

\`\`\`javascript
// Function to calculate factorial
function factorial(n) {
    if (n <= 1) return 1;
    return n * factorial(n - 1);
}

console.log(factorial(5)); // Output: 120
\`\`\`

### Python with ~~~ Fences

~~~python
# Fibonacci sequence generator
def fibonacci(n):
    a, b = 0, 1
    for _ in range(n):
        yield a
        a, b = b, a + b

# Generate first 10 numbers
for num in fibonacci(10):
    print(num, end=' ')
~~~

### HTML Example

\`\`\`html
<!DOCTYPE html>
<html>
<head>
    <title>quikdown Demo</title>
</head>
<body>
    <h1>Hello World</h1>
</body>
</html>
\`\`\`

## Mermaid Diagrams

### Flowchart

\`\`\`mermaid
flowchart TD
    A[Start] --> B{Is it working?}
    B -->|Yes| C[Great!]
    B -->|No| D[Debug]
    D --> E[Fix issues]
    E --> B
    C --> F[Deploy]
    F --> G[End]
\`\`\`

### Sequence Diagram

\`\`\`mermaid
sequenceDiagram
    participant U as User
    participant C as Client
    participant S as Server
    participant D as Database
    
    U->>C: Click button
    C->>S: HTTP Request
    S->>D: Query data
    D-->>S: Return results
    S-->>C: JSON Response
    C-->>U: Update UI
\`\`\`

### Git Graph

\`\`\`mermaid
gitGraph
    commit
    commit
    branch develop
    checkout develop
    commit
    commit
    checkout main
    merge develop
    commit
    branch feature
    checkout feature
    commit
    commit
    checkout main
    merge feature
\`\`\`

## CSS Example

\`\`\`css
/* quikdown styles */
.quikdown-pre {
    background: #f4f4f4;
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
}

.quikdown-code {
    background: #f0f0f0;
    padding: 2px 4px;
    border-radius: 3px;
}
\`\`\``,

            tables: `# Table Examples

## Basic Table

| Header 1 | Header 2 | Header 3 |
|----------|----------|----------|
| Cell 1   | Cell 2   | Cell 3   |
| Cell 4   | Cell 5   | Cell 6   |

## Table with Alignment

| Left Aligned | Center Aligned | Right Aligned |
|:-------------|:--------------:|--------------:|
| Left         | Center         | Right         |
| 123          | 456            | 789           |
| abc          | def            | ghi           |

## Table Without Leading/Trailing Pipes (GFM Style)

Name | Age | City
-----|-----|-----
Alice | 30 | New York
Bob | 25 | Los Angeles
Carol | 35 | Chicago

## Table with Markdown Content

| Feature | Description | Example |
|---------|-------------|---------|
| **Bold** | Make text bold | **Important** |
| *Italic* | Emphasize text | *emphasis* |
| \`Code\` | Inline code | \`var x = 1\` |
| [Links](https://example.com) | Clickable links | [Click me](https://example.com) |
| ~~Strike~~ | Strikethrough | ~~deleted~~ |

## Complex Table

| Language | Typing | Paradigm | Year | Popular Frameworks |
|----------|--------|----------|------|-------------------|
| **JavaScript** | Dynamic | Multi-paradigm | 1995 | React, Vue, Angular |
| **Python** | Dynamic | Multi-paradigm | 1991 | Django, Flask |
| **TypeScript** | Static | OOP/Functional | 2012 | Same as JS |
| **Rust** | Static | Systems | 2010 | Actix, Rocket |
| **Go** | Static | Concurrent | 2009 | Gin, Echo |`,

            tasks: `# Task Lists and Checklists

## Project Tasks

### Development
- [x] Set up repository
- [x] Initialize npm project
- [x] Configure build tools
- [ ] Write documentation
- [ ] Add more tests

### Features to Implement
- [x] Basic markdown parsing
- [x] Table support
- [x] Code fence plugins
- [x] Task list support
- [ ] Footnotes
- [ ] Table of contents

## Shopping List

- [x] Milk
- [x] Bread
- [ ] Eggs
- [ ] Butter
- [ ] Coffee

## Nested Task Lists

- [x] Main task 1
  - [x] Subtask 1.1
  - [x] Subtask 1.2
  - [ ] Subtask 1.3
- [ ] Main task 2
  - [ ] Subtask 2.1
  - [ ] Subtask 2.2
- [x] Main task 3

## Mixed List Types

1. First ordered item
2. Second ordered item
   - [ ] Nested task
   - [x] Completed nested task
3. Third ordered item

- Unordered item
  1. Nested ordered
  2. Another ordered
     - [x] Deep nested task

## Bug Tracker

### High Priority
- [ ] Fix memory leak in parser
- [ ] Resolve XSS vulnerability
- [x] Update dependencies

### Low Priority
- [ ] Improve performance
- [ ] Add more themes
- [ ] Optimize bundle size`,

            lazy: `# Lazy Linefeeds Demo

## Single Newlines Create Line Breaks

With lazy linefeeds enabled:
This line
And this line
All appear on separate lines!

Without lazy linefeeds:
You need two spaces at the end  
To create a line break.

## Still Works with Paragraphs

Double newlines still create paragraphs.

Like this one!

## Code Blocks Preserved

\`\`\`javascript
// Newlines in code blocks
// are preserved as-is
function test() {
    return true;
}
\`\`\`

## Lists Work Normally

- Item 1
- Item 2
- Item 3

## Perfect for Chat/LLM Output

When users press Enter
They expect a new line
Not a continuous paragraph!

> **Tip:** Toggle the "Lazy Linefeeds" checkbox to see the difference!`,

            bidirectional: `# Bidirectional Editing Test

## Try Editing Either Side!

With **bidirectional mode** enabled, you can:
- Edit this text in the *markdown* panel (left)
- Edit directly in the *rendered* panel (right)
- Changes sync automatically between both!

### Task List (Click checkboxes!)

- [ ] Click these checkboxes in the preview
- [ ] Watch them update in markdown
- [ ] Edit the text directly
- [ ] It all stays in sync!

### Table (Edit cells directly!)

| Feature | Status | Notes |
|---------|--------|-------|
| Edit here | ✅ | Click to edit |
| Or here | ⭐ | Works great! |

> **Tip:** Try editing this blockquote directly in the preview panel!

---

*Bidirectional editing powered by QuikDown* 🔄`,

            security: `# Security Features Demo

## XSS Protection

quikdown automatically escapes HTML tags to prevent XSS attacks:

### Script Tags (Escaped)
&lt;script&gt;alert('This script will not execute!');&lt;/script&gt;

### HTML Injection (Escaped)
&lt;div onclick="alert('XSS')"&gt;This div is escaped&lt;/div&gt;
&lt;img src="#" onerror="alert('XSS')"&gt;

### Safe URL Handling

JavaScript URLs are sanitized:
[Click me](javascript:alert('XSS'))

Data URLs are blocked (except images):
[Download](data:text/html,&lt;script&gt;alert('XSS')&lt;/script&gt;)

But image data URLs work:
![Safe Image](data:image/png;base64,iVBORw0KGgo)

## Safe Markdown Rendering

All these potentially dangerous inputs are handled safely:

1. **HTML entities**: &lt;script&gt; tags are escaped
2. **Event handlers**: onclick, onerror, etc. are removed
3. **Dangerous protocols**: javascript:, vbscript: are blocked

## Trusted Content via Plugins

If you need to render trusted HTML, use the fence plugin system:

\`\`\`html-safe
<!-- This would need a custom plugin to render as HTML -->
<div class="custom-widget">
    <p>Trusted content only!</p>
</div>
\`\`\`

## Testing XSS Vectors

Common XSS attack vectors that are safely handled:

- &lt;iframe src="javascript:alert('XSS')"&gt;
- &lt;object data="javascript:alert('XSS')"&gt;
- &lt;embed src="javascript:alert('XSS')"&gt;
- &lt;img src=# onerror=alert('XSS')&gt;
- &lt;input onfocus=alert('XSS') autofocus&gt;
- &lt;select onfocus=alert('XSS') autofocus&gt;
- &lt;textarea onfocus=alert('XSS') autofocus&gt;
- &lt;button onclick=alert('XSS')&gt;Click&lt;/button&gt;

All the above are rendered as escaped text, not executable HTML.

## Summary

✅ **All HTML is escaped by default**
✅ **JavaScript URLs are sanitized**
✅ **Event handlers are removed**
✅ **Safe for untrusted user input**

> Remember: Security by default, opt-in for trusted content!`
        };
        
        // Fence plugin for syntax highlighting and mermaid
        function fencePlugin(code, language) {
            if (!document.getElementById('enable-plugins').checked) {
                return undefined; // Use default rendering
            }
            
            const bidirectional = document.getElementById('bidirectional').checked;
            
            if (language === 'mermaid') {
                const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                // Escape the code for the data attribute
                const escapedCode = code.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // Store the content to render after DOM update
                setTimeout(() => {
                    const element = document.getElementById(id);
                    if (element && element.parentElement) {
                        mermaid.render(id + '-svg', code).then(result => {
                            // Keep the pre element but update its content
                            element.innerHTML = result.svg;
                        }).catch(err => {
                            console.error('Mermaid render error:', err);
                            element.innerHTML = `<div class="error-badge">Mermaid error: ${err.message}</div>`;
                        });
                    }
                }, 0);
                
                // For bidirectional, preserve the original markdown in data attributes
                if (bidirectional) {
                    return `<div class="mermaid-container" data-qd-fence="\`\`\`" data-qd-lang="mermaid">
                        <pre class="mermaid" id="${id}" data-qd-source="${escapedCode}">Loading diagram...</pre>
                    </div>`;
                } else {
                    return `<div class="mermaid" id="${id}">Loading diagram...</div>`;
                }
            }
            
            if (language && hljs.getLanguage(language)) {
                try {
                    const highlighted = hljs.highlight(code, { language }).value;
                    // For bidirectional, let quikdown handle the attributes
                    if (bidirectional) {
                        // Return undefined to let quikdown handle it with proper data-qd attributes
                        // but only if we want highlighting applied by quikdown's default
                        // Instead, we'll apply highlighting but preserve structure
                        return `<pre data-qd-fence="\`\`\`" data-qd-lang="${language}"><code class="hljs language-${language}">${highlighted}</code></pre>`;
                    } else {
                        return `<pre class="hljs"><code class="language-${language}">${highlighted}</code></pre>`;
                    }
                } catch (err) {
                    // Fall back to default
                }
            }
            
            return undefined; // Use default rendering
        }
        
        // Track if we're updating to prevent infinite loops
        let isUpdating = false;
        
        // Render function
        function render(source = 'markdown') {
            if (isUpdating && source === 'markdown') return;
            
            const startTime = performance.now();
            const input = document.getElementById('markdown-input').value;
            const inlineStyles = document.getElementById('inline-styles').checked;
            const showRaw = document.getElementById('show-raw').checked;
            const darkMode = document.getElementById('dark-mode').checked;
            const bidirectional = document.getElementById('bidirectional').checked;
            const lazyLinefeeds = document.getElementById('lazy-linefeeds').checked;
            const htmlOutput = document.getElementById('html-output');
            
            // Update contenteditable based on bidirectional mode
            htmlOutput.contentEditable = bidirectional ? 'true' : 'false';
            
            // Update output label to indicate if editable
            document.getElementById('output-label').textContent = 
                showRaw ? 'HTML Output' : 
                bidirectional ? 'Rendered Output (Editable)' : 
                'Rendered Output';
            
            try {
                // Use quikdown_bd if bidirectional is enabled, otherwise use regular quikdown
                const parser = bidirectional && typeof quikdown_bd !== 'undefined' ? quikdown_bd : quikdown;
                
                // When using inline styles with dark mode, we need to post-process the HTML
                let html = parser(input, {
                    inline_styles: inlineStyles,
                    fence_plugin: fencePlugin,
                    bidirectional: bidirectional,
                    lazy_linefeeds: lazyLinefeeds
                });
                
                // Apply dark mode transformations to inline styles if needed
                if (inlineStyles && darkMode) {
                    // Replace light colors with dark colors in inline styles
                    html = html.replace(/color:#333/g, 'color:#e0e0e0')  // Default text
                               .replace(/color:#2c3e50/g, 'color:#e0e0e0') // Headers
                               .replace(/color:#2d3748/g, 'color:#e0e0e0') // H2
                               .replace(/color:#4a5568/g, 'color:#b0b0b0') // H3
                               .replace(/background:#f4f4f4/g, 'background:#2a2a2a') // pre
                               .replace(/background:#f0f0f0/g, 'background:#2a2a2a') // code
                               .replace(/background-color:#f2f2f2/g, 'background-color:#2a2a2a') // th
                               .replace(/border:1px solid #ddd/g, 'border:1px solid #3a3a3a') // borders
                               .replace(/border-left:4px solid #ddd/g, 'border-left:4px solid #3a3a3a') // blockquote
                               .replace(/border-top:1px solid #ddd/g, 'border-top:1px solid #3a3a3a') // hr
                               .replace(/color:#06c/g, 'color:#6db3f2'); // links
                    
                    // Add text color to headers that don't have it
                    html = html.replace(/<h([1-6])\s+style="([^"]+)"/g, (match, level, style) => {
                        if (!style.includes('color:')) {
                            return `<h${level} style="${style};color:#e0e0e0"`;
                        }
                        return match;
                    });
                }
                
                // Only update HTML if source is markdown (not from HTML editing)
                if (source === 'markdown') {
                    isUpdating = true;
                    document.getElementById('html-output').innerHTML = html;
                    isUpdating = false;
                }
                document.getElementById('raw-html').textContent = html;
                
                // Update stats
                const endTime = performance.now();
                const renderTime = (endTime - startTime).toFixed(2);
                document.getElementById('render-time').textContent = `${renderTime}ms`;
                
                const charCount = input.length;
                const lineCount = input.split('\n').length;
                document.getElementById('input-stats').textContent = `${charCount} chars, ${lineCount} lines`;
                
            } catch (err) {
                document.getElementById('html-output').innerHTML = 
                    '<div class="error-badge">Render Error</div><pre>' + err + '</pre>';
            }
        }
        
        // Load example
        function loadExample(name) {
            document.getElementById('markdown-input').value = examples[name] || examples.comprehensive;
            
            // Update active button
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            render('markdown');
        }
        
        // Toggle raw HTML view
        function toggleRawHtml() {
            const showRaw = document.getElementById('show-raw').checked;
            document.getElementById('html-output').style.display = showRaw ? 'none' : 'block';
            document.getElementById('raw-html').style.display = showRaw ? 'block' : 'none';
            document.getElementById('output-label').textContent = showRaw ? 'HTML Output' : 'Rendered Output';
        }
        
        // Toggle dark mode
        function toggleTheme() {
            const darkMode = document.getElementById('dark-mode').checked;
            const htmlOutput = document.getElementById('html-output');
            const inlineStyles = document.getElementById('inline-styles').checked;
            
            // Apply the proper theme class to the content
            if (darkMode) {
                htmlOutput.classList.remove('quikdown-light');
                htmlOutput.classList.add('quikdown-dark');
            } else {
                htmlOutput.classList.remove('quikdown-dark');
                htmlOutput.classList.add('quikdown-light');
            }
            
            localStorage.setItem('quikdown-theme', darkMode ? 'dark' : 'light');
            
            // Re-render if using inline styles to apply theme colors
            if (inlineStyles) {
                render('markdown');
            }
        }
        
        // Convert HTML back to Markdown when edited
        function convertHtmlToMarkdown() {
            if (!document.getElementById('bidirectional').checked) return;
            if (isUpdating) return;
            
            const htmlOutput = document.getElementById('html-output');
            
            try {
                isUpdating = true;
                // Use quikdown_bd.toMarkdown to convert back
                if (typeof quikdown_bd !== 'undefined' && quikdown_bd.toMarkdown) {
                    const markdown = quikdown_bd.toMarkdown(htmlOutput);
                    document.getElementById('markdown-input').value = markdown;
                    
                    // Update raw HTML display
                    document.getElementById('raw-html').textContent = htmlOutput.innerHTML;
                }
                isUpdating = false;
            } catch (err) {
                console.error('Error converting HTML to Markdown:', err);
                isUpdating = false;
            }
        }
        
        // Auto-render on input
        document.getElementById('markdown-input').addEventListener('input', () => render('markdown'));
        
        // Listen for changes in the HTML output when bidirectional is enabled
        document.getElementById('html-output').addEventListener('input', convertHtmlToMarkdown);
        
        // Handle checkbox clicks in rendered output
        document.getElementById('html-output').addEventListener('click', (e) => {
            if (e.target.type === 'checkbox' && document.getElementById('bidirectional').checked) {
                // Allow checkbox to toggle then convert back to markdown
                setTimeout(convertHtmlToMarkdown, 10);
            }
        });
        
        // Initialize with comprehensive example
        document.getElementById('markdown-input').value = examples.comprehensive;
        
        // Show version
        if (typeof quikdown !== 'undefined' && quikdown.version) {
            document.querySelector('.version').textContent = 'v' + quikdown.version;
        }
        
        // Restore theme preference and set initial theme class
        const savedTheme = localStorage.getItem('quikdown-theme');
        const htmlOutput = document.getElementById('html-output');
        
        if (savedTheme === 'dark') {
            document.getElementById('dark-mode').checked = true;
            htmlOutput.classList.add('quikdown-dark');
        } else {
            htmlOutput.classList.add('quikdown-light');
        }
        
        // Now render with the theme applied
        render('markdown');
    </script>
</body>
</html>