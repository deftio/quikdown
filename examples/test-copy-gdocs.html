<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Copy to Google Docs</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml">
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
        }
        .output {
            background: #f5f5f5;
            padding: 10px;
            min-height: 300px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #e7f5ff;
            border-radius: 4px;
            display: none;
        }
        .status.show {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Test Copy to Google Docs</h1>
    <p>This page tests the improved copy functionality for pasting into Google Docs</p>
    
    <div style="margin: 20px 0;">
        <button onclick="testCopy()">Copy Test Text</button>
        <button onclick="copyMarkdown()">Copy as Markdown</button>
        <button onclick="copyHTML()">Copy as HTML</button>
        <div class="status" id="status"></div>
    </div>

    <div class="container">
        <div class="panel">
            <h3>Markdown Input</h3>
            <textarea id="markdown"># Test Document

## Introduction
This is a test document with **bold** and *italic* text.

### Features
- Bullet point 1
- Bullet point 2
- Bullet point 3

### Code Example
```javascript
function hello() {
    console.log("Hello World");
    return true;
}
```

### Table Example
| Column 1 | Column 2 | Column 3 |
|----------|----------|----------|
| Data 1   | Data 2   | Data 3   |
| Data 4   | Data 5   | Data 6   |

### Links
Check out [QuikDown](https://github.com/deftio/quikdown) on GitHub.

---

That's all for now!</textarea>
        </div>
        
        <div class="panel">
            <h3>Extracted Plain Text</h3>
            <div class="output" id="output"></div>
        </div>
    </div>

    <script type="module">
        import quikdown from '../dist/quikdown_edit.esm.js';
        import quikdown_bd from '../dist/quikdown_bd.esm.js';
        
        function updateOutput() {
            const markdown = document.getElementById('markdown').value;
            const html = quikdown(markdown);
            
            // Create temp div to extract text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Extract text with proper formatting
            const extractText = (node) => {
                let text = '';
                
                for (let child of node.childNodes) {
                    if (child.nodeType === Node.TEXT_NODE) {
                        text += child.textContent;
                    } else if (child.nodeType === Node.ELEMENT_NODE) {
                        const tagName = child.tagName.toLowerCase();
                        
                        // Add line breaks for block elements
                        if (['p', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
                            if (text && !text.endsWith('\n')) text += '\n';
                            text += extractText(child);
                            if (!text.endsWith('\n')) text += '\n';
                        }
                        // Add line break after br tags
                        else if (tagName === 'br') {
                            text += '\n';
                        }
                        // List items
                        else if (tagName === 'li') {
                            text += '• ' + extractText(child).trim() + '\n';
                        }
                        // Preserve code blocks
                        else if (tagName === 'pre') {
                            text += '\n' + extractText(child) + '\n';
                        }
                        // Tables - add tabs
                        else if (tagName === 'td' || tagName === 'th') {
                            text += extractText(child) + '\t';
                        }
                        // Table rows
                        else if (tagName === 'tr') {
                            text += extractText(child).replace(/\t$/, '') + '\n';
                        }
                        // Default
                        else {
                            text += extractText(child);
                        }
                    }
                }
                
                return text;
            };
            
            let result = extractText(tempDiv);
            result = result.replace(/\n{3,}/g, '\n\n').trim();
            
            document.getElementById('output').textContent = result;
            return result;
        }
        
        window.testCopy = async function() {
            const text = updateOutput();
            
            try {
                await navigator.clipboard.writeText(text);
                showStatus('✓ Text copied! Try pasting in Google Docs', 'success');
            } catch (err) {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                textarea.remove();
                showStatus('✓ Text copied (fallback)! Try pasting in Google Docs', 'success');
            }
        };
        
        window.copyMarkdown = async function() {
            const markdown = document.getElementById('markdown').value;
            try {
                await navigator.clipboard.writeText(markdown);
                showStatus('✓ Markdown copied!', 'success');
            } catch (err) {
                console.error(err);
                showStatus('✗ Failed to copy', 'error');
            }
        };
        
        window.copyHTML = async function() {
            const markdown = document.getElementById('markdown').value;
            const html = quikdown(markdown);
            try {
                await navigator.clipboard.writeText(html);
                showStatus('✓ HTML copied!', 'success');
            } catch (err) {
                console.error(err);
                showStatus('✗ Failed to copy', 'error');
            }
        };
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status show';
            status.style.background = type === 'success' ? '#d3f9d8' : '#ffe3e3';
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }
        
        // Initial render
        updateOutput();
        
        // Update on input
        document.getElementById('markdown').addEventListener('input', updateOutput);
    </script>
</body>
</html>