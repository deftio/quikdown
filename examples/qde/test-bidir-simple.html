<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple Bidirectional Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        #editor {
            height: 600px;
            border: 2px solid #007bff;
            border-radius: 4px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        #log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Simple Bidirectional Code Block Test</h1>
    
    <div class="status">
        <strong>Test:</strong> Edit the code block in the rendered view (right side) and check if changes appear in source (left side).<br>
        <strong>Expected:</strong> Code block content should sync between views.
    </div>
    
    <div id="editor"></div>
    
    <div id="log">
        <strong>Debug Log:</strong><br>
    </div>
    
    <script type="module">
        import QuikdownEditor from '../../dist/quikdown_edit.esm.js';
        
        const logElement = document.getElementById('log');
        function log(msg) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${msg}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        log('Initializing editor...');
        
        const editor = new QuikdownEditor('#editor', { 
            mode: 'split',
            plugins: { 
                highlightjs: true
            },
            onChange: (markdown, html) => {
                // Check if data-qd-source is present in code blocks
                const hasDataSource = html.includes('data-qd-source');
                log(`Content changed - Has data-qd-source: ${hasDataSource}`);
                
                // Check for highlight.js
                if (window.hljs) {
                    log('highlight.js is loaded');
                } else {
                    log('highlight.js NOT loaded yet');
                }
            }
        });
        
        log('Editor initialized');
        
        // Simple test content with just one code block
        const testContent = `# Code Block Test

\`\`\`javascript
function test() {
    console.log("Hello World");
    return 42;
}
\`\`\`

Try editing the code above in the rendered view.`;
        
        editor.setMarkdown(testContent);
        log('Test content loaded');
        
        // Check for libraries after a delay
        setTimeout(() => {
            log(`After 2s - highlight.js loaded: ${!!window.hljs}`);
            
            // Get the rendered HTML and check for data-qd-source
            const html = editor.getHTML();
            const hasSource = html.includes('data-qd-source');
            log(`HTML has data-qd-source: ${hasSource}`);
            
            // Parse and check
            const div = document.createElement('div');
            div.innerHTML = html;
            const pre = div.querySelector('pre[data-qd-source]');
            if (pre) {
                log(`Found pre with data-qd-source: "${pre.getAttribute('data-qd-source')}"`);
            } else {
                log('No pre element with data-qd-source found!');
            }
        }, 2000);
    </script>
</body>
</html>