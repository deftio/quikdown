<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SVG Debug Test 2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        #editor {
            height: 400px;
            border: 2px solid #007bff;
            border-radius: 4px;
        }
        
        button {
            margin: 10px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 10px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>SVG Debug Test 2</h1>
    
    <div id="editor"></div>
    <button onclick="testEdit()">Test Edit (trigger round-trip)</button>
    <button onclick="clearConsole()">Clear Console</button>
    <div id="console"></div>
    
    <script type="module">
        import QuikdownEditor from '../../dist/quikdown_edit.esm.min.js';
        
        // Enable debugging
        window.DEBUG_SVG = true;
        
        // Capture console logs
        const consoleEl = document.getElementById('console');
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            consoleEl.textContent += args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ') + '\n';
        };
        
        window.editor = new QuikdownEditor('#editor', { 
            mode: 'split'
        });
        
        const testContent = `# SVG Test

\`\`\`svg
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  <circle cx="50" cy="50" r="40" fill="red"/>
  <text x="50" y="55" text-anchor="middle" fill="white">TEST</text>
</svg>
\`\`\`

Regular text to edit.`;
        
        editor.setMarkdown(testContent);
        
        window.testEdit = function() {
            console.log('=== Starting round-trip test ===');
            
            // First check what's in the preview
            const svgContainer = editor.previewPanel.querySelector('.qde-svg-container');
            if (svgContainer) {
                console.log('SVG container attributes:');
                console.log('  contenteditable:', svgContainer.getAttribute('contenteditable'));
                console.log('  data-qd-source exists:', !!svgContainer.getAttribute('data-qd-source'));
                console.log('  data-qd-source length:', svgContainer.getAttribute('data-qd-source')?.length);
            }
            
            // Edit some text to trigger conversion
            const p = editor.previewPanel.querySelector('p');
            if (p) {
                p.textContent = 'Modified text.';
                // Trigger the input event
                editor.previewPanel.dispatchEvent(new Event('input'));
            }
            
            // Check the result
            setTimeout(() => {
                const markdown = editor.getMarkdown();
                if (markdown.includes('```svg\n\n```')) {
                    console.log('❌ ERROR: SVG content was lost!');
                } else {
                    console.log('✅ SUCCESS: SVG content preserved');
                }
                console.log('=== End test ===');
            }, 100);
        };
        
        window.clearConsole = function() {
            consoleEl.textContent = '';
        };
    </script>
</body>
</html>