/**
 * Quikdown Editor - Drop-in Markdown Parser
 * @version 1.1.1
 * @license BSD-2-Clause
 * @copyright DeftIO 2025
 */
const e="quikdown-",t="§CB",n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},r={h1:"font-size:2em;font-weight:600;margin:.67em 0;text-align:left",h2:"font-size:1.5em;font-weight:600;margin:.83em 0",h3:"font-size:1.25em;font-weight:600;margin:1em 0",h4:"font-size:1em;font-weight:600;margin:1.33em 0",h5:"font-size:.875em;font-weight:600;margin:1.67em 0",h6:"font-size:.85em;font-weight:600;margin:2em 0",pre:"background:#f4f4f4;padding:10px;border-radius:4px;overflow-x:auto;margin:1em 0",code:"background:#f0f0f0;padding:2px 4px;border-radius:3px;font-family:monospace",blockquote:"border-left:4px solid #ddd;margin-left:0;padding-left:1em",table:"border-collapse:collapse;width:100%;margin:1em 0",th:"border:1px solid #ddd;padding:8px;background-color:#f2f2f2;font-weight:bold;text-align:left",td:"border:1px solid #ddd;padding:8px;text-align:left",hr:"border:none;border-top:1px solid #ddd;margin:1em 0",img:"max-width:100%;height:auto",a:"color:#06c;text-decoration:underline",strong:"font-weight:bold",em:"font-style:italic",del:"text-decoration:line-through",ul:"margin:.5em 0;padding-left:2em",ol:"margin:.5em 0;padding-left:2em",li:"margin:.25em 0","task-item":"list-style:none","task-checkbox":"margin-right:.5em"};function o(o,a={}){if(!o||"string"!=typeof o)return"";const{fence_plugin:s,inline_styles:l=!1,bidirectional:d=!1,lazy_linefeeds:c=!1}=a,h=function(t,n){return function(r,o=""){if(t){let e=n[r];return e||o?(o&&o.includes("text-align")&&e&&e.includes("text-align")&&(e=e.replace(/text-align:[^;]+;?/,"").trim(),e&&!e.endsWith(";")&&(e+=";")),` style="${o?e?`${e}${o}`:o:e}"`):""}{const t=` class="${e}${r}"`;return o?`${t} style="${o}"`:t}}}(l,r);function u(e){return e.replace(/[&<>"']/g,e=>n[e])}const p=d?e=>` data-qd="${u(e)}"`:()=>"";function m(e,t=!1){if(!e)return"";if(t)return e;const n=e.trim(),r=n.toLowerCase(),o=["javascript:","vbscript:","data:"];for(const e of o)if(r.startsWith(e))return"data:"===e&&r.startsWith("data:image/")?n:"#";return n}let g=o;const f=[],b=[];g=g.replace(/^(```|~~~)([^\n]*)\n([\s\S]*?)^\1$/gm,(e,n,r,o)=>{const a=`${t}${f.length}§`,i=r?r.trim():"";return s&&s.render&&"function"==typeof s.render?f.push({lang:i,code:o.trimEnd(),custom:!0,fence:n,hasReverse:!!s.reverse}):f.push({lang:i,code:u(o.trimEnd()),custom:!1,fence:n}),a}),g=g.replace(/`([^`]+)`/g,(e,t)=>{const n=`§IC${b.length}§`;return b.push(u(t)),n}),g=u(g),g=function(e,t){const n=e.split("\n"),r=[];let o=!1,a=[];for(let e=0;e<n.length;e++){const s=n[e].trim();if(s.includes("|")&&(s.startsWith("|")||/[^\\|]/.test(s)))o||(o=!0,a=[]),a.push(s);else{if(o){const e=i(a,t);e?r.push(e):r.push(...a),o=!1,a=[]}r.push(n[e])}}if(o&&a.length>0){const e=i(a,t);e?r.push(e):r.push(...a)}return r.join("\n")}(g,h),g=g.replace(/^(#{1,6})\s+(.+?)\s*#*$/gm,(e,t,n)=>{const r=t.length;return`<h${r}${h("h"+r)}${p(t)}>${n}</h${r}>`}),g=g.replace(/^&gt;\s+(.+)$/gm,`<blockquote${h("blockquote")}>$1</blockquote>`),g=g.replace(/<\/blockquote>\n<blockquote>/g,"\n"),g=g.replace(/^---+\s*$/gm,`<hr${h("hr")}>`),g=function(t,n,r,o){const a=t.split("\n"),i=[];let s=[];const l=e=>e.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])),d=o?e=>` data-qd="${l(e)}"`:()=>"";for(let t=0;t<a.length;t++){const o=a[t],l=o.match(/^(\s*)([*\-+]|\d+\.)\s+(.+)$/);if(l){const[,t,o,a]=l,c=Math.floor(t.length/2),h=/^\d+\./.test(o),u=h?"ol":"ul";let p=a,m="";const g=a.match(/^\[([x ])\]\s+(.*)$/i);if(g&&!h){const[,t,n]=g,o="x"===t.toLowerCase();p=`<input type="checkbox"${r?' style="margin-right:.5em"':` class="${e}task-checkbox"`}${o?" checked":""} disabled> ${n}`,m=r?' style="list-style:none"':` class="${e}task-item"`}for(;s.length>c+1;){const e=s.pop();i.push(`</${e.type}>`)}if(s.length===c)s.push({type:u,level:c}),i.push(`<${u}${n(u)}>`);else if(s.length===c+1){const e=s[s.length-1];e.type!==u&&(i.push(`</${e.type}>`),s.pop(),s.push({type:u,level:c}),i.push(`<${u}${n(u)}>`))}const f=m||n("li");i.push(`<li${f}${d(o)}>${p}</li>`)}else{for(;s.length>0;){const e=s.pop();i.push(`</${e.type}>`)}i.push(o)}}for(;s.length>0;){const e=s.pop();i.push(`</${e.type}>`)}return i.join("\n")}(g,h,l,d),g=g.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,(e,t,n)=>{const r=m(n,a.allow_unsafe_urls),o=d&&t?` data-qd-alt="${u(t)}"`:"",i=d?` data-qd-src="${u(n)}"`:"";return`<img${h("img")} src="${r}" alt="${t}"${o}${i}${p("!")}>`}),g=g.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const r=m(n,a.allow_unsafe_urls),o=/^https?:\/\//i.test(r)?' rel="noopener noreferrer"':"",i=d?` data-qd-text="${u(t)}"`:"";return`<a${h("a")} href="${r}"${o}${i}${p("[")}>${t}</a>`}),g=g.replace(/(^|\s)(https?:\/\/[^\s<]+)/g,(e,t,n)=>{const r=m(n,a.allow_unsafe_urls);return`${t}<a${h("a")} href="${r}" rel="noopener noreferrer">${n}</a>`});if([[/\*\*(.+?)\*\*/g,"strong","**"],[/__(.+?)__/g,"strong","__"],[/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,"em","*"],[/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g,"em","_"],[/~~(.+?)~~/g,"del","~~"]].forEach(([e,t,n])=>{g=g.replace(e,`<${t}${h(t)}${p(n)}>$1</${t}>`)}),c){const e=[];let t=0;g=g.replace(/<(table|[uo]l)[^>]*>[\s\S]*?<\/\1>/g,n=>(e[t]=n,`§B${t++}§`)),g=g.replace(/\n\n+/g,"§P§").replace(/(<\/(?:h[1-6]|blockquote|pre)>)\n/g,"$1§N§").replace(/(<(?:h[1-6]|blockquote|pre|hr)[^>]*>)\n/g,"$1§N§").replace(/\n(<(?:h[1-6]|blockquote|pre|hr)[^>]*>)/g,"§N§$1").replace(/\n(§B\d+§)/g,"§N§$1").replace(/(§B\d+§)\n/g,"$1§N§").replace(/\n/g,`<br${h("br")}>`).replace(/§N§/g,"\n").replace(/§P§/g,"</p><p>"),e.forEach((e,t)=>g=g.replace(`§B${t}§`,e)),g="<p>"+g+"</p>"}else g=g.replace(/  $/gm,`<br${h("br")}>`),g=g.replace(/\n\n+/g,(e,t)=>g.substring(0,t).match(/<\/(h[1-6]|blockquote|ul|ol|table|pre|hr)>$/)?"<p>":"</p><p>"),g="<p>"+g+"</p>";return[[/<p><\/p>/g,""],[/<p>(<h[1-6][^>]*>)/g,"$1"],[/(<\/h[1-6]>)<\/p>/g,"$1"],[/<p>(<blockquote[^>]*>)/g,"$1"],[/(<\/blockquote>)<\/p>/g,"$1"],[/<p>(<ul[^>]*>|<ol[^>]*>)/g,"$1"],[/(<\/ul>|<\/ol>)<\/p>/g,"$1"],[/<p>(<hr[^>]*>)<\/p>/g,"$1"],[/<p>(<table[^>]*>)/g,"$1"],[/(<\/table>)<\/p>/g,"$1"],[/<p>(<pre[^>]*>)/g,"$1"],[/(<\/pre>)<\/p>/g,"$1"],[new RegExp(`<p>(${t}\\d+§)</p>`,"g"),"$1"]].forEach(([e,t])=>{g=g.replace(e,t)}),g=g.replace(/(<\/(?:h[1-6]|blockquote|ul|ol|table|pre|hr)>)\n([^<])/g,"$1\n<p>$2"),f.forEach((e,n)=>{let r;if(e.custom&&s&&s.render)if(r=s.render(e.code,e.lang),void 0===r){const t=!l&&e.lang?` class="language-${e.lang}"`:"",n=l?h("code"):t,o=d&&e.lang?` data-qd-lang="${u(e.lang)}"`:"",a=d?` data-qd-fence="${u(e.fence)}"`:"";r=`<pre${h("pre")}${a}${o}><code${n}>${u(e.code)}</code></pre>`}else d&&(r=r.replace(/^<(\w+)/,`<$1 data-qd-fence="${u(e.fence)}" data-qd-lang="${u(e.lang)}" data-qd-source="${u(e.code)}"`));else{const t=!l&&e.lang?` class="language-${e.lang}"`:"",n=l?h("code"):t,o=d&&e.lang?` data-qd-lang="${u(e.lang)}"`:"",a=d?` data-qd-fence="${u(e.fence)}"`:"";r=`<pre${h("pre")}${a}${o}><code${n}>${e.code}</code></pre>`}const o=`${t}${n}§`;g=g.replace(o,r)}),b.forEach((e,t)=>{const n=`§IC${t}§`;g=g.replace(n,`<code${h("code")}${p("`")}>${e}</code>`)}),g.trim()}function a(e,t){return[[/\*\*(.+?)\*\*/g,"strong"],[/__(.+?)__/g,"strong"],[/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,"em"],[/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g,"em"],[/~~(.+?)~~/g,"del"],[/`([^`]+)`/g,"code"]].forEach(([n,r])=>{e=e.replace(n,`<${r}${t(r)}>$1</${r}>`)}),e}function i(e,t){if(e.length<2)return null;let n=-1;for(let t=1;t<e.length;t++)if(/^\|?[\s\-:|]+\|?$/.test(e[t])&&e[t].includes("-")){n=t;break}if(-1===n)return null;const r=e.slice(0,n),o=e.slice(n+1),i=e[n].trim().replace(/^\|/,"").replace(/\|$/,"").split("|").map(e=>{const t=e.trim();return t.startsWith(":")&&t.endsWith(":")?"center":t.endsWith(":")?"right":"left"});let s=`<table${t("table")}>\n`;return s+=`<thead${t("thead")}>\n`,r.forEach(e=>{s+=`<tr${t("tr")}>\n`;e.trim().replace(/^\|/,"").replace(/\|$/,"").split("|").forEach((e,n)=>{const r=i[n]&&"left"!==i[n]?`text-align:${i[n]}`:"",o=a(e.trim(),t);s+=`<th${t("th",r)}>${o}</th>\n`}),s+="</tr>\n"}),s+="</thead>\n",o.length>0&&(s+=`<tbody${t("tbody")}>\n`,o.forEach(e=>{s+=`<tr${t("tr")}>\n`;e.trim().replace(/^\|/,"").replace(/\|$/,"").split("|").forEach((e,n)=>{const r=i[n]&&"left"!==i[n]?`text-align:${i[n]}`:"",o=a(e.trim(),t);s+=`<td${t("td",r)}>${o}</td>\n`}),s+="</tr>\n"}),s+="</tbody>\n"),s+="</table>",s}function s(e,t={}){return o(e,{...t,bidirectional:!0})}async function l(e){return new Promise((t,n)=>{const r=(new XMLSerializer).serializeToString(e),o=document.createElement("canvas"),a=o.getContext("2d"),i=new Image,s=e.closest(".mermaid")||e.classList.contains("mermaid"),l=e.getAttribute("width")&&e.getAttribute("height");let d,c;s||!l?(d=e.clientWidth||e.viewBox&&e.viewBox.baseVal.width||parseFloat(e.getAttribute("width"))||400,c=e.clientHeight||e.viewBox&&e.viewBox.baseVal.height||parseFloat(e.getAttribute("height"))||300):(d=parseFloat(e.getAttribute("width"))||e.viewBox&&e.viewBox.baseVal.width||e.clientWidth||400,c=parseFloat(e.getAttribute("height"))||e.viewBox&&e.viewBox.baseVal.height||e.clientHeight||300);let h=r;if(d&&c){const e=document.createElement("div");e.innerHTML=r;const t=e.querySelector("svg");t&&(t.setAttribute("width",d.toString()),t.setAttribute("height",c.toString()),h=(new XMLSerializer).serializeToString(t))}o.width=2*d,o.height=2*c,a.scale(2,2),i.onload=()=>{try{a.clearRect(0,0,o.width,o.height),a.drawImage(i,0,0,d,c),o.toBlob(e=>{t(e)},"image/png",1)}catch(e){n(e)}},i.onerror=n;const u=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(h)}`;i.src=u})}async function d(e){if(!e)throw new Error("No preview panel available");const t=e.cloneNode(!0);try{t.querySelectorAll("strong, b").forEach(e=>{e.style.fontWeight="bold"}),t.querySelectorAll("em, i").forEach(e=>{e.style.fontStyle="italic"}),t.querySelectorAll("del, s, strike").forEach(e=>{e.style.textDecoration="line-through"}),t.querySelectorAll("u").forEach(e=>{e.style.textDecoration="underline"}),t.querySelectorAll("code:not(pre code)").forEach(e=>{e.style.backgroundColor="#f4f4f4",e.style.padding="2px 4px",e.style.borderRadius="3px",e.style.fontFamily="monospace",e.style.fontSize="0.9em"}),t.querySelectorAll("h1").forEach(e=>{e.style.fontSize="2em",e.style.fontWeight="bold",e.style.marginTop="0.67em",e.style.marginBottom="0.67em"}),t.querySelectorAll("h2").forEach(e=>{e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.marginTop="0.83em",e.style.marginBottom="0.83em"}),t.querySelectorAll("h3").forEach(e=>{e.style.fontSize="1.17em",e.style.fontWeight="bold",e.style.marginTop="1em",e.style.marginBottom="1em"}),t.querySelectorAll("h4").forEach(e=>{e.style.fontSize="1em",e.style.fontWeight="bold",e.style.marginTop="1.33em",e.style.marginBottom="1.33em"}),t.querySelectorAll("h5").forEach(e=>{e.style.fontSize="0.83em",e.style.fontWeight="bold",e.style.marginTop="1.67em",e.style.marginBottom="1.67em"}),t.querySelectorAll("h6").forEach(e=>{e.style.fontSize="0.67em",e.style.fontWeight="bold",e.style.marginTop="2.33em",e.style.marginBottom="2.33em"}),t.querySelectorAll("blockquote").forEach(e=>{e.style.borderLeft="4px solid #ddd",e.style.marginLeft="0",e.style.paddingLeft="1em",e.style.color="#666"}),t.querySelectorAll("hr").forEach(e=>{e.style.border="none",e.style.borderTop="1px solid #ccc",e.style.margin="1em 0"}),t.querySelectorAll("table").forEach(e=>{e.style.borderCollapse="collapse",e.style.width="100%",e.style.marginBottom="1em"}),t.querySelectorAll("th").forEach(e=>{e.style.border="1px solid #ccc",e.style.padding="8px",e.style.textAlign="left",e.style.backgroundColor="#f0f0f0",e.style.fontWeight="bold"}),t.querySelectorAll("td").forEach(e=>{e.style.border="1px solid #ccc",e.style.padding="8px",e.style.textAlign="left"}),t.querySelectorAll("a").forEach(e=>{e.style.color="#0066cc",e.style.textDecoration="underline"}),t.querySelectorAll("pre code").forEach(e=>{const t=e.parentElement,n=document.createElement("table");n.style.width="100%",n.style.borderCollapse="collapse",n.style.border="none",n.style.marginBottom="1em";const r=document.createElement("tr"),o=document.createElement("td");o.style.backgroundColor="#f7f7f7",o.style.padding="12px",o.style.fontFamily='Consolas, Monaco, "Courier New", monospace',o.style.fontSize="14px",o.style.lineHeight="1.4",o.style.whiteSpace="pre",o.style.overflowX="auto",o.style.border="1px solid #ddd",o.style.borderRadius="4px",o.innerHTML=e.innerHTML,r.appendChild(o),n.appendChild(r),t.parentNode.replaceChild(n,t)});const n=t.querySelectorAll("img");for(const e of n)if(e.src&&!e.src.startsWith("data:"))try{const t=await fetch(e.src),n=await t.blob(),r=await new Promise(e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(n)});e.src=r}catch(t){console.warn("Failed to convert image to data URL:",e.src,t)}const r=t.querySelectorAll(".qde-stl-container");for(const t of r){try{const n=t.dataset.stlId,r=e.querySelector(`.qde-stl-container[data-stl-id="${n}"]`);if(r){const e=r.querySelector("canvas");if(e&&e.width>0&&e.height>0)try{const n=r._threeRenderer,o=r._threeScene,a=r._threeCamera;n&&o&&a&&n.render(o,a);const i=e.toDataURL("image/png",1),s=document.createElement("img");s.src=i;const l=e.width/2,d=e.height/2;s.width=l,s.height=d,s.setAttribute("width",l.toString()),s.setAttribute("height",d.toString()),s.style.width=l+"px",s.style.height=d+"px",s.style.maxWidth="none",s.style.maxHeight="none",s.style.border="1px solid #ddd",s.style.borderRadius="4px",s.style.margin="0.5em 0",s.setAttribute("v:shapes","image"+Math.random().toString(36).substr(2,9)),s.alt="STL 3D Model",t.parentNode.replaceChild(s,t);continue}catch(e){console.warn("Failed to convert STL canvas to image (likely WebGL context issue):",e)}else console.warn("No valid canvas found in STL container")}else console.warn("Could not find original STL container")}catch(e){console.error("Error processing STL container for copy:",e)}const n=document.createElement("div");n.style.cssText="padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;",n.textContent="[STL 3D Model - Interactive content not available in copy]",t.parentNode.replaceChild(n,t)}const o=t.querySelectorAll(".mermaid");for(const e of o){const t=e.querySelector("svg");if(t)try{const n=await l(t),r=await new Promise(e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(n)}),o=document.createElement("img");o.src=r;const a=t.closest(".mermaid")||t.classList.contains("mermaid"),i=t.getAttribute("width")&&t.getAttribute("height");let s,d;a||!i?(s=t.clientWidth||t.viewBox&&t.viewBox.baseVal.width||parseFloat(t.getAttribute("width"))||400,d=t.clientHeight||t.viewBox&&t.viewBox.baseVal.height||parseFloat(t.getAttribute("height"))||300):(s=parseFloat(t.getAttribute("width"))||t.viewBox&&t.viewBox.baseVal.width||t.clientWidth||400,d=parseFloat(t.getAttribute("height"))||t.viewBox&&t.viewBox.baseVal.height||t.clientHeight||300),o.width=s,o.height=d,o.setAttribute("width",s.toString()),o.setAttribute("height",d.toString()),o.style.width=s+"px",o.style.height=d+"px",o.style.maxWidth="none",o.style.maxHeight="none",o.setAttribute("v:shapes","image"+Math.random().toString(36).substr(2,9)),o.alt="Mermaid Diagram",e.parentNode.replaceChild(o,e)}catch(e){console.warn("Failed to convert Mermaid diagram:",e)}}const a=t.querySelectorAll(".qde-chart-container");for(const t of a){try{const n=t.dataset.chartId,r=e.querySelector(`.qde-chart-container[data-chart-id="${n}"]`);if(r){const e=r.querySelector("canvas");if(e&&e.width>0&&e.height>0)try{const n=e.toDataURL("image/png",1),r=document.createElement("img");r.src=n;const o=e.width,a=e.height;r.width=o,r.height=a,r.setAttribute("width",o.toString()),r.setAttribute("height",a.toString()),r.style.width=o+"px",r.style.height=a+"px",r.style.maxWidth="none",r.style.maxHeight="none",r.style.margin="0.5em 0",r.setAttribute("v:shapes","image"+Math.random().toString(36).substr(2,9)),r.alt="Chart",t.parentNode.replaceChild(r,t);continue}catch(e){console.warn("Failed to convert chart canvas to image:",e)}}}catch(e){console.warn("Error processing chart container:",e)}const n=document.createElement("div");n.style.cssText="padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;",n.textContent="[Chart - Interactive content not available in copy]",t.parentNode.replaceChild(n,t)}const i=t.querySelectorAll(".qde-svg-container svg");for(const e of i)try{const t=await l(e),n=await new Promise(e=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.readAsDataURL(t)}),r=document.createElement("img");r.src=n;let o,a;e.getAttribute("width")&&e.getAttribute("height")?(o=parseFloat(e.getAttribute("width"))||e.viewBox&&e.viewBox.baseVal.width||e.clientWidth||400,a=parseFloat(e.getAttribute("height"))||e.viewBox&&e.viewBox.baseVal.height||e.clientHeight||300):(o=e.clientWidth||e.viewBox&&e.viewBox.baseVal.width||parseFloat(e.getAttribute("width"))||400,a=e.clientHeight||e.viewBox&&e.viewBox.baseVal.height||parseFloat(e.getAttribute("height"))||300),r.width=o,r.height=a,r.setAttribute("width",o.toString()),r.setAttribute("height",a.toString()),r.style.width=o+"px",r.style.height=a+"px",r.style.maxWidth="none",r.style.maxHeight="none",r.setAttribute("v:shapes","image"+Math.random().toString(36).substr(2,9)),r.alt="SVG Image",e.parentNode.replaceChild(r,e)}catch(e){console.warn("Failed to convert SVG to image:",e)}const s=Array.from(t.querySelectorAll(".qde-math-container"));for(const e of s)try{const t=e.querySelector("svg");if(t){const n=(new XMLSerializer).serializeToString(t),r=new Blob([n],{type:"image/svg+xml;charset=utf-8"}),o=URL.createObjectURL(r),a=new Image,i=await new Promise((e,n)=>{a.onload=function(){const n=document.createElement("canvas");let r,i;try{r=t.width.baseVal.value,i=t.height.baseVal.value}catch(e){t.viewBox&&t.viewBox.baseVal?(r=t.viewBox.baseVal.width,i=t.viewBox.baseVal.height):(r=a.naturalWidth||a.width||200,i=a.naturalHeight||a.height||50)}let s=.1;const l=r*s,d=i*s;if(l>300||d>100){const e=300/l,t=100/d;s*=Math.min(e,t)}r*=s,i*=s,n.width=r,n.height=i;const c=n.getContext("2d");c.fillStyle="#FFFFFF",c.fillRect(0,0,n.width,n.height),c.drawImage(a,0,0,n.width,n.height),URL.revokeObjectURL(o),e(n.toDataURL("image/png"))},a.onerror=()=>{URL.revokeObjectURL(o),n(new Error("Failed to load SVG image"))},a.src=o}),s=document.createElement("img");s.src=i,s.style.verticalAlign="middle",s.style.margin="0.5em",s.alt="Math equation",s.setAttribute("v:shapes","image"+Math.random().toString(36).substr(2,9)),e.parentNode.replaceChild(s,e)}else{const t=e.querySelector(".katex");t&&(t.style.fontSize="1.21em",t.style.textAlign="center",t.style.margin="0.5em",t.style.display="inline-block",t.querySelectorAll("*").forEach(e=>{const t=window.getComputedStyle(e);t.fontFamily&&(e.style.fontFamily=t.fontFamily),t.fontSize&&(e.style.fontSize=t.fontSize),t.fontStyle&&(e.style.fontStyle=t.fontStyle),t.fontWeight&&(e.style.fontWeight=t.fontWeight)}))}}catch(e){console.error("Failed to convert math element:",e)}const d=`\n            <html xmlns:v="urn:schemas-microsoft-com:vml"\n                  xmlns:o="urn:schemas-microsoft-com:office:office"\n                  xmlns:w="urn:schemas-microsoft-com:office:word">\n              <head>\n                <meta charset="utf-8">\n                <style>\n                  /* Table styling */\n                  table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }\n                  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }\n                  th { background-color: #f0f0f0; font-weight: bold; }\n                  \n                  /* Code block styling */\n                  pre { background-color: #f4f4f4; padding: 1em; border-radius: 4px; overflow-x: auto; }\n                  code { font-family: monospace; background-color: #f4f4f4; padding: 0.2em 0.4em; border-radius: 3px; }\n                  \n                  /* Image handling */\n                  img { display: block; max-width: 100%; height: auto; margin: 0.5em 0; }\n                  \n                  /* Blockquote */\n                  blockquote { border-left: 4px solid #ddd; margin-left: 0; padding-left: 1em; color: #666; }\n                </style>\n              </head>\n              <body>\n                ${t.innerHTML}\n              </body>\n            </html>`,c=t.textContent||t.innerText||"";if("macos"===function(){const e=navigator.platform?.toLowerCase()||"",t=navigator.userAgent?.toLowerCase()||"";return e.includes("mac")||t.includes("mac")?"macos":t.includes("windows")?"windows":t.includes("linux")?"linux":"unknown"}())try{return await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([d],{type:"text/html"}),"text/plain":new Blob([c],{type:"text/plain"})})]),{success:!0,html:d,text:c}}catch(e){if(console.warn("Modern clipboard API failed, trying Safari fallback:",e),function(e){let t,n;try{t=document.createElement("textarea"),t.setAttribute("readonly",!0),t.setAttribute("contenteditable",!0),t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="1px",t.style.height="1px",t.style.padding="0",t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.focus(),t.select();const r=document.createRange();r.selectNodeContents(t);const o=window.getSelection();o.removeAllRanges(),o.addRange(r),t.setSelectionRange(0,t.value.length),n=document.execCommand("copy")}catch(e){console.error("Fallback copy failed:",e),n=!1}finally{t&&t.parentNode&&document.body.removeChild(t)}return n}(d))return{success:!0,html:d,text:c};throw new Error("Fallback copy failed")}else{const e=document.createElement("div");e.style.position="fixed",e.style.left="-9999px",e.style.top="0",e.innerHTML=d,document.body.appendChild(e);try{return await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([d],{type:"text/html"}),"text/plain":new Blob([c],{type:"text/plain"})})]),{success:!0,html:d,text:c}}catch(t){console.warn("Modern clipboard API failed, trying execCommand fallback:",t);const n=window.getSelection(),r=document.createRange();r.selectNodeContents(e),n.removeAllRanges(),n.addRange(r);if(!document.execCommand("copy"))throw new Error("Fallback copy failed");return{success:!0,html:d,text:c}}finally{e&&e.parentNode&&document.body.removeChild(e)}}}catch(e){throw console.error("Failed to copy rendered content:",e),e}}
/**
 * Quikdown Editor - A drop-in markdown editor control
 * @version 1.0.5
 * @license BSD-2-Clause
 */o.emitStyles=function(e="quikdown-",t="light"){const n=r,o={"#f4f4f4":"#2a2a2a","#f0f0f0":"#2a2a2a","#f2f2f2":"#2a2a2a","#ddd":"#3a3a3a","#06c":"#6db3f2",_textColor:"#e0e0e0"},a={_textColor:"#333"};let i="";for(const[r,s]of Object.entries(n)){let n=s;if("dark"===t&&o){for(const[e,t]of Object.entries(o))e.startsWith("_")||(n=n.replace(new RegExp(e,"g"),t));["h1","h2","h3","h4","h5","h6","td","li","blockquote"].includes(r)&&(n+=`;color:${o._textColor}`)}else if("light"===t&&a){["h1","h2","h3","h4","h5","h6","td","li","blockquote"].includes(r)&&(n+=`;color:${a._textColor}`)}i+=`.${e}${r} { ${n} }\n`}return i},o.configure=function(e){return function(t){return o(t,e)}},o.version="1.1.1","undefined"!=typeof module&&module.exports&&(module.exports=o),"undefined"!=typeof window&&(window.quikdown=o),Object.keys(o).forEach(e=>{s[e]=o[e]}),s.toMarkdown=function(e,t={}){let n;if("string"==typeof e)n=document.createElement("div"),n.innerHTML=e;else{if(!(e instanceof Element))return"";n=e}function r(e,n={}){if(e.nodeType===Node.TEXT_NODE)return e.textContent;if(e.nodeType!==Node.ELEMENT_NODE)return"";const a=e.tagName.toLowerCase(),i=e.getAttribute("data-qd");let s="";for(let t of e.childNodes)s+=r(t,{parentTag:a,...n});switch(a){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":const n=parseInt(a[1]);return`${i||"#".repeat(n)} ${s.trim()}\n\n`;case"strong":case"b":if(!s)return"";const r=i||"**";return`${r}${s}${r}`;case"em":case"i":if(!s)return"";const l=i||"*";return`${l}${s}${l}`;case"del":case"s":case"strike":if(!s)return"";const d=i||"~~";return`${d}${s}${d}`;case"code":if(!s)return"";const c=i||"`";return`${c}${s}${c}`;case"pre":const h=e.getAttribute("data-qd-fence")||i||"```",u=e.getAttribute("data-qd-lang")||"";if(t.fence_plugin&&t.fence_plugin.reverse&&u)try{const n=t.fence_plugin.reverse(e);if(n&&n.content){const e=n.fence||h;return`${e}${n.lang||u}\n${n.content}\n${e}\n\n`}}catch(e){console.warn("Fence reverse handler error:",e)}const p=e.getAttribute("data-qd-source");if(p)return`${h}${u}\n${p}\n${h}\n\n`;const m=e.querySelector("code");return`${h}${u}\n${(m?m.textContent:s).trimEnd()}\n${h}\n\n`;case"blockquote":const g=i||">";return s.trim().split("\n").map(e=>`${g} ${e}`).join("\n")+"\n\n";case"hr":return`${i||"---"}\n\n`;case"br":return`${i||"  "}\n`;case"a":const f=e.getAttribute("data-qd-text")||s.trim(),b=e.getAttribute("href")||"";return f!==b||i?`[${f}](${b})`:`<${b}>`;case"img":return`${i||"!"}[${e.getAttribute("data-qd-alt")||e.getAttribute("alt")||""}](${e.getAttribute("data-qd-src")||e.getAttribute("src")||""})`;case"ul":case"ol":return o(e,"ol"===a)+"\n";case"li":case"span":default:return s;case"table":return function(e){let t="";const n=e.getAttribute("data-qd-align"),r=n?n.split(","):[],o=e.querySelector("thead");if(o){const e=o.querySelector("tr");if(e){const n=[];for(let t of e.querySelectorAll("th"))n.push(t.textContent.trim());t+="| "+n.join(" | ")+" |\n";t+="| "+n.map((e,t)=>{const n=r[t]||"left";return"center"===n?":---:":"right"===n?"---:":"---"}).join(" | ")+" |\n"}}const a=e.querySelector("tbody");if(a)for(let e of a.querySelectorAll("tr")){const n=[];for(let t of e.querySelectorAll("td"))n.push(t.textContent.trim());n.length>0&&(t+="| "+n.join(" | ")+" |\n")}return t.trim()}(e)+"\n\n";case"p":if(s.trim()){const e=s.split("\n");let t=s.trim();if(e.length>1){let n=0;for(let t=e.length-1;t>=0&&""===e[t].trim();t--)n++;if(n>0)return t+="\n ",t+"\n"}return t+"\n\n"}return"";case"div":const y=e.getAttribute("data-qd-lang"),w=e.getAttribute("data-qd-fence");if(y&&t.fence_plugin&&t.fence_plugin.reverse)try{const n=t.fence_plugin.reverse(e);if(n&&n.content){const e=n.fence||w||"```";return`${e}${n.lang||y}\n${n.content}\n${e}\n\n`}}catch(e){console.warn("Fence reverse handler error:",e)}const q=e.getAttribute("data-qd-source");if(q&&w)return`${w}${y||""}\n${q}\n${w}\n\n`;if(e.classList&&e.classList.contains("mermaid-container")){const t=e.getAttribute("data-qd-fence")||"```",n=e.getAttribute("data-qd-lang")||"mermaid",r=e.getAttribute("data-qd-source");if(r){const e=document.createElement("textarea");e.innerHTML=r;return`${t}${n}\n${e.value}\n${t}\n\n`}const o=e.querySelector("pre.mermaid");if(o){const e=o.getAttribute("data-qd-source");if(e){const r=document.createElement("textarea");r.innerHTML=e;return`${t}${n}\n${r.value}\n${t}\n\n`}}const a=e.querySelector(".mermaid-source");if(a){const e=document.createElement("div");e.innerHTML=a.innerHTML;return`${t}${n}\n${e.textContent}\n${t}\n\n`}const i=e.querySelector(".mermaid");if(i&&i.textContent.includes("graph"))return`${t}${n}\n${i.textContent.trim()}\n${t}\n\n`}if(e.classList&&e.classList.contains("mermaid")){const t=e.getAttribute("data-qd-fence")||"```";return`${t}${e.getAttribute("data-qd-lang")||"mermaid"}\n${e.textContent.trim()}\n${t}\n\n`}return s}}function o(e,t,n=0){let a="",i=1;const s="  ".repeat(n);for(let l of e.children){if("LI"!==l.tagName)continue;let e=l.getAttribute("data-qd")||(t?`${i}.`:"-");const d=l.querySelector('input[type="checkbox"]');if(d){const t=d.checked?"x":" ";e="-";let n="";for(let e of l.childNodes)e.nodeType===Node.TEXT_NODE?n+=e.textContent:e.tagName&&"INPUT"!==e.tagName&&(n+=r(e));a+=`${s}${e} [${t}] ${n.trim()}\n`}else{let t="";for(let e of l.childNodes)"UL"===e.tagName||"OL"===e.tagName?t+=o(e,"OL"===e.tagName,n+1):t+=r(e);a+=`${s}${e} ${t.trim()}\n`}i++}return a}let a=r(n);return a=a.replace(/\n{3,}/g,"\n\n"),a=a.trim(),a},s.configure=function(e){return function(t){return s(t,e)}},"undefined"!=typeof module&&module.exports&&(module.exports=s),"undefined"!=typeof window&&(window.quikdown_bd=s);const c={mode:"split",showToolbar:!0,showRemoveHR:!1,theme:"auto",lazy_linefeeds:!1,inline_styles:!1,debounceDelay:20,placeholder:"Start typing markdown...",plugins:{highlightjs:!1,mermaid:!1},customFences:{},enableComplexFences:!0};class h{constructor(e,t={}){if(this.container="string"==typeof e?document.querySelector(e):e,!this.container)throw new Error("QuikdownEditor: Invalid container");this.options={...c,...t},this._markdown="",this._html="",this.currentMode=this.options.mode,this.updateTimer=null,this.initPromise=this.init()}async init(){await this.loadPlugins(),this.buildUI(),this.attachEvents(),this.applyTheme(),this.setMode(this.currentMode),this.options.initialContent&&this.setMarkdown(this.options.initialContent)}buildUI(){this.container.innerHTML="",this.container.classList.add("qde-container"),this.options.showToolbar&&(this.toolbar=this.createToolbar(),this.container.appendChild(this.toolbar)),this.editorArea=document.createElement("div"),this.editorArea.className="qde-editor",this.sourcePanel=document.createElement("div"),this.sourcePanel.className="qde-source",this.sourceTextarea=document.createElement("textarea"),this.sourceTextarea.className="qde-textarea",this.sourceTextarea.placeholder=this.options.placeholder,this.sourcePanel.appendChild(this.sourceTextarea),this.previewPanel=document.createElement("div"),this.previewPanel.className="qde-preview",this.previewPanel.contentEditable=!0,this.editorArea.appendChild(this.sourcePanel),this.editorArea.appendChild(this.previewPanel),this.container.appendChild(this.editorArea),this.injectStyles()}createToolbar(){const e=document.createElement("div");e.className="qde-toolbar";const t={source:"Source",split:"Split",preview:"Rendered"};["source","split","preview"].forEach(n=>{const r=document.createElement("button");r.className="qde-btn",r.dataset.mode=n,r.textContent=t[n],r.title=`Switch to ${t[n]} view`,e.appendChild(r)});const n=document.createElement("span");n.className="qde-spacer",e.appendChild(n);if([{action:"copy-markdown",text:"Copy MD",title:"Copy markdown to clipboard"},{action:"copy-html",text:"Copy HTML",title:"Copy HTML to clipboard"},{action:"copy-rendered",text:"Copy Rendered",title:"Copy rich text to clipboard"}].forEach(({action:t,text:n,title:r})=>{const o=document.createElement("button");o.className="qde-btn",o.dataset.action=t,o.textContent=n,o.title=r,e.appendChild(o)}),this.options.showRemoveHR){const t=document.createElement("button");t.className="qde-btn",t.dataset.action="remove-hr",t.textContent="Remove HR",t.title="Remove all horizontal rules (---) from markdown",e.appendChild(t)}return e}injectStyles(){if(document.getElementById("qde-styles"))return;const e=document.createElement("style");e.id="qde-styles",e.textContent='\n            .qde-container {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n                border: 1px solid #ddd;\n                border-radius: 4px;\n                overflow: hidden;\n                background: white;\n            }\n            \n            .qde-toolbar {\n                display: flex;\n                align-items: center;\n                padding: 8px;\n                background: #f5f5f5;\n                border-bottom: 1px solid #ddd;\n                gap: 4px;\n            }\n            \n            .qde-btn {\n                padding: 6px 12px;\n                border: 1px solid #ccc;\n                background: white;\n                border-radius: 3px;\n                cursor: pointer;\n                font-size: 14px;\n                transition: all 0.2s;\n            }\n            \n            .qde-btn:hover {\n                background: #e9e9e9;\n                border-color: #999;\n            }\n            \n            .qde-btn.active {\n                background: #007bff;\n                color: white;\n                border-color: #0056b3;\n            }\n            \n            .qde-spacer {\n                flex: 1;\n            }\n            \n            .qde-editor {\n                display: flex;\n                flex: 1;\n                overflow: hidden;\n            }\n            \n            .qde-source, .qde-preview {\n                flex: 1;\n                overflow: auto;\n                padding: 16px;\n            }\n            \n            .qde-source {\n                border-right: 1px solid #ddd;\n            }\n            \n            .qde-textarea {\n                width: 100%;\n                height: 100%;\n                border: none;\n                outline: none;\n                resize: none;\n                font-family: \'Monaco\', \'Courier New\', monospace;\n                font-size: 14px;\n                line-height: 1.5;\n            }\n            \n            .qde-preview {\n                font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n                font-size: 16px;\n                line-height: 1.6;\n                outline: none;\n                cursor: text;  /* Standard text cursor */\n            }\n            \n            /* Fence-specific styles */\n            .qde-svg-container {\n                max-width: 100%;\n                overflow: auto;\n            }\n            \n            .qde-svg-container svg {\n                max-width: 100%;\n                height: auto;\n            }\n            \n            .qde-html-container {\n                /* HTML containers inherit background */\n                margin: 12px 0;\n            }\n            \n            .qde-math-container {\n                text-align: center;\n                margin: 16px 0;\n                overflow-x: auto;\n            }\n            \n            /* All tables in preview (both regular markdown and CSV) */\n            .qde-preview table {\n                width: 100%;\n                border-collapse: collapse;\n                margin: 12px 0;\n                font-size: 14px;\n            }\n            \n            .qde-preview table th,\n            .qde-preview table td {\n                border: 1px solid #ddd;\n                padding: 8px;\n            }\n            \n            /* Support for alignment classes from quikdown */\n            .qde-preview .quikdown-left { text-align: left; }\n            .qde-preview .quikdown-center { text-align: center; }\n            .qde-preview .quikdown-right { text-align: right; }\n            \n            .qde-preview table th {\n                background: #f5f5f5;\n                font-weight: bold;\n            }\n            \n            .qde-preview table tr:nth-child(even) {\n                background: #f9f9f9;\n            }\n            \n            /* Specific to CSV-generated tables */\n            .qde-data-table {\n                /* Can add specific CSV table styles here if needed */\n            }\n            \n            .qde-json {\n                /* Let highlight.js handle styling */\n                overflow-x: auto;\n            }\n            \n            .qde-error {\n                background: #fee;\n                border: 1px solid #fcc;\n                color: #c00;\n                padding: 8px;\n                border-radius: 4px;\n                font-family: monospace;\n                font-size: 12px;\n            }\n            \n            /* Read-only complex fence blocks in preview */\n            .qde-preview [contenteditable="false"] {\n                cursor: auto;  /* Use automatic cursor (arrow for non-text) */\n                user-select: text;\n                position: relative;\n            }\n            \n            /* Ensure proper cursor for editable text elements */\n            .qde-preview p,\n            .qde-preview h1,\n            .qde-preview h2,\n            .qde-preview h3,\n            .qde-preview h4,\n            .qde-preview h5,\n            .qde-preview h6,\n            .qde-preview li,\n            .qde-preview td,\n            .qde-preview th,\n            .qde-preview blockquote,\n            .qde-preview pre[contenteditable="true"],\n            .qde-preview code[contenteditable="true"] {\n                cursor: text;\n            }\n            \n            \n            /* Non-editable complex renderers */\n            .qde-preview .qde-svg-container[contenteditable="false"],\n            .qde-preview .qde-html-container[contenteditable="false"],\n            .qde-preview .qde-math-container[contenteditable="false"],\n            .qde-preview .mermaid[contenteditable="false"] {\n                opacity: 0.98;\n            }\n            \n            /* Subtle hover effect for read-only blocks */\n            .qde-preview [contenteditable="false"]:hover::after {\n                content: "Read-only";\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                font-size: 10px;\n                color: #999;\n                background: rgba(255, 255, 255, 0.9);\n                padding: 2px 4px;\n                border-radius: 2px;\n                pointer-events: none;\n            }\n            \n            /* Fix list padding in preview */\n            .qde-preview ul,\n            .qde-preview ol {\n                padding-left: 2em;\n                margin: 0.5em 0;\n            }\n            \n            .qde-preview li {\n                margin: 0.25em 0;\n            }\n            \n            /* Mode-specific visibility */\n            .qde-mode-source .qde-preview { display: none; }\n            .qde-mode-source .qde-source { border-right: none; }\n            .qde-mode-preview .qde-source { display: none; }\n            .qde-mode-split .qde-source,\n            .qde-mode-split .qde-preview { display: block; }\n            \n            /* Dark theme */\n            .qde-dark {\n                background: #1e1e1e;\n                color: #e0e0e0;\n            }\n            \n            .qde-dark .qde-toolbar {\n                background: #2d2d2d;\n                border-color: #444;\n            }\n            \n            .qde-dark .qde-btn {\n                background: #3a3a3a;\n                color: #e0e0e0;\n                border-color: #555;\n            }\n            \n            .qde-dark .qde-btn:hover {\n                background: #4a4a4a;\n            }\n            \n            .qde-dark .qde-source {\n                border-color: #444;\n            }\n            \n            .qde-dark .qde-textarea {\n                background: #1e1e1e;\n                color: #e0e0e0;\n            }\n            \n            .qde-dark .qde-preview {\n                background: #1e1e1e;\n                color: #e0e0e0;\n            }\n            \n            /* Dark mode table styles */\n            .qde-dark .qde-preview table th,\n            .qde-dark .qde-preview table td {\n                border-color: #3a3a3a;\n            }\n            \n            .qde-dark .qde-preview table th {\n                background: #2d2d2d;\n            }\n            \n            .qde-dark .qde-preview table tr:nth-child(even) {\n                background: #252525;\n            }\n            \n            /* Mobile responsive */\n            @media (max-width: 768px) {\n                .qde-mode-split .qde-editor {\n                    flex-direction: column;\n                }\n                \n                .qde-mode-split .qde-source {\n                    border-right: none;\n                    border-bottom: 1px solid #ddd;\n                }\n            }\n        ',document.head.appendChild(e)}attachEvents(){this.sourceTextarea.addEventListener("input",()=>{this.handleSourceInput()}),this.previewPanel.addEventListener("input",()=>{this.handlePreviewInput()}),this.toolbar&&this.toolbar.addEventListener("click",e=>{const t=e.target.closest(".qde-btn");t&&(t.dataset.mode?this.setMode(t.dataset.mode):t.dataset.action&&this.handleAction(t.dataset.action))}),document.addEventListener("keydown",e=>{if(e.ctrlKey||e.metaKey)switch(e.key){case"1":e.preventDefault(),this.setMode("source");break;case"2":e.preventDefault(),this.setMode("split");break;case"3":e.preventDefault(),this.setMode("preview")}})}handleSourceInput(){clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.updateFromMarkdown(this.sourceTextarea.value)},this.options.debounceDelay)}handlePreviewInput(){clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.updateFromHTML()},this.options.debounceDelay)}updateFromMarkdown(e){this._markdown=e||"",this._markdown.trim()?(this._html=s(e,{fence_plugin:this.createFencePlugin(),lazy_linefeeds:this.options.lazy_linefeeds,inline_styles:this.options.inline_styles}),"source"!==this.currentMode&&(this.previewPanel.innerHTML=this._html,this.makeFencesNonEditable())):(this._html="","source"!==this.currentMode&&(this.previewPanel.innerHTML='<div style="color: #999; font-style: italic; padding: 16px;">Start typing markdown in the source panel...</div>')),this.options.onChange&&this.options.onChange(this._markdown,this._html)}updateFromHTML(){const e=this.previewPanel.cloneNode(!0);this.preprocessSpecialElements(e),this._html=this.previewPanel.innerHTML,this._markdown=s.toMarkdown(e,{fence_plugin:this.createFencePlugin()}),"preview"!==this.currentMode&&(this.sourceTextarea.value=this._markdown),this.options.onChange&&this.options.onChange(this._markdown,this._html)}preprocessSpecialElements(e){if(!e)return;e.querySelectorAll('[contenteditable="false"][data-qd-source]').forEach(e=>{const t=e.getAttribute("data-qd-source"),n=e.getAttribute("data-qd-fence")||"```",r=e.getAttribute("data-qd-lang")||"",o=document.createElement("pre");o.setAttribute("data-qd-fence",n),r&&o.setAttribute("data-qd-lang",r);const a=document.createElement("code");a.textContent=t,o.appendChild(a),e.parentNode.replaceChild(o,e)});e.querySelectorAll("table.qde-csv-table[data-qd-lang]").forEach(e=>{const t=e.getAttribute("data-qd-lang");if(!t||!["csv","psv","tsv"].includes(t))return;const n="csv"===t?",":"psv"===t?"|":"\t";let r="";const o=[];e.querySelectorAll("thead th").forEach(e=>{const t=e.textContent.trim(),r=t.includes(n)||t.includes('"')||t.includes("\n");o.push(r?`"${t.replace(/"/g,'""')}"`:t)}),r+=o.join(n)+"\n";e.querySelectorAll("tbody tr").forEach(e=>{const t=[];e.querySelectorAll("td").forEach(e=>{const r=e.textContent.trim(),o=r.includes(n)||r.includes('"')||r.includes("\n");t.push(o?`"${r.replace(/"/g,'""')}"`:r)}),r+=t.join(n)+"\n"});const a=document.createElement("pre");a.setAttribute("data-qd-fence","```"),a.setAttribute("data-qd-lang",t);const i=document.createElement("code");i.textContent=r.trim(),a.appendChild(i),e.parentNode.replaceChild(a,e)})}createFencePlugin(){return{render:(e,t)=>{if(this.options.customFences&&this.options.customFences[t])try{return this.options.customFences[t](e,t)}catch(n){return console.error(`Custom fence plugin error for ${t}:`,n),`<pre><code class="language-${t}">${this.escapeHtml(e)}</code></pre>`}if(!!this.options.enableComplexFences)switch(t){case"svg":return this.renderSVG(e);case"html":return this.renderHTML(e);case"math":case"katex":case"tex":case"latex":return this.renderMath(e,t);case"csv":case"psv":case"tsv":return this.renderTable(e,t);case"json":case"json5":return this.renderJSON(e,t);case"mermaid":if(window.mermaid)return this.renderMermaid(e);break;case"geojson":return this.renderGeoJSON(e);case"stl":return this.renderSTL(e)}if(window.hljs&&t&&hljs.getLanguage(t)){return`<pre data-qd-fence="\`\`\`" data-qd-lang="${t}"><code class="hljs language-${t}">${hljs.highlight(e,{language:t}).value}</code></pre>`}},reverse:e=>{const t=e.getAttribute("data-qd-lang")||"";let n="";if(e.querySelector("code.hljs")){const t=e.querySelector("code.hljs");n=t.textContent||t.innerText||""}else if(e.querySelector("code")){const t=e.querySelector("code");n=t.textContent||t.innerText||""}else n=e.textContent||e.innerText||"";return{content:n,lang:t,fence:"```"}}}}renderSVG(e){try{const t=(new DOMParser).parseFromString(e,"image/svg+xml");if(t.querySelector("parsererror"))throw new Error("Invalid SVG");const n=t.documentElement;n.querySelectorAll("script").forEach(e=>e.remove());const r=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let o;for(;o=r.nextNode();)for(let e=o.attributes.length-1;e>=0;e--){const t=o.attributes[e];(t.name.startsWith("on")||t.value.includes("javascript:"))&&o.removeAttribute(t.name)}const a=document.createElement("div");return a.className="qde-svg-container",a.contentEditable="false",a.setAttribute("data-qd-fence","```"),a.setAttribute("data-qd-lang","svg"),a.setAttribute("data-qd-source",e),a.innerHTML=(new XMLSerializer).serializeToString(n),a.outerHTML}catch(e){const t=document.createElement("pre");return t.className="qde-error",t.contentEditable="false",t.setAttribute("data-qd-fence","```"),t.setAttribute("data-qd-lang","svg"),t.textContent=`Invalid SVG: ${e.message}`,t.outerHTML}}renderHTML(e){const t=`html-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;if(window.DOMPurify){const t=DOMPurify.sanitize(e),n=document.createElement("div");return n.className="qde-html-container",n.contentEditable="false",n.setAttribute("data-qd-fence","```"),n.setAttribute("data-qd-lang","html"),n.setAttribute("data-qd-source",e),n.innerHTML=t,n.outerHTML}this.lazyLoadLibrary("DOMPurify",()=>window.DOMPurify,"https://unpkg.com/dompurify/dist/purify.min.js").then(n=>{if(n){const n=document.getElementById(t);if(n){const t=DOMPurify.sanitize(e);n.innerHTML=t,n.setAttribute("data-qd-source",e),n.setAttribute("data-qd-fence","```"),n.setAttribute("data-qd-lang","html")}}});const n=document.createElement("div");n.id=t,n.className="qde-html-container",n.contentEditable="false",n.setAttribute("data-qd-fence","```"),n.setAttribute("data-qd-lang","html"),n.setAttribute("data-qd-source",e);const r=document.createElement("pre");return r.textContent=e,n.appendChild(r),n.outerHTML}renderMath(e,t){const n=`math-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;if(window.katex)try{const n=katex.renderToString(e,{displayMode:!0,throwOnError:!1}),r=document.createElement("div");return r.className="qde-math-container",r.contentEditable="false",r.setAttribute("data-qd-fence","```"),r.setAttribute("data-qd-lang",t),r.setAttribute("data-qd-source",e),r.innerHTML=n,r.outerHTML}catch(n){const r=document.createElement("pre");return r.className="qde-error",r.contentEditable="false",r.setAttribute("data-qd-fence","```"),r.setAttribute("data-qd-lang",t),r.setAttribute("data-qd-source",e),r.textContent=`Math error: ${n.message}`,r.outerHTML}this.lazyLoadLibrary("KaTeX",()=>window.katex,"https://unpkg.com/katex/dist/katex.min.js","https://unpkg.com/katex/dist/katex.min.css").then(r=>{if(r){const r=document.getElementById(n);if(r)try{katex.render(e,r,{displayMode:!0,throwOnError:!1}),r.setAttribute("data-qd-source",e),r.setAttribute("data-qd-fence","```"),r.setAttribute("data-qd-lang",t)}catch(e){r.innerHTML=`<pre class="qde-error">Math error: ${this.escapeHtml(e.message)}</pre>`}}});const r=document.createElement("div");r.id=n,r.className="qde-math-container",r.contentEditable="false",r.setAttribute("data-qd-fence","```"),r.setAttribute("data-qd-lang",t),r.setAttribute("data-qd-source",e);const o=document.createElement("pre");return o.textContent=e,r.appendChild(o),r.outerHTML}renderTable(e,t){const n=this.escapeHtml(e);try{const r="csv"===t?",":"psv"===t?"|":"\t",o=e.trim().split("\n");if(0===o.length)return`<pre data-qd-fence="\`\`\`" data-qd-lang="${t}" data-qd-source="${n}">${n}</pre>`;let a=`<table class="qde-data-table qde-csv-table" data-qd-fence="\`\`\`" data-qd-lang="${t}">`;const i=this.parseCSVLine(o[0],r);if(a+="<thead><tr>",i.forEach(e=>{a+=`<th>${this.escapeHtml(e.trim())}</th>`}),a+="</tr></thead>",o.length>1){a+="<tbody>";for(let e=1;e<o.length;e++){const t=this.parseCSVLine(o[e],r);a+="<tr>",t.forEach(e=>{a+=`<td>${this.escapeHtml(e.trim())}</td>`}),a+="</tr>"}a+="</tbody>"}return a+="</table>",a}catch(e){return`<pre data-qd-fence="\`\`\`" data-qd-lang="${t}" data-qd-source="${n}">${n}</pre>`}}parseCSVLine(e,t){const n=[];let r="",o=!1;for(let a=0;a<e.length;a++){const i=e[a],s=e[a+1];'"'===i?o&&'"'===s?(r+='"',a++):o=!o:i!==t||o?r+=i:(n.push(r),r="")}return n.push(r),n}renderJSON(e,t){if(window.hljs&&hljs.getLanguage("json"))try{let n=e;try{const t=JSON.parse(e);n=JSON.stringify(t,null,2)}catch(e){}return`<pre class="qde-json" data-qd-fence="\`\`\`" data-qd-lang="${t}"><code class="hljs language-json">${hljs.highlight(n,{language:"json"}).value}</code></pre>`}catch(e){}return`<pre class="qde-json" data-qd-fence="\`\`\`" data-qd-lang="${t}">${this.escapeHtml(e)}</pre>`}renderGeoJSON(e){const t=`geojson-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n=()=>{const n=document.getElementById(t);if(n&&window.L)try{const t=JSON.parse(e),r=L.map(n).setView([0,0],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(r);const o=L.geoJSON(t).addTo(r);r.fitBounds(o.getBounds())}catch(e){n.innerHTML=`<pre class="qde-error">GeoJSON error: ${this.escapeHtml(e.message)}</pre>`}};window.L?setTimeout(n,0):(window._qde_leaflet_loading||(window._qde_leaflet_loading=this.lazyLoadLibrary("Leaflet",()=>window.L,"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css").catch(e=>(console.warn("Failed to load Leaflet:",e),window._qde_leaflet_loading=null,!1))),window._qde_leaflet_loading.then(e=>{if(e)n();else{const e=document.getElementById(t);e&&(e.innerHTML='<div style="padding: 20px; text-align: center; color: #666;">Failed to load map library</div>')}}).catch(()=>{}));const r=document.createElement("div");return r.id=t,r.style.cssText="height: 400px; background: #f0f0f0;",r.contentEditable="false",r.setAttribute("data-qd-fence","```"),r.setAttribute("data-qd-lang","geojson"),r.setAttribute("data-qd-source",e),r.textContent="Loading map...",r.outerHTML}renderSTL(e){const t=`qde-stl-viewer-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return setTimeout(()=>{const n=document.getElementById(t);if(n)if(void 0!==window.THREE)try{const t=window.THREE,r=new t.Scene;r.background=new t.Color(15790320);const o=new t.PerspectiveCamera(75,n.clientWidth/400,.1,1e3),a=new t.WebGLRenderer({antialias:!0});a.setSize(n.clientWidth,400),n.innerHTML="",n.appendChild(a.domElement),n._threeScene=r,n._threeCamera=o,n._threeRenderer=a;const i=this.parseSTL(e),s=new t.MeshLambertMaterial({color:26367}),l=new t.Mesh(i,s);r.add(l);const d=new t.AmbientLight(4210752,.6);r.add(d);const c=new t.DirectionalLight(16777215,.8);c.position.set(1,1,1).normalize(),r.add(c);const h=(new t.Box3).setFromObject(l),u=h.getCenter(new t.Vector3),p=h.getSize(new t.Vector3),m=Math.max(p.x,p.y,p.z);o.position.set(u.x+m,u.y+m,u.z+m),o.lookAt(u);const g=()=>{requestAnimationFrame(g),l.rotation.y+=.01,a.render(r,o)};g()}catch(e){console.error("STL rendering error:",e),n.innerHTML=`<pre class="qde-error">STL error: ${this.escapeHtml(e.message)}</pre>`}else n.innerHTML='<div style="padding: 20px; text-align: center; color: #666;">Three.js library not loaded. Add &lt;script src="https://unpkg.com/three@0.147.0/build/three.min.js"&gt;&lt;/script&gt; to your HTML.</div>'},0),`<div id="${t}" class="qde-stl-container" data-stl-id="${t}" data-qd-fence="\`\`\`" data-qd-lang="stl" data-qd-source="${this.escapeHtml(e)}" contenteditable="false" style="height: 400px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">Loading 3D model...</div>`}parseSTL(e){const t=window.THREE,n=new t.BufferGeometry,r=[],o=[],a=e.split("\n");let i=null;for(let e of a)if(e=e.trim(),e.startsWith("facet normal")){const t=e.split(/\s+/);i=[parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[4])]}else if(e.startsWith("vertex")){const t=e.split(/\s+/);r.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])),i&&o.push(i[0],i[1],i[2])}return n.setAttribute("position",new t.Float32BufferAttribute(r,3)),n.setAttribute("normal",new t.Float32BufferAttribute(o,3)),n}renderMermaid(e){const t=`mermaid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;setTimeout(()=>{const n=document.getElementById(t);n&&window.mermaid&&mermaid.render(t+"-svg",e).then(e=>{n.innerHTML=e.svg}).catch(e=>{n.innerHTML=`<pre>Error rendering diagram: ${e.message}</pre>`})},0);const n=document.createElement("div");return n.id=t,n.className="mermaid",n.contentEditable="false",n.setAttribute("data-qd-source",e),n.setAttribute("data-qd-fence","```"),n.setAttribute("data-qd-lang","mermaid"),n.textContent="Loading diagram...",n.outerHTML}escapeHtml(e){return(e??"").replace(/[&"'<>]/g,e=>({"&":"&amp;",'"':"&quot;","'":"&#39;","<":"&lt;",">":"&gt;"}[e]))}makeFencesNonEditable(){this.previewPanel}async loadPlugins(){const e=[];this.options.plugins.highlightjs&&!window.hljs&&e.push(this.loadScript("https://unpkg.com/@highlightjs/cdn-assets/highlight.min.js"),this.loadCSS("https://unpkg.com/@highlightjs/cdn-assets/styles/github.min.css")),this.options.plugins.mermaid&&!window.mermaid&&e.push(this.loadScript("https://unpkg.com/mermaid/dist/mermaid.min.js").then(()=>{window.mermaid&&mermaid.initialize({startOnLoad:!1})})),await Promise.all(e)}async lazyLoadLibrary(e,t,n,r=null){if(t())return!0;try{const e=[];return n&&e.push(this.loadScript(n)),r&&e.push(this.loadCSS(r)),await Promise.all(e),t()}catch(t){return console.error(`Failed to load ${e}:`,t),!1}}loadScript(e){return new Promise((t,n)=>{const r=document.createElement("script");r.src=e,r.onload=t,r.onerror=n,document.head.appendChild(r)})}loadCSS(e){return new Promise(t=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,n.onload=t,document.head.appendChild(n),setTimeout(t,1e3)})}applyTheme(){const e=this.options.theme;if("auto"===e){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;this.container.classList.toggle("qde-dark",e),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{this.container.classList.toggle("qde-dark",e.matches)})}else this.container.classList.toggle("qde-dark","dark"===e)}setLazyLinefeeds(e){this.options.lazy_linefeeds=e,this._markdown&&this.updateFromSource()}getLazyLinefeeds(){return this.options.lazy_linefeeds}setDebounceDelay(e){this.options.debounceDelay=Math.max(0,e)}getDebounceDelay(){return this.options.debounceDelay}setMode(e){["source","preview","split"].includes(e)&&(this.currentMode=e,this.container.className=`qde-container qde-mode-${e}`,this.toolbar&&this.toolbar.querySelectorAll(".qde-btn[data-mode]").forEach(t=>{t.classList.toggle("active",t.dataset.mode===e)}),this.container.classList.contains("qde-dark")&&this.container.classList.add("qde-dark"),"source"!==e&&setTimeout(()=>this.makeFencesNonEditable(),0),this.options.onModeChange&&this.options.onModeChange(e))}handleAction(e){switch(e){case"copy-markdown":this.copy("markdown");break;case"copy-html":this.copy("html");break;case"copy-rendered":this.copyRendered();break;case"remove-hr":this.removeHR()}}async copy(e){const t="markdown"===e?this._markdown:this._html;try{await navigator.clipboard.writeText(t);const n=this.toolbar.querySelector(`[data-action="copy-${e}"]`);if(n){const e=n.textContent;n.textContent="Copied!",setTimeout(()=>{n.textContent=e},1500)}}catch(e){console.error("Failed to copy:",e)}}get markdown(){return this._markdown}set markdown(e){this.setMarkdown(e)}get html(){return this._html}get mode(){return this.currentMode}async setMarkdown(e){this.initPromise&&await this.initPromise,this._markdown=e,this.sourceTextarea&&(this.sourceTextarea.value=e),this.updateFromMarkdown(e)}getMarkdown(){return this._markdown}getHTML(){return this._html}async removeHR(){const e=this._markdown.split("\n").filter(e=>{const t=e.trim();return!/^[-_*](\s*[-_*]){2,}\s*$/.test(t)}).join("\n");await this.setMarkdown(e);const t=this.toolbar?.querySelector('[data-action="remove-hr"]');if(t){const e=t.textContent;t.textContent="Removed!",setTimeout(()=>{t.textContent=e},1500)}}async copyRendered(){try{if((await d(this.previewPanel)).success){const e=this.toolbar?.querySelector('[data-action="copy-rendered"]');if(e){const t=e.textContent;e.textContent="Copied!",setTimeout(()=>{e.textContent=t},1500)}}}catch(e){console.error("Failed to copy rendered content:",e)}}destroy(){clearTimeout(this.updateTimer),this.container.innerHTML="",this.container.classList.remove("qde-container","qde-dark");if(0===document.querySelectorAll(".qde-container").length){const e=document.getElementById("qde-styles");e&&e.remove()}}}"undefined"!=typeof module&&module.exports&&(module.exports=h),"undefined"!=typeof window&&(window.QuikdownEditor=h);export{h as default};
//# sourceMappingURL=quikdown_edit.esm.min.js.map
