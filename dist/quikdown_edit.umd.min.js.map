{"version":3,"file":"quikdown_edit.umd.min.js","sources":["../src/quikdown.js","../src/quikdown_bd.js","../src/quikdown_edit_copy.js","../src/quikdown_edit.js"],"sourcesContent":["/**\n * quikdown - A minimal markdown parser optimized for chat/LLM output\n * Supports tables, code blocks, lists, and common formatting\n * @param {string} markdown - The markdown source text\n * @param {Object} options - Optional configuration object\n * @param {Function} options.fence_plugin - Custom renderer for fenced code blocks\n *                   (content, fence_string) => html string\n * @param {boolean} options.inline_styles - If true, uses inline styles instead of classes\n * @param {boolean} options.bidirectional - If true, adds data-qd attributes for source tracking\n * @param {boolean} options.lazy_linefeeds - If true, single newlines become <br> tags\n * @returns {string} - The rendered HTML\n */\n\n// Version will be injected at build time  \nconst quikdownVersion = '__QUIKDOWN_VERSION__';\n\n// Constants for reuse\nconst CLASS_PREFIX = 'quikdown-';\nconst PLACEHOLDER_CB = '§CB';\nconst PLACEHOLDER_IC = '§IC';\n\n// Escape map at module level\nconst ESC_MAP = {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'};\n\n// Single source of truth for all style definitions - optimized\nconst QUIKDOWN_STYLES = {\n    h1: 'font-size:2em;font-weight:600;margin:.67em 0;text-align:left',\n    h2: 'font-size:1.5em;font-weight:600;margin:.83em 0',\n    h3: 'font-size:1.25em;font-weight:600;margin:1em 0',\n    h4: 'font-size:1em;font-weight:600;margin:1.33em 0',\n    h5: 'font-size:.875em;font-weight:600;margin:1.67em 0',\n    h6: 'font-size:.85em;font-weight:600;margin:2em 0',\n    pre: 'background:#f4f4f4;padding:10px;border-radius:4px;overflow-x:auto;margin:1em 0',\n    code: 'background:#f0f0f0;padding:2px 4px;border-radius:3px;font-family:monospace',\n    blockquote: 'border-left:4px solid #ddd;margin-left:0;padding-left:1em',\n    table: 'border-collapse:collapse;width:100%;margin:1em 0',\n    th: 'border:1px solid #ddd;padding:8px;background-color:#f2f2f2;font-weight:bold;text-align:left',\n    td: 'border:1px solid #ddd;padding:8px;text-align:left',\n    hr: 'border:none;border-top:1px solid #ddd;margin:1em 0',\n    img: 'max-width:100%;height:auto',\n    a: 'color:#06c;text-decoration:underline',\n    strong: 'font-weight:bold',\n    em: 'font-style:italic',\n    del: 'text-decoration:line-through',\n    ul: 'margin:.5em 0;padding-left:2em',\n    ol: 'margin:.5em 0;padding-left:2em',\n    li: 'margin:.25em 0',\n    // Task list specific styles\n    'task-item': 'list-style:none',\n    'task-checkbox': 'margin-right:.5em'\n};\n\n// Factory function to create getAttr for a given context\nfunction createGetAttr(inline_styles, styles) {\n    return function(tag, additionalStyle = '') {\n        if (inline_styles) {\n            let style = styles[tag];\n            if (!style && !additionalStyle) return '';\n            \n            // Remove default text-align if we're adding a different alignment\n            if (additionalStyle && additionalStyle.includes('text-align') && style && style.includes('text-align')) {\n                style = style.replace(/text-align:[^;]+;?/, '').trim();\n                if (style && !style.endsWith(';')) style += ';';\n            }\n            \n            /* istanbul ignore next - defensive: additionalStyle without style doesn't occur with current tags */\n            const fullStyle = additionalStyle ? (style ? `${style}${additionalStyle}` : additionalStyle) : style;\n            return ` style=\"${fullStyle}\"`;\n        } else {\n            const classAttr = ` class=\"${CLASS_PREFIX}${tag}\"`;\n            // Apply inline styles for alignment even when using CSS classes\n            if (additionalStyle) {\n                return `${classAttr} style=\"${additionalStyle}\"`;\n            }\n            return classAttr;\n        }\n    };\n}\n\nfunction quikdown(markdown, options = {}) {\n    if (!markdown || typeof markdown !== 'string') {\n        return '';\n    }\n    \n    const { fence_plugin, inline_styles = false, bidirectional = false, lazy_linefeeds = false } = options;\n    const styles = QUIKDOWN_STYLES; // Use module-level styles\n    const getAttr = createGetAttr(inline_styles, styles); // Create getAttr once\n\n    // Escape HTML entities to prevent XSS\n    function escapeHtml(text) {\n        return text.replace(/[&<>\"']/g, m => ESC_MAP[m]);\n    }\n    \n    // Helper to add data-qd attributes for bidirectional support\n    const dataQd = bidirectional ? (marker) => ` data-qd=\"${escapeHtml(marker)}\"` : () => '';\n    \n    // Sanitize URLs to prevent XSS attacks\n    function sanitizeUrl(url, allowUnsafe = false) {\n        /* istanbul ignore next - defensive programming, regex ensures url is never empty */\n        if (!url) return '';\n        \n        // If unsafe URLs are explicitly allowed, return as-is\n        if (allowUnsafe) return url;\n        \n        const trimmedUrl = url.trim();\n        const lowerUrl = trimmedUrl.toLowerCase();\n        \n        // Block dangerous protocols\n        const dangerousProtocols = ['javascript:', 'vbscript:', 'data:'];\n        \n        for (const protocol of dangerousProtocols) {\n            if (lowerUrl.startsWith(protocol)) {\n                // Exception: Allow data:image/* for images\n                if (protocol === 'data:' && lowerUrl.startsWith('data:image/')) {\n                    return trimmedUrl;\n                }\n                // Return safe empty link for dangerous protocols\n                return '#';\n            }\n        }\n        \n        return trimmedUrl;\n    }\n\n    // Process the markdown in phases\n    let html = markdown;\n    \n    // Phase 1: Extract and protect code blocks and inline code\n    const codeBlocks = [];\n    const inlineCodes = [];\n    \n    // Extract fenced code blocks first (supports both ``` and ~~~)\n    // Match paired fences - ``` with ``` and ~~~ with ~~~\n    // Fence must be at start of line\n    html = html.replace(/^(```|~~~)([^\\n]*)\\n([\\s\\S]*?)^\\1$/gm, (match, fence, lang, code) => {\n        const placeholder = `${PLACEHOLDER_CB}${codeBlocks.length}§`;\n        \n        // Trim the language specification\n        const langTrimmed = lang ? lang.trim() : '';\n        \n        // If custom fence plugin is provided, use it (v1.1.0: object format required)\n        if (fence_plugin && fence_plugin.render && typeof fence_plugin.render === 'function') {\n            codeBlocks.push({\n                lang: langTrimmed,\n                code: code.trimEnd(),\n                custom: true,\n                fence: fence,\n                hasReverse: !!fence_plugin.reverse\n            });\n        } else {\n            codeBlocks.push({\n                lang: langTrimmed,\n                code: escapeHtml(code.trimEnd()),\n                custom: false,\n                fence: fence\n            });\n        }\n        return placeholder;\n    });\n    \n    // Extract inline code\n    html = html.replace(/`([^`]+)`/g, (match, code) => {\n        const placeholder = `${PLACEHOLDER_IC}${inlineCodes.length}§`;\n        inlineCodes.push(escapeHtml(code));\n        return placeholder;\n    });\n    \n    // Now escape HTML in the rest of the content\n    html = escapeHtml(html);\n    \n    // Phase 2: Process block elements\n    \n    // Process tables\n    html = processTable(html, getAttr);\n    \n    // Process headings (supports optional trailing #'s)\n    html = html.replace(/^(#{1,6})\\s+(.+?)\\s*#*$/gm, (match, hashes, content) => {\n        const level = hashes.length;\n        return `<h${level}${getAttr('h' + level)}${dataQd(hashes)}>${content}</h${level}>`;\n    });\n    \n    // Process blockquotes (must handle escaped > since we already escaped HTML)\n    html = html.replace(/^&gt;\\s+(.+)$/gm, `<blockquote${getAttr('blockquote')}>$1</blockquote>`);\n    // Merge consecutive blockquotes\n    html = html.replace(/<\\/blockquote>\\n<blockquote>/g, '\\n');\n    \n    // Process horizontal rules (allow trailing spaces)\n    html = html.replace(/^---+\\s*$/gm, `<hr${getAttr('hr')}>`);\n    \n    // Process lists\n    html = processLists(html, getAttr, inline_styles, bidirectional);\n    \n    // Phase 3: Process inline elements\n    \n    // Images (must come before links, with URL sanitization)\n    html = html.replace(/!\\[([^\\]]*)\\]\\(([^)]+)\\)/g, (match, alt, src) => {\n        const sanitizedSrc = sanitizeUrl(src, options.allow_unsafe_urls);\n        const altAttr = bidirectional && alt ? ` data-qd-alt=\"${escapeHtml(alt)}\"` : '';\n        const srcAttr = bidirectional ? ` data-qd-src=\"${escapeHtml(src)}\"` : '';\n        return `<img${getAttr('img')} src=\"${sanitizedSrc}\" alt=\"${alt}\"${altAttr}${srcAttr}${dataQd('!')}>`;\n    });\n    \n    // Links (with URL sanitization)\n    html = html.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, (match, text, href) => {\n        // Sanitize URL to prevent XSS\n        const sanitizedHref = sanitizeUrl(href, options.allow_unsafe_urls);\n        const isExternal = /^https?:\\/\\//i.test(sanitizedHref);\n        const rel = isExternal ? ' rel=\"noopener noreferrer\"' : '';\n        const textAttr = bidirectional ? ` data-qd-text=\"${escapeHtml(text)}\"` : '';\n        return `<a${getAttr('a')} href=\"${sanitizedHref}\"${rel}${textAttr}${dataQd('[')}>${text}</a>`;\n    });\n    \n    // Autolinks - convert bare URLs to clickable links\n    html = html.replace(/(^|\\s)(https?:\\/\\/[^\\s<]+)/g, (match, prefix, url) => {\n        const sanitizedUrl = sanitizeUrl(url, options.allow_unsafe_urls);\n        return `${prefix}<a${getAttr('a')} href=\"${sanitizedUrl}\" rel=\"noopener noreferrer\">${url}</a>`;\n    });\n    \n    // Process inline formatting (bold, italic, strikethrough)\n    const inlinePatterns = [\n        [/\\*\\*(.+?)\\*\\*/g, 'strong', '**'],\n        [/__(.+?)__/g, 'strong', '__'],\n        [/(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)/g, 'em', '*'],\n        [/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, 'em', '_'],\n        [/~~(.+?)~~/g, 'del', '~~']\n    ];\n    \n    inlinePatterns.forEach(([pattern, tag, marker]) => {\n        html = html.replace(pattern, `<${tag}${getAttr(tag)}${dataQd(marker)}>$1</${tag}>`);\n    });\n    \n    // Line breaks\n    if (lazy_linefeeds) {\n        // Lazy linefeeds: single newline becomes <br> (except between paragraphs and after/before block elements)\n        const blocks = [];\n        let bi = 0;\n        \n        // Protect tables and lists  \n        html = html.replace(/<(table|[uo]l)[^>]*>[\\s\\S]*?<\\/\\1>/g, m => {\n            blocks[bi] = m;\n            return `§B${bi++}§`;\n        });\n        \n        // Handle paragraphs and block elements\n        html = html.replace(/\\n\\n+/g, '§P§')\n            // After block elements\n            .replace(/(<\\/(?:h[1-6]|blockquote|pre)>)\\n/g, '$1§N§')\n            .replace(/(<(?:h[1-6]|blockquote|pre|hr)[^>]*>)\\n/g, '$1§N§')\n            // Before block elements  \n            .replace(/\\n(<(?:h[1-6]|blockquote|pre|hr)[^>]*>)/g, '§N§$1')\n            .replace(/\\n(§B\\d+§)/g, '§N§$1')\n            .replace(/(§B\\d+§)\\n/g, '$1§N§')\n            // Convert remaining newlines\n            .replace(/\\n/g, `<br${getAttr('br')}>`)\n            // Restore\n            .replace(/§N§/g, '\\n')\n            .replace(/§P§/g, '</p><p>');\n        \n        // Restore protected blocks\n        blocks.forEach((b, i) => html = html.replace(`§B${i}§`, b));\n        \n        html = '<p>' + html + '</p>';\n    } else {\n        // Standard: two spaces at end of line for line breaks\n        html = html.replace(/  $/gm, `<br${getAttr('br')}>`);\n        \n        // Paragraphs (double newlines)\n        // Don't add </p> after block elements (they're not in paragraphs)\n        html = html.replace(/\\n\\n+/g, (match, offset) => {\n            // Check if we're after a block element closing tag\n            const before = html.substring(0, offset);\n            if (before.match(/<\\/(h[1-6]|blockquote|ul|ol|table|pre|hr)>$/)) {\n                return '<p>';  // Just open a new paragraph\n            }\n            return '</p><p>';  // Normal paragraph break\n        });\n        html = '<p>' + html + '</p>';\n    }\n    \n    // Clean up empty paragraphs and unwrap block elements\n    const cleanupPatterns = [\n        [/<p><\\/p>/g, ''],\n        [/<p>(<h[1-6][^>]*>)/g, '$1'],\n        [/(<\\/h[1-6]>)<\\/p>/g, '$1'],\n        [/<p>(<blockquote[^>]*>)/g, '$1'],\n        [/(<\\/blockquote>)<\\/p>/g, '$1'],\n        [/<p>(<ul[^>]*>|<ol[^>]*>)/g, '$1'],\n        [/(<\\/ul>|<\\/ol>)<\\/p>/g, '$1'],\n        [/<p>(<hr[^>]*>)<\\/p>/g, '$1'],\n        [/<p>(<table[^>]*>)/g, '$1'],\n        [/(<\\/table>)<\\/p>/g, '$1'],\n        [/<p>(<pre[^>]*>)/g, '$1'],\n        [/(<\\/pre>)<\\/p>/g, '$1'],\n        [new RegExp(`<p>(${PLACEHOLDER_CB}\\\\d+§)<\\/p>`, 'g'), '$1']\n    ];\n    \n    cleanupPatterns.forEach(([pattern, replacement]) => {\n        html = html.replace(pattern, replacement);\n    });\n    \n    // Fix orphaned closing </p> tags after block elements\n    // When a paragraph follows a block element, ensure it has opening <p>\n    html = html.replace(/(<\\/(?:h[1-6]|blockquote|ul|ol|table|pre|hr)>)\\n([^<])/g, '$1\\n<p>$2');\n    \n    // Phase 4: Restore code blocks and inline code\n    \n    // Restore code blocks\n    codeBlocks.forEach((block, i) => {\n        let replacement;\n        \n        if (block.custom && fence_plugin && fence_plugin.render) {\n            // Use custom fence plugin (v1.1.0: object format with render function)\n            replacement = fence_plugin.render(block.code, block.lang);\n            \n            // If plugin returns undefined, fall back to default rendering\n            if (replacement === undefined) {\n                const langClass = !inline_styles && block.lang ? ` class=\"language-${block.lang}\"` : '';\n                const codeAttr = inline_styles ? getAttr('code') : langClass;\n                const langAttr = bidirectional && block.lang ? ` data-qd-lang=\"${escapeHtml(block.lang)}\"` : '';\n                const fenceAttr = bidirectional ? ` data-qd-fence=\"${escapeHtml(block.fence)}\"` : '';\n                replacement = `<pre${getAttr('pre')}${fenceAttr}${langAttr}><code${codeAttr}>${escapeHtml(block.code)}</code></pre>`;\n            } else if (bidirectional) {\n                // If bidirectional and plugin provided HTML, add data attributes for roundtrip\n                replacement = replacement.replace(/^<(\\w+)/, \n                    `<$1 data-qd-fence=\"${escapeHtml(block.fence)}\" data-qd-lang=\"${escapeHtml(block.lang)}\" data-qd-source=\"${escapeHtml(block.code)}\"`);\n            }\n        } else {\n            // Default rendering\n            const langClass = !inline_styles && block.lang ? ` class=\"language-${block.lang}\"` : '';\n            const codeAttr = inline_styles ? getAttr('code') : langClass;\n            const langAttr = bidirectional && block.lang ? ` data-qd-lang=\"${escapeHtml(block.lang)}\"` : '';\n            const fenceAttr = bidirectional ? ` data-qd-fence=\"${escapeHtml(block.fence)}\"` : '';\n            replacement = `<pre${getAttr('pre')}${fenceAttr}${langAttr}><code${codeAttr}>${block.code}</code></pre>`;\n        }\n        \n        const placeholder = `${PLACEHOLDER_CB}${i}§`;\n        html = html.replace(placeholder, replacement);\n    });\n    \n    // Restore inline code\n    inlineCodes.forEach((code, i) => {\n        const placeholder = `${PLACEHOLDER_IC}${i}§`;\n        html = html.replace(placeholder, `<code${getAttr('code')}${dataQd('`')}>${code}</code>`);\n    });\n    \n    return html.trim();\n}\n\n/**\n * Process inline markdown formatting\n */\nfunction processInlineMarkdown(text, getAttr) {\n    \n    // Process inline formatting patterns\n    const patterns = [\n        [/\\*\\*(.+?)\\*\\*/g, 'strong'],\n        [/__(.+?)__/g, 'strong'],\n        [/(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)/g, 'em'],\n        [/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, 'em'],\n        [/~~(.+?)~~/g, 'del'],\n        [/`([^`]+)`/g, 'code']\n    ];\n    \n    patterns.forEach(([pattern, tag]) => {\n        text = text.replace(pattern, `<${tag}${getAttr(tag)}>$1</${tag}>`);\n    });\n    \n    return text;\n}\n\n/**\n * Process markdown tables\n */\nfunction processTable(text, getAttr) {\n    const lines = text.split('\\n');\n    const result = [];\n    let inTable = false;\n    let tableLines = [];\n    \n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        \n        // Check if this line looks like a table row (with or without trailing |)\n        if (line.includes('|') && (line.startsWith('|') || /[^\\\\|]/.test(line))) {\n            if (!inTable) {\n                inTable = true;\n                tableLines = [];\n            }\n            tableLines.push(line);\n        } else {\n            // Not a table line\n            if (inTable) {\n                // Process the accumulated table\n                const tableHtml = buildTable(tableLines, getAttr);\n                if (tableHtml) {\n                    result.push(tableHtml);\n                } else {\n                    // Not a valid table, restore original lines\n                    result.push(...tableLines);\n                }\n                inTable = false;\n                tableLines = [];\n            }\n            result.push(lines[i]);\n        }\n    }\n    \n    // Handle table at end of text\n    if (inTable && tableLines.length > 0) {\n        const tableHtml = buildTable(tableLines, getAttr);\n        if (tableHtml) {\n            result.push(tableHtml);\n        } else {\n            result.push(...tableLines);\n        }\n    }\n    \n    return result.join('\\n');\n}\n\n/**\n * Build an HTML table from markdown table lines\n */\nfunction buildTable(lines, getAttr) {\n    \n    if (lines.length < 2) return null;\n    \n    // Check for separator line (second line should be the separator)\n    let separatorIndex = -1;\n    for (let i = 1; i < lines.length; i++) {\n        // Support separator with or without leading/trailing pipes\n        if (/^\\|?[\\s\\-:|]+\\|?$/.test(lines[i]) && lines[i].includes('-')) {\n            separatorIndex = i;\n            break;\n        }\n    }\n    \n    if (separatorIndex === -1) return null;\n    \n    const headerLines = lines.slice(0, separatorIndex);\n    const bodyLines = lines.slice(separatorIndex + 1);\n    \n    // Parse alignment from separator\n    const separator = lines[separatorIndex];\n    // Handle pipes at start/end or not\n    const separatorCells = separator.trim().replace(/^\\|/, '').replace(/\\|$/, '').split('|');\n    const alignments = separatorCells.map(cell => {\n        const trimmed = cell.trim();\n        if (trimmed.startsWith(':') && trimmed.endsWith(':')) return 'center';\n        if (trimmed.endsWith(':')) return 'right';\n        return 'left';\n    });\n    \n    let html = `<table${getAttr('table')}>\\n`;\n    \n    // Build header\n    // Note: headerLines will always have length > 0 since separatorIndex starts from 1\n    html += `<thead${getAttr('thead')}>\\n`;\n    headerLines.forEach(line => {\n            html += `<tr${getAttr('tr')}>\\n`;\n            // Handle pipes at start/end or not\n            const cells = line.trim().replace(/^\\|/, '').replace(/\\|$/, '').split('|');\n            cells.forEach((cell, i) => {\n                const alignStyle = alignments[i] && alignments[i] !== 'left' ? `text-align:${alignments[i]}` : '';\n                const processedCell = processInlineMarkdown(cell.trim(), getAttr);\n                html += `<th${getAttr('th', alignStyle)}>${processedCell}</th>\\n`;\n            });\n            html += '</tr>\\n';\n    });\n    html += '</thead>\\n';\n    \n    // Build body\n    if (bodyLines.length > 0) {\n        html += `<tbody${getAttr('tbody')}>\\n`;\n        bodyLines.forEach(line => {\n            html += `<tr${getAttr('tr')}>\\n`;\n            // Handle pipes at start/end or not\n            const cells = line.trim().replace(/^\\|/, '').replace(/\\|$/, '').split('|');\n            cells.forEach((cell, i) => {\n                const alignStyle = alignments[i] && alignments[i] !== 'left' ? `text-align:${alignments[i]}` : '';\n                const processedCell = processInlineMarkdown(cell.trim(), getAttr);\n                html += `<td${getAttr('td', alignStyle)}>${processedCell}</td>\\n`;\n            });\n            html += '</tr>\\n';\n        });\n        html += '</tbody>\\n';\n    }\n    \n    html += '</table>';\n    return html;\n}\n\n/**\n * Process markdown lists (ordered and unordered)\n */\nfunction processLists(text, getAttr, inline_styles, bidirectional) {\n    \n    const lines = text.split('\\n');\n    const result = [];\n    let listStack = []; // Track nested lists\n    \n    // Helper to escape HTML for data-qd attributes\n    const escapeHtml = (text) => text.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'})[m]);\n    const dataQd = bidirectional ? (marker) => ` data-qd=\"${escapeHtml(marker)}\"` : () => '';\n    \n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i];\n        const match = line.match(/^(\\s*)([*\\-+]|\\d+\\.)\\s+(.+)$/);\n        \n        if (match) {\n            const [, indent, marker, content] = match;\n            const level = Math.floor(indent.length / 2);\n            const isOrdered = /^\\d+\\./.test(marker);\n            const listType = isOrdered ? 'ol' : 'ul';\n            \n            // Check for task list items\n            let listItemContent = content;\n            let taskListClass = '';\n            const taskMatch = content.match(/^\\[([x ])\\]\\s+(.*)$/i);\n            if (taskMatch && !isOrdered) {\n                const [, checked, taskContent] = taskMatch;\n                const isChecked = checked.toLowerCase() === 'x';\n                const checkboxAttr = inline_styles \n                    ? ' style=\"margin-right:.5em\"' \n                    : ` class=\"${CLASS_PREFIX}task-checkbox\"`;\n                listItemContent = `<input type=\"checkbox\"${checkboxAttr}${isChecked ? ' checked' : ''} disabled> ${taskContent}`;\n                taskListClass = inline_styles ? ' style=\"list-style:none\"' : ` class=\"${CLASS_PREFIX}task-item\"`;\n            }\n            \n            // Close deeper levels\n            while (listStack.length > level + 1) {\n                const list = listStack.pop();\n                result.push(`</${list.type}>`);\n            }\n            \n            // Open new level if needed\n            if (listStack.length === level) {\n                // Need to open a new list\n                listStack.push({ type: listType, level });\n                result.push(`<${listType}${getAttr(listType)}>`);\n            } else if (listStack.length === level + 1) {\n                // Check if we need to switch list type\n                const currentList = listStack[listStack.length - 1];\n                if (currentList.type !== listType) {\n                    result.push(`</${currentList.type}>`);\n                    listStack.pop();\n                    listStack.push({ type: listType, level });\n                    result.push(`<${listType}${getAttr(listType)}>`);\n                }\n            }\n            \n            const liAttr = taskListClass || getAttr('li');\n            result.push(`<li${liAttr}${dataQd(marker)}>${listItemContent}</li>`);\n        } else {\n            // Not a list item, close all lists\n            while (listStack.length > 0) {\n                const list = listStack.pop();\n                result.push(`</${list.type}>`);\n            }\n            result.push(line);\n        }\n    }\n    \n    // Close any remaining lists\n    while (listStack.length > 0) {\n        const list = listStack.pop();\n        result.push(`</${list.type}>`);\n    }\n    \n    return result.join('\\n');\n}\n\n/**\n * Emit CSS styles for quikdown elements\n * @param {string} prefix - Optional class prefix (default: 'quikdown-')\n * @param {string} theme - Optional theme: 'light' (default) or 'dark'\n * @returns {string} CSS string with quikdown styles\n */\nquikdown.emitStyles = function(prefix = 'quikdown-', theme = 'light') {\n    const styles = QUIKDOWN_STYLES;\n    \n    // Define theme color overrides\n    const themeOverrides = {\n        dark: {\n            '#f4f4f4': '#2a2a2a', // pre background\n            '#f0f0f0': '#2a2a2a', // code background\n            '#f2f2f2': '#2a2a2a', // th background\n            '#ddd': '#3a3a3a',    // borders\n            '#06c': '#6db3f2',    // links\n            _textColor: '#e0e0e0'\n        },\n        light: {\n            _textColor: '#333'    // Explicit text color for light theme\n        }\n    };\n    \n    let css = '';\n    for (const [tag, style] of Object.entries(styles)) {\n        let themedStyle = style;\n            \n            // Apply theme overrides if dark theme\n            if (theme === 'dark' && themeOverrides.dark) {\n                // Replace colors\n                for (const [oldColor, newColor] of Object.entries(themeOverrides.dark)) {\n                    if (!oldColor.startsWith('_')) {\n                        themedStyle = themedStyle.replace(new RegExp(oldColor, 'g'), newColor);\n                    }\n                }\n                \n                // Add text color for certain elements in dark theme\n                const needsTextColor = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'td', 'li', 'blockquote'];\n                if (needsTextColor.includes(tag)) {\n                    themedStyle += `;color:${themeOverrides.dark._textColor}`;\n                }\n            } else if (theme === 'light' && themeOverrides.light) {\n                // Add explicit text color for light theme elements too\n                const needsTextColor = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'td', 'li', 'blockquote'];\n                if (needsTextColor.includes(tag)) {\n                    themedStyle += `;color:${themeOverrides.light._textColor}`;\n                }\n            }\n        \n        css += `.${prefix}${tag} { ${themedStyle} }\\n`;\n    }\n    \n    return css;\n};\n\n/**\n * Configure quikdown with options and return a function\n * @param {Object} options - Configuration options\n * @returns {Function} Configured quikdown function\n */\nquikdown.configure = function(options) {\n    return function(markdown) {\n        return quikdown(markdown, options);\n    };\n};\n\n/**\n * Version information\n */\nquikdown.version = quikdownVersion;\n\n// Export for both CommonJS and ES6\n/* istanbul ignore next */\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = quikdown;\n}\n\n// For browser global\n/* istanbul ignore next */\nif (typeof window !== 'undefined') {\n    window.quikdown = quikdown;\n}\n\nexport default quikdown;","/**\n * quikdown_bd - Bidirectional markdown/HTML converter\n * Extends core quikdown with HTML→Markdown conversion\n * \n * Uses data-qd attributes to preserve original markdown syntax\n * Enables HTML→Markdown conversion for quikdown-generated HTML\n */\n\nimport quikdown from './quikdown.js';\n\n/**\n * Create bidirectional version by extending quikdown\n * This wraps quikdown and adds the toMarkdown method\n */\nfunction quikdown_bd(markdown, options = {}) {\n    // Use core quikdown with bidirectional flag to add data-qd attributes\n    return quikdown(markdown, { ...options, bidirectional: true });\n}\n\n// Copy all properties and methods from quikdown (including version)\nObject.keys(quikdown).forEach(key => {\n    quikdown_bd[key] = quikdown[key];\n});\n\n// Add the toMarkdown method for HTML→Markdown conversion\nquikdown_bd.toMarkdown = function(htmlOrElement, options = {}) {\n    // Accept either HTML string or DOM element\n    let container;\n    if (typeof htmlOrElement === 'string') {\n        container = document.createElement('div');\n        container.innerHTML = htmlOrElement;\n    } else if (htmlOrElement instanceof Element) {\n        /* istanbul ignore next - browser-only code path, not testable in jsdom */\n        container = htmlOrElement;\n    } else {\n        return '';\n    }\n    \n    // Walk the DOM tree and reconstruct markdown\n    function walkNode(node, parentContext = {}) {\n        if (node.nodeType === Node.TEXT_NODE) {\n            // Return text content, preserving whitespace where needed\n            return node.textContent;\n        }\n        \n        if (node.nodeType !== Node.ELEMENT_NODE) {\n            return '';\n        }\n        \n        const tag = node.tagName.toLowerCase();\n        const dataQd = node.getAttribute('data-qd');\n        \n        // Process children with context\n        let childContent = '';\n        for (let child of node.childNodes) {\n            childContent += walkNode(child, { parentTag: tag, ...parentContext });\n        }\n        \n        // Determine markdown based on element and attributes\n        switch (tag) {\n            case 'h1':\n            case 'h2':\n            case 'h3':\n            case 'h4':\n            case 'h5':\n            case 'h6':\n                const level = parseInt(tag[1]);\n                const prefix = dataQd || '#'.repeat(level);\n                return `${prefix} ${childContent.trim()}\\n\\n`;\n                \n            case 'strong':\n            case 'b':\n                if (!childContent) return ''; // Don't add markers for empty content\n                const boldMarker = dataQd || '**';\n                return `${boldMarker}${childContent}${boldMarker}`;\n                \n            case 'em':\n            case 'i':\n                if (!childContent) return ''; // Don't add markers for empty content\n                const emMarker = dataQd || '*';\n                return `${emMarker}${childContent}${emMarker}`;\n                \n            case 'del':\n            case 's':\n            case 'strike':\n                if (!childContent) return ''; // Don't add markers for empty content\n                const delMarker = dataQd || '~~';\n                return `${delMarker}${childContent}${delMarker}`;\n                \n            case 'code':\n                // Note: code inside pre is handled directly by the pre case using querySelector\n                if (!childContent) return ''; // Don't add markers for empty content\n                const codeMarker = dataQd || '`';\n                return `${codeMarker}${childContent}${codeMarker}`;\n                \n            case 'pre':\n                const fence = node.getAttribute('data-qd-fence') || dataQd || '```';\n                const lang = node.getAttribute('data-qd-lang') || '';\n                \n                // Check if this was created by a fence plugin with reverse handler\n                if (options.fence_plugin && options.fence_plugin.reverse && lang) {\n                    try {\n                        const result = options.fence_plugin.reverse(node);\n                        if (result && result.content) {\n                            const fenceMarker = result.fence || fence;\n                            const langStr = result.lang || lang;\n                            return `${fenceMarker}${langStr}\\n${result.content}\\n${fenceMarker}\\n\\n`;\n                        }\n                    } catch (err) {\n                        console.warn('Fence reverse handler error:', err);\n                        // Fall through to default handling\n                    }\n                }\n                \n                // Fallback: use data-qd-source if available\n                const source = node.getAttribute('data-qd-source');\n                if (source) {\n                    return `${fence}${lang}\\n${source}\\n${fence}\\n\\n`;\n                }\n                \n                // Final fallback: extract text content\n                const codeEl = node.querySelector('code');\n                const codeContent = codeEl ? codeEl.textContent : childContent;\n                return `${fence}${lang}\\n${codeContent.trimEnd()}\\n${fence}\\n\\n`;\n                \n            case 'blockquote':\n                const quoteMarker = dataQd || '>';\n                const lines = childContent.trim().split('\\n');\n                return lines.map(line => `${quoteMarker} ${line}`).join('\\n') + '\\n\\n';\n                \n            case 'hr':\n                const hrMarker = dataQd || '---';\n                return `${hrMarker}\\n\\n`;\n                \n            case 'br':\n                const brMarker = dataQd || '  ';\n                return `${brMarker}\\n`;\n                \n            case 'a':\n                const linkText = node.getAttribute('data-qd-text') || childContent.trim();\n                const href = node.getAttribute('href') || '';\n                // Check for autolinks\n                if (linkText === href && !dataQd) {\n                    return `<${href}>`;\n                }\n                return `[${linkText}](${href})`;\n                \n            case 'img':\n                const alt = node.getAttribute('data-qd-alt') || node.getAttribute('alt') || '';\n                const src = node.getAttribute('data-qd-src') || node.getAttribute('src') || '';\n                const imgMarker = dataQd || '!';\n                return `${imgMarker}[${alt}](${src})`;\n                \n            case 'ul':\n            case 'ol':\n                return walkList(node, tag === 'ol') + '\\n';\n                \n            case 'li':\n                // Handled by list processor\n                return childContent;\n                \n            case 'table':\n                return walkTable(node) + '\\n\\n';\n                \n            case 'p':\n                // Check if it's actually a paragraph or just a wrapper\n                if (childContent.trim()) {\n                    // Check if paragraph ends with a line that's just whitespace\n                    // This indicates an intentional blank line before the next element\n                    const lines = childContent.split('\\n');\n                    let content = childContent.trim();\n                    \n                    // If the last line(s) are just whitespace, preserve one blank line\n                    if (lines.length > 1) {\n                        let trailingBlankLines = 0;\n                        for (let i = lines.length - 1; i >= 0; i--) {\n                            if (lines[i].trim() === '') {\n                                trailingBlankLines++;\n                            } else {\n                                break;\n                            }\n                        }\n                        if (trailingBlankLines > 0) {\n                            // Add a line with just a space, followed by single newline\n                            // The \\n\\n will be added below for paragraph separation\n                            content = content + '\\n ';\n                            // Only add one newline since we're preserving the space line\n                            return content + '\\n';\n                        }\n                    }\n                    \n                    return content + '\\n\\n';\n                }\n                return '';\n                \n            case 'div':\n                // Check if this was created by a fence plugin with reverse handler\n                const divLang = node.getAttribute('data-qd-lang');\n                const divFence = node.getAttribute('data-qd-fence');\n                \n                if (divLang && options.fence_plugin && options.fence_plugin.reverse) {\n                    try {\n                        const result = options.fence_plugin.reverse(node);\n                        if (result && result.content) {\n                            const fenceMarker = result.fence || divFence || '```';\n                            const langStr = result.lang || divLang;\n                            return `${fenceMarker}${langStr}\\n${result.content}\\n${fenceMarker}\\n\\n`;\n                        }\n                    } catch (err) {\n                        console.warn('Fence reverse handler error:', err);\n                        // Fall through to default handling\n                    }\n                }\n                \n                // Fallback: use data-qd-source if available\n                const divSource = node.getAttribute('data-qd-source');\n                if (divSource && divFence) {\n                    return `${divFence}${divLang || ''}\\n${divSource}\\n${divFence}\\n\\n`;\n                }\n                \n                // Check if it's a mermaid container\n                if (node.classList && node.classList.contains('mermaid-container')) {\n                    const fence = node.getAttribute('data-qd-fence') || '```';\n                    const lang = node.getAttribute('data-qd-lang') || 'mermaid';\n                    \n                    // First check for data-qd-source attribute on the container\n                    const source = node.getAttribute('data-qd-source');\n                    if (source) {\n                        // Decode HTML entities from the attribute (mainly &quot;)\n                        const temp = document.createElement('textarea');\n                        temp.innerHTML = source;\n                        const code = temp.value;\n                        return `${fence}${lang}\\n${code}\\n${fence}\\n\\n`;\n                    }\n                    \n                    // Check for source on the pre.mermaid element\n                    const mermaidPre = node.querySelector('pre.mermaid');\n                    if (mermaidPre) {\n                        const preSource = mermaidPre.getAttribute('data-qd-source');\n                        if (preSource) {\n                            const temp = document.createElement('textarea');\n                            temp.innerHTML = preSource;\n                            const code = temp.value;\n                            return `${fence}${lang}\\n${code}\\n${fence}\\n\\n`;\n                        }\n                    }\n                    \n                    // Fallback: Look for the legacy .mermaid-source element\n                    const sourceElement = node.querySelector('.mermaid-source');\n                    if (sourceElement) {\n                        // Decode HTML entities\n                        const temp = document.createElement('div');\n                        temp.innerHTML = sourceElement.innerHTML;\n                        const code = temp.textContent;\n                        return `${fence}${lang}\\n${code}\\n${fence}\\n\\n`;\n                    }\n                    \n                    // Final fallback: try to extract from the mermaid element (unreliable after rendering)\n                    const mermaidElement = node.querySelector('.mermaid');\n                    if (mermaidElement && mermaidElement.textContent.includes('graph')) {\n                        return `${fence}${lang}\\n${mermaidElement.textContent.trim()}\\n${fence}\\n\\n`;\n                    }\n                }\n                // Check if it's a standalone mermaid diagram (legacy)\n                if (node.classList && node.classList.contains('mermaid')) {\n                    const fence = node.getAttribute('data-qd-fence') || '```';\n                    const lang = node.getAttribute('data-qd-lang') || 'mermaid';\n                    const code = node.textContent.trim();\n                    return `${fence}${lang}\\n${code}\\n${fence}\\n\\n`;\n                }\n                // Pass through other divs\n                return childContent;\n            \n            case 'span':\n                // Pass through container elements\n                return childContent;\n                \n            default:\n                return childContent;\n        }\n    }\n    \n    // Walk list elements\n    function walkList(listNode, isOrdered, depth = 0) {\n        let result = '';\n        let index = 1;\n        const indent = '  '.repeat(depth);\n        \n        for (let child of listNode.children) {\n            if (child.tagName !== 'LI') continue;\n            \n            const dataQd = child.getAttribute('data-qd');\n            let marker = dataQd || (isOrdered ? `${index}.` : '-');\n            \n            // Check for task list checkbox\n            const checkbox = child.querySelector('input[type=\"checkbox\"]');\n            if (checkbox) {\n                const checked = checkbox.checked ? 'x' : ' ';\n                marker = '-';\n                // Get text without the checkbox\n                let text = '';\n                for (let node of child.childNodes) {\n                    if (node.nodeType === Node.TEXT_NODE) {\n                        text += node.textContent;\n                    } else if (node.tagName && node.tagName !== 'INPUT') {\n                        text += walkNode(node);\n                    }\n                }\n                result += `${indent}${marker} [${checked}] ${text.trim()}\\n`;\n            } else {\n                let itemContent = '';\n                \n                for (let node of child.childNodes) {\n                    if (node.tagName === 'UL' || node.tagName === 'OL') {\n                        itemContent += walkList(node, node.tagName === 'OL', depth + 1);\n                    } else {\n                        itemContent += walkNode(node);\n                    }\n                }\n                \n                result += `${indent}${marker} ${itemContent.trim()}\\n`;\n            }\n            \n            index++;\n        }\n        \n        return result;\n    }\n    \n    // Walk table elements\n    function walkTable(table) {\n        let result = '';\n        const alignData = table.getAttribute('data-qd-align');\n        const alignments = alignData ? alignData.split(',') : [];\n        \n        // Process header\n        const thead = table.querySelector('thead');\n        if (thead) {\n            const headerRow = thead.querySelector('tr');\n            if (headerRow) {\n                const headers = [];\n                for (let th of headerRow.querySelectorAll('th')) {\n                    headers.push(th.textContent.trim());\n                }\n                result += '| ' + headers.join(' | ') + ' |\\n';\n                \n                // Add separator with alignment\n                const separators = headers.map((_, i) => {\n                    const align = alignments[i] || 'left';\n                    if (align === 'center') return ':---:';\n                    if (align === 'right') return '---:';\n                    return '---';\n                });\n                result += '| ' + separators.join(' | ') + ' |\\n';\n            }\n        }\n        \n        // Process body\n        const tbody = table.querySelector('tbody');\n        if (tbody) {\n            for (let row of tbody.querySelectorAll('tr')) {\n                const cells = [];\n                for (let td of row.querySelectorAll('td')) {\n                    cells.push(td.textContent.trim());\n                }\n                if (cells.length > 0) {\n                    result += '| ' + cells.join(' | ') + ' |\\n';\n                }\n            }\n        }\n        \n        return result.trim();\n    }\n    \n    // Process the DOM tree\n    let markdown = walkNode(container);\n    \n    // Clean up\n    markdown = markdown.replace(/\\n{3,}/g, '\\n\\n'); // Remove excessive newlines\n    markdown = markdown.trim();\n    \n    return markdown;\n};\n\n// Override the configure method to return a bidirectional version\nquikdown_bd.configure = function(options) {\n    return function(markdown) {\n        return quikdown_bd(markdown, options);\n    };\n};\n\n// Set version\n// Version is already copied from quikdown via Object.keys loop\n\n// Export for both module and browser\n/* istanbul ignore next */\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = quikdown_bd;\n}\n\n/* istanbul ignore next */\nif (typeof window !== 'undefined') {\n    window.quikdown_bd = quikdown_bd;\n}\n\nexport default quikdown_bd;","/**\n * Rich copy functionality for QuikdownEditor\n * Handles copying rendered content with proper formatting for pasting into rich text editors\n */\n\n/**\n * Get platform information\n * @returns {string} The detected platform: 'macos', 'windows', 'linux', or 'unknown'\n */\nfunction getPlatform() {\n    const platform = navigator.platform?.toLowerCase() || '';\n    const userAgent = navigator.userAgent?.toLowerCase() || '';\n    \n    if (platform.includes('mac') || userAgent.includes('mac')) {\n        return 'macos';\n    } else if (userAgent.includes('windows')) {\n        return 'windows';\n    } else if (userAgent.includes('linux')) {\n        return 'linux';\n    }\n    return 'unknown';\n}\n\n/**\n * Copy to clipboard using HTML selection fallback (for Safari)\n * Uses div with selection to preserve HTML formatting\n * @param {string} html - HTML content to copy\n * @returns {boolean} Success status\n */\nfunction copyToClipboard(html) {\n    let tempDiv;\n    let result;\n    \n    try {\n        // Use a div instead of textarea to preserve HTML formatting\n        tempDiv = document.createElement('div');\n        tempDiv.style.position = 'fixed';\n        tempDiv.style.left = '-9999px';\n        tempDiv.style.top = '0';\n        tempDiv.style.width = '1px';\n        tempDiv.style.height = '1px';\n        tempDiv.style.overflow = 'hidden';\n        tempDiv.innerHTML = html;\n        \n        document.body.appendChild(tempDiv);\n        \n        // Select the HTML content\n        const range = document.createRange();\n        range.selectNodeContents(tempDiv);\n        const selection = window.getSelection();\n        selection.removeAllRanges();\n        selection.addRange(range);\n        \n        // Try to copy\n        result = document.execCommand('copy');\n        \n        // Clear selection\n        selection.removeAllRanges();\n    } catch (err) {\n        console.error('Fallback copy failed:', err);\n        result = false;\n    } finally {\n        if (tempDiv && tempDiv.parentNode) {\n            document.body.removeChild(tempDiv);\n        }\n    }\n    \n    return result;\n}\n\n/**\n * Convert SVG to PNG blob (based on squibview's implementation)\n * @param {SVGElement} svgElement - The SVG element to convert\n * @returns {Promise<Blob>} A promise that resolves with the PNG blob\n */\nasync function svgToPng(svgElement, needsWhiteBackground = false) {\n    return new Promise((resolve, reject) => {\n        const svgString = new XMLSerializer().serializeToString(svgElement);\n        const canvas = document.createElement('canvas');\n        const ctx = canvas.getContext('2d');\n        const img = new Image();\n        \n        const scale = 2;\n        \n        // Check if this is a Mermaid-generated SVG (they don't have explicit width/height attributes)\n        const isMermaidSvg = svgElement.closest('.mermaid') || svgElement.classList.contains('mermaid');\n        const hasExplicitDimensions = svgElement.getAttribute('width') && svgElement.getAttribute('height');\n        \n        let svgWidth, svgHeight;\n        \n        if (isMermaidSvg || !hasExplicitDimensions) {\n            // For Mermaid or other generated SVGs, prioritize computed dimensions\n            svgWidth = svgElement.clientWidth || \n                       (svgElement.viewBox && svgElement.viewBox.baseVal.width) || \n                       parseFloat(svgElement.getAttribute('width')) || 400;\n            svgHeight = svgElement.clientHeight || \n                        (svgElement.viewBox && svgElement.viewBox.baseVal.height) || \n                        parseFloat(svgElement.getAttribute('height')) || 300;\n        } else {\n            // For explicit SVGs (like fenced SVG blocks), prioritize explicit attributes\n            svgWidth = parseFloat(svgElement.getAttribute('width')) || \n                       (svgElement.viewBox && svgElement.viewBox.baseVal.width) || \n                       svgElement.clientWidth || 400;\n            svgHeight = parseFloat(svgElement.getAttribute('height')) || \n                        (svgElement.viewBox && svgElement.viewBox.baseVal.height) || \n                        svgElement.clientHeight || 300;\n        }\n        \n        // Ensure the SVG string has explicit dimensions by modifying it if necessary\n        let modifiedSvgString = svgString;\n        if (svgWidth && svgHeight) {\n            // Create a temporary SVG element to modify the serialized string\n            const tempDiv = document.createElement('div');\n            tempDiv.innerHTML = svgString;\n            const tempSvg = tempDiv.querySelector('svg');\n            if (tempSvg) {\n                tempSvg.setAttribute('width', svgWidth.toString());\n                tempSvg.setAttribute('height', svgHeight.toString());\n                modifiedSvgString = new XMLSerializer().serializeToString(tempSvg);\n            }\n        }\n        \n        canvas.width = svgWidth * scale;\n        canvas.height = svgHeight * scale;\n        ctx.scale(scale, scale);\n        \n        img.onload = () => {\n            try {\n                // Add white background for math equations (they often have transparent backgrounds)\n                if (needsWhiteBackground) {\n                    ctx.fillStyle = 'white';\n                    ctx.fillRect(0, 0, canvas.width, canvas.height);\n                }\n                \n                ctx.drawImage(img, 0, 0, svgWidth, svgHeight);\n                canvas.toBlob(blob => {\n                    resolve(blob);\n                }, 'image/png', 1.0);\n            } catch (err) {\n                reject(err);\n            }\n        };\n        \n        img.onerror = reject;\n        // Use data URI instead of blob URL to avoid tainting the canvas\n        const svgDataUrl = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(modifiedSvgString)}`;\n        img.src = svgDataUrl;\n    });\n}\n\n/**\n * Rasterize a GeoJSON Leaflet map to PNG data URL (following Gem's guide)\n * @param {HTMLElement} liveContainer - The live map container element\n * @returns {Promise<string|null>} PNG data URL or null if failed\n */\nasync function rasterizeGeoJSONMap(liveContainer) {\n    try {\n        const map = liveContainer._map;\n        if (!map) {\n            console.warn('No map found on container');\n            return null;\n        }\n        \n        // Get container dimensions\n        const mapRect = liveContainer.getBoundingClientRect();\n        const width = Math.round(mapRect.width);\n        const height = Math.round(mapRect.height);\n        \n        if (width === 0 || height === 0) {\n            console.warn('Map container has zero dimensions');\n            return null;\n        }\n        \n        // Create canvas sized to the map container\n        const canvas = document.createElement('canvas');\n        const dpr = window.devicePixelRatio || 1;\n        \n        // Set canvas size with DPR for sharpness\n        canvas.width = width * dpr;\n        canvas.height = height * dpr;\n        canvas.style.width = width + 'px';\n        canvas.style.height = height + 'px';\n        \n        const ctx = canvas.getContext('2d');\n        ctx.scale(dpr, dpr);\n        \n        // White background\n        ctx.fillStyle = '#FFFFFF';\n        ctx.fillRect(0, 0, width, height);\n        \n        // 1. Draw tiles from THIS container only\n        const tiles = liveContainer.querySelectorAll('.leaflet-tile');\n        console.log(`Found ${tiles.length} tiles to capture`);\n        \n        const tilePromises = [];\n        for (const tile of tiles) {\n            tilePromises.push(new Promise((resolve) => {\n                const img = new Image();\n                img.crossOrigin = 'anonymous';\n                \n                img.onload = () => {\n                    try {\n                        // Calculate tile position relative to container\n                        const tileRect = tile.getBoundingClientRect();\n                        const offsetX = tileRect.left - mapRect.left;\n                        const offsetY = tileRect.top - mapRect.top;\n                        \n                        // Draw tile at correct position\n                        ctx.drawImage(img, offsetX, offsetY, tileRect.width, tileRect.height);\n                        console.log(`Drew tile at ${offsetX}, ${offsetY}`);\n                    } catch (err) {\n                        console.warn('Failed to draw tile:', err);\n                    }\n                    resolve();\n                };\n                \n                img.onerror = () => {\n                    console.warn('Failed to load tile:', tile.src);\n                    resolve();\n                };\n                \n                img.src = tile.src;\n            }));\n        }\n        \n        // Wait for all tiles to load\n        await Promise.all(tilePromises);\n        \n        // 2. Draw vector overlays (SVG paths for GeoJSON features)\n        const svgOverlays = liveContainer.querySelectorAll('svg:not(.leaflet-attribution-flag)');\n        console.log(`Found ${svgOverlays.length} SVG overlays`);\n        \n        for (const svg of svgOverlays) {\n            // Skip attribution/control overlays\n            if (svg.closest('.leaflet-control')) continue;\n            \n            try {\n                const svgRect = svg.getBoundingClientRect();\n                const offsetX = svgRect.left - mapRect.left;\n                const offsetY = svgRect.top - mapRect.top;\n                \n                // Serialize SVG\n                const serializer = new XMLSerializer();\n                const svgStr = serializer.serializeToString(svg);\n                const svgBlob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });\n                const url = URL.createObjectURL(svgBlob);\n                \n                // Draw SVG overlay\n                await new Promise((resolve, reject) => {\n                    const img = new Image();\n                    img.onload = () => {\n                        ctx.drawImage(img, offsetX, offsetY, svgRect.width, svgRect.height);\n                        URL.revokeObjectURL(url);\n                        resolve();\n                    };\n                    img.onerror = () => {\n                        URL.revokeObjectURL(url);\n                        reject(new Error('Failed to load SVG overlay'));\n                    };\n                    img.src = url;\n                });\n            } catch (err) {\n                console.warn('Failed to draw SVG overlay:', err);\n            }\n        }\n        \n        // 3. Draw marker icons if any\n        const markerIcons = liveContainer.querySelectorAll('.leaflet-marker-icon');\n        console.log(`Found ${markerIcons.length} marker icons`);\n        \n        for (const marker of markerIcons) {\n            try {\n                const img = new Image();\n                img.crossOrigin = 'anonymous';\n                \n                await new Promise((resolve) => {\n                    img.onload = () => {\n                        const markerRect = marker.getBoundingClientRect();\n                        const offsetX = markerRect.left - mapRect.left;\n                        const offsetY = markerRect.top - mapRect.top;\n                        ctx.drawImage(img, offsetX, offsetY, markerRect.width, markerRect.height);\n                        resolve();\n                    };\n                    img.onerror = resolve;\n                    img.src = marker.src;\n                });\n            } catch (err) {\n                console.warn('Failed to draw marker icon:', err);\n            }\n        }\n        \n        // Return PNG data URL\n        return canvas.toDataURL('image/png', 1.0);\n        \n    } catch (error) {\n        console.error('Failed to rasterize GeoJSON map:', error);\n        return null;\n    }\n}\n\n/**\n * Get rendered content as rich HTML suitable for clipboard\n * @param {HTMLElement} previewPanel - The preview panel element to copy from\n * @returns {Promise<{success: boolean, html?: string, text?: string}>}\n */\nexport async function getRenderedContent(previewPanel) {\n    if (!previewPanel) {\n        throw new Error('No preview panel available');\n    }\n    \n    // Check if MathJax needs to render (only if not already rendered)\n    const mathBlocks = previewPanel.querySelectorAll('.math-display');\n    if (mathBlocks.length > 0) {\n        // Check if already rendered (has mjx-container inside)\n        const needsRendering = Array.from(mathBlocks).some(block => !block.querySelector('mjx-container'));\n        \n        if (needsRendering && window.MathJax && window.MathJax.typesetPromise) {\n            console.log('Waiting for MathJax to render...');\n            try {\n                await window.MathJax.typesetPromise(Array.from(mathBlocks));\n            } catch (err) {\n                console.warn('MathJax typesetting failed:', err);\n            }\n        } else {\n            console.log('MathJax already rendered, skipping wait');\n        }\n    }\n    \n    // Clone the preview panel to avoid modifying the actual DOM\n    const clone = previewPanel.cloneNode(true);\n    \n    // Process different fence types for rich copy\n    try {\n        // Phase 1: Process basic markdown elements with inline styles\n        \n        // 1.1 Text formatting - add inline styles\n        clone.querySelectorAll('strong, b').forEach(el => {\n            el.style.fontWeight = 'bold';\n        });\n        \n        clone.querySelectorAll('em, i').forEach(el => {\n            el.style.fontStyle = 'italic';\n        });\n        \n        clone.querySelectorAll('del, s, strike').forEach(el => {\n            el.style.textDecoration = 'line-through';\n        });\n        \n        clone.querySelectorAll('u').forEach(el => {\n            el.style.textDecoration = 'underline';\n        });\n        \n        clone.querySelectorAll('code:not(pre code)').forEach(el => {\n            el.style.backgroundColor = '#f4f4f4';\n            el.style.padding = '2px 4px';\n            el.style.borderRadius = '3px';\n            el.style.fontFamily = 'monospace';\n            el.style.fontSize = '0.9em';\n        });\n        \n        // 1.2 Block elements - add inline styles\n        clone.querySelectorAll('h1').forEach(el => {\n            el.style.fontSize = '2em';\n            el.style.fontWeight = 'bold';\n            el.style.marginTop = '0.67em';\n            el.style.marginBottom = '0.67em';\n        });\n        \n        clone.querySelectorAll('h2').forEach(el => {\n            el.style.fontSize = '1.5em';\n            el.style.fontWeight = 'bold';\n            el.style.marginTop = '0.83em';\n            el.style.marginBottom = '0.83em';\n        });\n        \n        clone.querySelectorAll('h3').forEach(el => {\n            el.style.fontSize = '1.17em';\n            el.style.fontWeight = 'bold';\n            el.style.marginTop = '1em';\n            el.style.marginBottom = '1em';\n        });\n        \n        clone.querySelectorAll('h4').forEach(el => {\n            el.style.fontSize = '1em';\n            el.style.fontWeight = 'bold';\n            el.style.marginTop = '1.33em';\n            el.style.marginBottom = '1.33em';\n        });\n        \n        clone.querySelectorAll('h5').forEach(el => {\n            el.style.fontSize = '0.83em';\n            el.style.fontWeight = 'bold';\n            el.style.marginTop = '1.67em';\n            el.style.marginBottom = '1.67em';\n        });\n        \n        clone.querySelectorAll('h6').forEach(el => {\n            el.style.fontSize = '0.67em';\n            el.style.fontWeight = 'bold';\n            el.style.marginTop = '2.33em';\n            el.style.marginBottom = '2.33em';\n        });\n        \n        clone.querySelectorAll('blockquote').forEach(el => {\n            el.style.borderLeft = '4px solid #ddd';\n            el.style.marginLeft = '0';\n            el.style.paddingLeft = '1em';\n            el.style.color = '#666';\n        });\n        \n        clone.querySelectorAll('hr').forEach(el => {\n            el.style.border = 'none';\n            el.style.borderTop = '1px solid #ccc';\n            el.style.margin = '1em 0';\n        });\n        \n        // 1.3 Tables - add inline styles\n        clone.querySelectorAll('table').forEach(table => {\n            table.style.borderCollapse = 'collapse';\n            table.style.width = '100%';\n            table.style.marginBottom = '1em';\n        });\n        \n        clone.querySelectorAll('th').forEach(th => {\n            th.style.border = '1px solid #ccc';\n            th.style.padding = '8px';\n            th.style.textAlign = 'left';\n            th.style.backgroundColor = '#f0f0f0';\n            th.style.fontWeight = 'bold';\n        });\n        \n        clone.querySelectorAll('td').forEach(td => {\n            td.style.border = '1px solid #ccc';\n            td.style.padding = '8px';\n            td.style.textAlign = 'left';\n        });\n        \n        // 1.4 Links - add inline styles\n        clone.querySelectorAll('a').forEach(a => {\n            a.style.color = '#0066cc';\n            a.style.textDecoration = 'underline';\n        });\n        \n        // Process code blocks - wrap in table and add syntax highlighting colors\n        clone.querySelectorAll('pre code').forEach(block => {\n            const pre = block.parentElement;\n            \n            // Add inline styles for syntax highlighting (GitHub theme colors)\n            if (block.classList.contains('hljs')) {\n                // Apply inline styles to all highlight.js elements\n                block.querySelectorAll('.hljs-keyword').forEach(el => {\n                    el.style.color = '#d73a49';\n                    el.style.fontWeight = 'bold';\n                });\n                block.querySelectorAll('.hljs-string').forEach(el => {\n                    el.style.color = '#032f62';\n                });\n                block.querySelectorAll('.hljs-number').forEach(el => {\n                    el.style.color = '#005cc5';\n                });\n                block.querySelectorAll('.hljs-comment').forEach(el => {\n                    el.style.color = '#6a737d';\n                    el.style.fontStyle = 'italic';\n                });\n                block.querySelectorAll('.hljs-function').forEach(el => {\n                    el.style.color = '#6f42c1';\n                });\n                block.querySelectorAll('.hljs-class').forEach(el => {\n                    el.style.color = '#6f42c1';\n                });\n                block.querySelectorAll('.hljs-title').forEach(el => {\n                    el.style.color = '#6f42c1';\n                });\n                block.querySelectorAll('.hljs-built_in').forEach(el => {\n                    el.style.color = '#005cc5';\n                });\n                block.querySelectorAll('.hljs-literal').forEach(el => {\n                    el.style.color = '#005cc5';\n                });\n                block.querySelectorAll('.hljs-meta').forEach(el => {\n                    el.style.color = '#005cc5';\n                });\n                block.querySelectorAll('.hljs-attr').forEach(el => {\n                    el.style.color = '#22863a';\n                });\n                block.querySelectorAll('.hljs-variable').forEach(el => {\n                    el.style.color = '#e36209';\n                });\n                block.querySelectorAll('.hljs-regexp').forEach(el => {\n                    el.style.color = '#032f62';\n                });\n                block.querySelectorAll('.hljs-selector-class').forEach(el => {\n                    el.style.color = '#22863a';\n                });\n                block.querySelectorAll('.hljs-selector-id').forEach(el => {\n                    el.style.color = '#6f42c1';\n                });\n                block.querySelectorAll('.hljs-selector-tag').forEach(el => {\n                    el.style.color = '#22863a';\n                });\n                block.querySelectorAll('.hljs-tag').forEach(el => {\n                    el.style.color = '#22863a';\n                });\n                block.querySelectorAll('.hljs-name').forEach(el => {\n                    el.style.color = '#22863a';\n                });\n                block.querySelectorAll('.hljs-attribute').forEach(el => {\n                    el.style.color = '#6f42c1';\n                });\n            }\n            \n            const table = document.createElement('table');\n            table.style.width = '100%';\n            table.style.borderCollapse = 'collapse';\n            table.style.border = 'none';\n            table.style.marginBottom = '1em';\n            \n            const tr = document.createElement('tr');\n            const td = document.createElement('td');\n            td.style.backgroundColor = '#f7f7f7';\n            td.style.padding = '12px';\n            td.style.fontFamily = 'Consolas, Monaco, \"Courier New\", monospace';\n            td.style.fontSize = '14px';\n            td.style.lineHeight = '1.4';\n            td.style.whiteSpace = 'pre';\n            td.style.overflowX = 'auto';\n            td.style.border = '1px solid #ddd';\n            td.style.borderRadius = '4px';\n            \n            // Move the formatted code content with inline styles\n            td.innerHTML = block.innerHTML;\n            \n            tr.appendChild(td);\n            table.appendChild(tr);\n            \n            // Replace the pre element with the table\n            pre.parentNode.replaceChild(table, pre);\n        });\n        \n        // Process images - convert to data URLs and ensure proper dimensions\n        const images = clone.querySelectorAll('img');\n        for (const img of images) {\n            // Ensure image has dimensions for Google Docs compatibility\n            if (!img.width && img.naturalWidth) {\n                img.width = img.naturalWidth;\n            }\n            if (!img.height && img.naturalHeight) {\n                img.height = img.naturalHeight;\n            }\n            \n            // Set max dimensions to prevent huge images\n            const maxWidth = 800;\n            const maxHeight = 600;\n            if (img.width > maxWidth || img.height > maxHeight) {\n                const scale = Math.min(maxWidth / img.width, maxHeight / img.height);\n                img.width = Math.round(img.width * scale);\n                img.height = Math.round(img.height * scale);\n            }\n            \n            // Ensure width and height attributes are set\n            if (img.width) {\n                img.setAttribute('width', img.width.toString());\n                img.style.width = img.width + 'px';\n            }\n            if (img.height) {\n                img.setAttribute('height', img.height.toString());\n                img.style.height = img.height + 'px';\n            }\n            \n            // Add v:shapes for Word compatibility\n            if (!img.getAttribute('v:shapes')) {\n                img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n            }\n            \n            // Skip if already a data URL\n            if (img.src && !img.src.startsWith('data:')) {\n                try {\n                    // Try to convert to data URL\n                    const response = await fetch(img.src);\n                    const blob = await response.blob();\n                    \n                    // Check if image is too large (Google Docs has limits)\n                    const maxSize = 2 * 1024 * 1024; // 2MB limit for inline images\n                    if (blob.size > maxSize) {\n                        console.warn('Image too large for inline data URL:', img.src, 'Size:', blob.size);\n                        // For large images, we might want to resize or keep the URL\n                        continue;\n                    }\n                    \n                    const dataUrl = await new Promise(resolve => {\n                        const reader = new FileReader();\n                        reader.onloadend = () => resolve(reader.result);\n                        reader.readAsDataURL(blob);\n                    });\n                    img.src = dataUrl;\n                } catch (err) {\n                    console.warn('Failed to convert image to data URL:', img.src, err);\n                    // Keep original src if conversion fails\n                }\n            }\n        }\n        \n        // Phase 2: Process fence block types\n        // 1. Process STL 3D models - convert canvas to image or placeholder\n        const stlContainers = clone.querySelectorAll('.qde-stl-container');\n        for (const container of stlContainers) {\n            try {\n                // Find the corresponding original container to get the canvas\n                const containerId = container.dataset.stlId;\n                const originalContainer = previewPanel.querySelector(`.qde-stl-container[data-stl-id=\"${containerId}\"]`);\n                \n                if (originalContainer) {\n                    // Look for canvas element in the original container (Three.js WebGL canvas)\n                    const canvas = originalContainer.querySelector('canvas');\n                    if (canvas && canvas.width > 0 && canvas.height > 0) {\n                        try {\n                            // Get Three.js references stored on the container (like squibview)\n                            const renderer = originalContainer._threeRenderer;\n                            const scene = originalContainer._threeScene;\n                            const camera = originalContainer._threeCamera;\n                            \n                            // If we have access to the Three.js objects, force render the scene\n                            if (renderer && scene && camera) {\n                                renderer.render(scene, camera);\n                            }\n                            \n                            // Try to capture the canvas as an image\n                            const dataUrl = canvas.toDataURL('image/png', 1.0);\n                            const img = document.createElement('img');\n                            img.src = dataUrl;\n                            \n                            // Use canvas dimensions for the image\n                            const imgWidth = canvas.width / 2; // Divide by scale factor (2x for retina)\n                            const imgHeight = canvas.height / 2;\n                            \n                            // Set both HTML attributes and CSS properties for maximum compatibility\n                            img.width = imgWidth;\n                            img.height = imgHeight;\n                            img.setAttribute('width', imgWidth.toString());\n                            img.setAttribute('height', imgHeight.toString());\n                            img.style.width = imgWidth + 'px';\n                            img.style.height = imgHeight + 'px';\n                            img.style.maxWidth = 'none';\n                            img.style.maxHeight = 'none';\n                            img.style.border = '1px solid #ddd';\n                            img.style.borderRadius = '4px';\n                            img.style.margin = '0.5em 0';\n                            img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                            img.alt = 'STL 3D Model';\n                            \n                            container.parentNode.replaceChild(img, container);\n                            continue;\n                        } catch (canvasErr) {\n                            console.warn('Failed to convert STL canvas to image (likely WebGL context issue):', canvasErr);\n                        }\n                    } else {\n                        console.warn('No valid canvas found in STL container');\n                    }\n                } else {\n                    console.warn('Could not find original STL container');\n                }\n            } catch (err) {\n                console.error('Error processing STL container for copy:', err);\n            }\n            \n            // Fallback to placeholder if canvas conversion fails\n            const placeholder = document.createElement('div');\n            placeholder.style.cssText = 'padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;';\n            placeholder.textContent = '[STL 3D Model - Interactive content not available in copy]';\n            container.parentNode.replaceChild(placeholder, container);\n        }\n        \n        // 2. Process Mermaid diagrams - convert SVG to PNG\n        const mermaidContainers = clone.querySelectorAll('.mermaid');\n        for (const container of mermaidContainers) {\n            const svg = container.querySelector('svg');\n            if (svg) {\n                try {\n                    const pngBlob = await svgToPng(svg);\n                    const dataUrl = await new Promise(resolve => {\n                        const reader = new FileReader();\n                        reader.onloadend = () => resolve(reader.result);\n                        reader.readAsDataURL(pngBlob);\n                    });\n                    \n                    const img = document.createElement('img');\n                    img.src = dataUrl;\n                    \n                    // Use the exact same dimension calculation logic as svgToPng (like squibview)\n                    const isMermaidSvg = svg.closest('.mermaid') || svg.classList.contains('mermaid');\n                    const hasExplicitDimensions = svg.getAttribute('width') && svg.getAttribute('height');\n                    \n                    let imgWidth, imgHeight;\n                    \n                    if (isMermaidSvg || !hasExplicitDimensions) {\n                        // For Mermaid or other generated SVGs, prioritize computed dimensions\n                        imgWidth = svg.clientWidth || \n                                   (svg.viewBox && svg.viewBox.baseVal.width) || \n                                   parseFloat(svg.getAttribute('width')) || 400;\n                        imgHeight = svg.clientHeight || \n                                    (svg.viewBox && svg.viewBox.baseVal.height) || \n                                    parseFloat(svg.getAttribute('height')) || 300;\n                    } else {\n                        // For explicit SVGs (like fenced SVG blocks), prioritize explicit attributes\n                        imgWidth = parseFloat(svg.getAttribute('width')) || \n                                   (svg.viewBox && svg.viewBox.baseVal.width) || \n                                   svg.clientWidth || 400;\n                        imgHeight = parseFloat(svg.getAttribute('height')) || \n                                    (svg.viewBox && svg.viewBox.baseVal.height) || \n                                    svg.clientHeight || 300;\n                    }\n                    \n                    // Set both HTML attributes and CSS properties for maximum compatibility (like squibview)\n                    img.width = imgWidth;\n                    img.height = imgHeight;\n                    img.setAttribute('width', imgWidth.toString());\n                    img.setAttribute('height', imgHeight.toString());\n                    img.style.width = imgWidth + 'px';\n                    img.style.height = imgHeight + 'px';\n                    img.style.maxWidth = 'none';  // Prevent CSS from constraining the image\n                    img.style.maxHeight = 'none';\n                    img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                    img.alt = 'Mermaid Diagram';\n                    \n                    container.parentNode.replaceChild(img, container);\n                } catch (err) {\n                    console.warn('Failed to convert Mermaid diagram:', err);\n                    // Fallback: leave as SVG\n                }\n            }\n        }\n        \n        // 3. Process Chart.js charts - convert canvas to image\n        const chartContainers = clone.querySelectorAll('.qde-chart-container');\n        for (const container of chartContainers) {\n            try {\n                const containerId = container.dataset.chartId;\n                const originalContainer = previewPanel.querySelector(`.qde-chart-container[data-chart-id=\"${containerId}\"]`);\n                \n                if (originalContainer) {\n                    const canvas = originalContainer.querySelector('canvas');\n                    if (canvas && canvas.width > 0 && canvas.height > 0) {\n                        try {\n                            const dataUrl = canvas.toDataURL('image/png', 1.0);\n                            const img = document.createElement('img');\n                            img.src = dataUrl;\n                            \n                            // Use canvas dimensions for the image\n                            const imgWidth = canvas.width;\n                            const imgHeight = canvas.height;\n                            \n                            // Set both HTML attributes and CSS properties for maximum compatibility\n                            img.width = imgWidth;\n                            img.height = imgHeight;\n                            img.setAttribute('width', imgWidth.toString());\n                            img.setAttribute('height', imgHeight.toString());\n                            img.style.width = imgWidth + 'px';\n                            img.style.height = imgHeight + 'px';\n                            img.style.maxWidth = 'none';\n                            img.style.maxHeight = 'none';\n                            img.style.margin = '0.5em 0';\n                            img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                            img.alt = 'Chart';\n                            \n                            container.parentNode.replaceChild(img, container);\n                            continue;\n                        } catch (canvasErr) {\n                            console.warn('Failed to convert chart canvas to image:', canvasErr);\n                        }\n                    }\n                }\n            } catch (err) {\n                console.warn('Error processing chart container:', err);\n            }\n            \n            // Fallback to placeholder\n            const placeholder = document.createElement('div');\n            placeholder.style.cssText = 'padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;';\n            placeholder.textContent = '[Chart - Interactive content not available in copy]';\n            container.parentNode.replaceChild(placeholder, container);\n        }\n        \n        // 4. Process SVG fenced blocks - convert to PNG\n        const svgContainers = clone.querySelectorAll('.qde-svg-container svg');\n        for (const svg of svgContainers) {\n            try {\n                const pngBlob = await svgToPng(svg);\n                const dataUrl = await new Promise(resolve => {\n                    const reader = new FileReader();\n                    reader.onloadend = () => resolve(reader.result);\n                    reader.readAsDataURL(pngBlob);\n                });\n                \n                const img = document.createElement('img');\n                img.src = dataUrl;\n                \n                // Calculate dimensions for the SVG\n                const hasExplicitDimensions = svg.getAttribute('width') && svg.getAttribute('height');\n                \n                let imgWidth, imgHeight;\n                \n                if (hasExplicitDimensions) {\n                    // For explicit SVGs (like fenced SVG blocks), prioritize explicit attributes\n                    imgWidth = parseFloat(svg.getAttribute('width')) || \n                               (svg.viewBox && svg.viewBox.baseVal.width) || \n                               svg.clientWidth || 400;\n                    imgHeight = parseFloat(svg.getAttribute('height')) || \n                                (svg.viewBox && svg.viewBox.baseVal.height) || \n                                svg.clientHeight || 300;\n                } else {\n                    // For generated SVGs, prioritize computed dimensions\n                    imgWidth = svg.clientWidth || \n                               (svg.viewBox && svg.viewBox.baseVal.width) || \n                               parseFloat(svg.getAttribute('width')) || 400;\n                    imgHeight = svg.clientHeight || \n                                (svg.viewBox && svg.viewBox.baseVal.height) || \n                                parseFloat(svg.getAttribute('height')) || 300;\n                }\n                \n                // Set both HTML attributes and CSS properties for maximum compatibility\n                img.width = imgWidth;\n                img.height = imgHeight;\n                img.setAttribute('width', imgWidth.toString());\n                img.setAttribute('height', imgHeight.toString());\n                img.style.width = imgWidth + 'px';\n                img.style.height = imgHeight + 'px';\n                img.style.maxWidth = 'none';  // Prevent CSS from constraining the image\n                img.style.maxHeight = 'none';\n                img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                img.alt = 'SVG Image';\n                \n                svg.parentNode.replaceChild(img, svg);\n            } catch (err) {\n                console.warn('Failed to convert SVG to image:', err);\n                // Leave as SVG if conversion fails\n            }\n        }\n        \n        // 5. Process Math equations - convert to PNG images (exactly like squibview)\n        const mathElements = Array.from(clone.querySelectorAll('.math-display'));\n        \n        // Process math elements - try keeping the SVG directly first\n        if (mathElements.length > 0) {\n            console.log(`Processing ${mathElements.length} math elements`);\n            for (const mathEl of mathElements) {\n                try {\n                    // Check what's inside the math element\n                    const mjxContainer = mathEl.querySelector('mjx-container');\n                    console.log('Math element structure:', {\n                        id: mathEl.id,\n                        hasMjxContainer: !!mjxContainer,\n                        hasSVG: !!mathEl.querySelector('svg')\n                    });\n                    \n                    // Look for SVG to convert to PNG (use original DOM for accurate sizing)\n                    let svg = null;\n                    try {\n                        const origMath = mathEl.id ? previewPanel.querySelector(`#${mathEl.id}`) : null;\n                        svg = (origMath && origMath.querySelector('svg')) || mathEl.querySelector('svg');\n                    } catch (_) {\n                        svg = mathEl.querySelector('svg');\n                    }\n                    if (!svg) {\n                        console.warn('No SVG found in math element, skipping');\n                        continue;\n                    }\n                    \n                    // Convert SVG to PNG data URL using squibview-like normalization\n                    const serializer = new XMLSerializer();\n                    let svgStr = serializer.serializeToString(svg);\n                    // Normalize: ensure xmlns, replace currentColor, convert ex->px, ensure viewBox\n                    try {\n                        svgStr = svgStr.replace(/currentColor/g, 'black');\n                        const tdiv = document.createElement('div');\n                        tdiv.innerHTML = svgStr;\n                        const ts = tdiv.querySelector('svg');\n                        if (ts) {\n                            if (!ts.hasAttribute('xmlns')) {\n                                ts.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n                            }\n                            if (!ts.hasAttribute('xmlns:xlink')) {\n                                ts.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');\n                            }\n                            const exToPx = (val) => {\n                                if (!val) return null;\n                                if (/ex$/i.test(val)) {\n                                    const num = parseFloat(val);\n                                    if (!isNaN(num)) return String(Math.round(num * 8));\n                                }\n                                if (/px$/i.test(val)) {\n                                    return String(parseFloat(val));\n                                }\n                                const num = parseFloat(val);\n                                return isNaN(num) ? null : String(num);\n                            };\n                            const w = ts.getAttribute('width');\n                            const h = ts.getAttribute('height');\n                            const wPx = exToPx(w);\n                            const hPx = exToPx(h);\n                            if (wPx) ts.setAttribute('width', wPx);\n                            if (hPx) ts.setAttribute('height', hPx);\n                            if (!ts.hasAttribute('viewBox')) {\n                                const vw = wPx ? parseFloat(wPx) : (ts.viewBox && ts.viewBox.baseVal ? ts.viewBox.baseVal.width : null);\n                                const vh = hPx ? parseFloat(hPx) : (ts.viewBox && ts.viewBox.baseVal ? ts.viewBox.baseVal.height : null);\n                                if (vw && vh) ts.setAttribute('viewBox', `0 0 ${vw} ${vh}`);\n                            }\n                            svgStr = new XMLSerializer().serializeToString(ts);\n                        }\n                    } catch (_) {}\n                    const svgBlob = new Blob([svgStr], { type: \"image/svg+xml;charset=utf-8\" });\n                    const url = URL.createObjectURL(svgBlob);\n                    \n                    const img = new Image();\n                    const dataUrl = await new Promise((resolve, reject) => {\n                        img.onload = function () {\n                            const canvas = document.createElement('canvas');\n                            \n                            // Prefer the on-screen rendered size from the ORIGINAL element\n                            let rect = { width: 0, height: 0 };\n                            try {\n                                rect = svg.getBoundingClientRect();\n                            } catch (_) {}\n                            let width = Math.round(rect.width);\n                            let height = Math.round(rect.height);\n                            let usedRect = width > 0 && height > 0;\n\n                            if (!usedRect) {\n                                // Fallback: try absolute units or viewBox\n                                try {\n                                    width = svg.width.baseVal.value;\n                                    height = svg.height.baseVal.value;\n                                } catch (e) {\n                                    if (svg.viewBox && svg.viewBox.baseVal) {\n                                        width = svg.viewBox.baseVal.width;\n                                        height = svg.viewBox.baseVal.height;\n                                    } else {\n                                        width = img.naturalWidth || img.width || 200;\n                                        height = img.naturalHeight || img.height || 50;\n                                    }\n                                }\n                            }\n                            \n                            // Target constraints\n                            const targetMaxWidth = 300;\n                            const targetMaxHeight = 100;\n                            \n                            // If we used screen rect, don't apply base 0.10 shrink\n                            let scaleFactor = usedRect ? 1.0 : 0.10;\n                            \n                            let scaledWidth = width * scaleFactor;\n                            let scaledHeight = height * scaleFactor;\n                            if (scaledWidth > targetMaxWidth || scaledHeight > targetMaxHeight) {\n                                const scaleX = targetMaxWidth / scaledWidth;\n                                const scaleY = targetMaxHeight / scaledHeight;\n                                scaleFactor *= Math.min(scaleX, scaleY);\n                                scaledWidth = width * scaleFactor;\n                                scaledHeight = height * scaleFactor;\n                            }\n                            width = Math.max(1, Math.round(scaledWidth));\n                            height = Math.max(1, Math.round(scaledHeight));\n                            \n                            // Use device pixel ratio for crisp rasterization\n                            const dpr = Math.max(1, window.devicePixelRatio || 1);\n                            canvas.width = Math.round(width * dpr);\n                            canvas.height = Math.round(height * dpr);\n                            const ctx = canvas.getContext('2d');\n                            ctx.scale(dpr, dpr);\n                            \n                            // White background\n                            ctx.fillStyle = \"#FFFFFF\";\n                            ctx.fillRect(0, 0, width, height);\n                            \n                            // Draw the SVG image at logical size\n                            ctx.drawImage(img, 0, 0, width, height);\n                            \n                            // Debug: Check if anything was drawn\n                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n                            const pixels = imageData.data;\n                            let nonWhitePixels = 0;\n                            for (let i = 0; i < pixels.length; i += 4) {\n                                if (pixels[i] !== 255 || pixels[i+1] !== 255 || pixels[i+2] !== 255) {\n                                    nonWhitePixels++;\n                                }\n                            }\n                            console.log(`Canvas ${canvas.width}x${canvas.height}, non-white pixels: ${nonWhitePixels}/${pixels.length/4} (${(nonWhitePixels/(pixels.length/4)*100).toFixed(2)}%)`);\n                            \n                            // Clean up URL\n                            URL.revokeObjectURL(url);\n                            \n                            // Return data URL\n                            const dataUrl = canvas.toDataURL('image/png', 1.0);\n                            console.log('Generated data URL length:', dataUrl.length);\n                            resolve(dataUrl);\n                        };\n                        \n                        img.onerror = () => {\n                            URL.revokeObjectURL(url);\n                            reject(new Error('Failed to load SVG image'));\n                        };\n                        \n                        img.src = url;\n                    });\n                    \n                    // Replace math element with img tag containing the PNG data URL\n                    const imgElement = document.createElement('img');\n                    imgElement.src = dataUrl;\n                    imgElement.style.cssText = 'display:inline-block;margin:0.5em 0;vertical-align:middle;';\n                    // Set explicit dimensions for better paste behavior\n                    try {\n                        const probe = new Image();\n                        probe.src = dataUrl;\n                        await new Promise((resolve) => { probe.onload = resolve; probe.onerror = resolve; });\n                        if (probe.width && probe.height) {\n                            imgElement.width = probe.width / (window.devicePixelRatio || 1);\n                            imgElement.height = probe.height / (window.devicePixelRatio || 1);\n                            imgElement.style.width = imgElement.width + 'px';\n                            imgElement.style.height = imgElement.height + 'px';\n                        }\n                    } catch (_) {}\n                    imgElement.alt = 'Math equation';\n                    \n                    console.log('Replacing math element with image, data URL starts with:', dataUrl.substring(0, 50));\n                    mathEl.parentNode.replaceChild(imgElement, mathEl);\n                    console.log('Replacement complete, img element created');\n                } catch (error) {\n                    console.error('Failed to convert math element:', error);\n                    // Keep track of failure\n                    console.log('Math element that failed:', mathEl.innerHTML);\n                    // Mark the element so we can see it failed\n                    mathEl.style.border = '2px solid red';\n                }\n            }\n        }\n        \n        // 2. Process GeoJSON maps - convert to static images (following Gem's guide)\n        const geojsonContainers = clone.querySelectorAll('.geojson-container');\n        if (geojsonContainers.length > 0) {\n            console.log(`Processing ${geojsonContainers.length} GeoJSON containers`);\n            \n            for (const clonedContainer of geojsonContainers) {\n                try {\n                    // Find the corresponding live container by matching data-original-source\n                    const originalSource = clonedContainer.getAttribute('data-original-source');\n                    if (!originalSource) {\n                        console.warn('No original source found for GeoJSON container');\n                        continue;\n                    }\n                    \n                    // Find live container with same source\n                    let liveContainer = null;\n                    const allLiveContainers = previewPanel.querySelectorAll('.geojson-container');\n                    for (const candidate of allLiveContainers) {\n                        if (candidate.getAttribute('data-original-source') === originalSource) {\n                            liveContainer = candidate;\n                            break;\n                        }\n                    }\n                    \n                    if (!liveContainer) {\n                        console.warn('Could not find live GeoJSON container');\n                        const placeholder = document.createElement('div');\n                        placeholder.style.cssText = 'padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;';\n                        placeholder.textContent = '[GeoJSON Map - Interactive content not available in copy]';\n                        clonedContainer.parentNode.replaceChild(placeholder, clonedContainer);\n                        continue;\n                    }\n                    \n                    // Check if map is ready\n                    const map = liveContainer._map;\n                    if (!map) {\n                        console.warn('Map not initialized yet');\n                        const placeholder = document.createElement('div');\n                        placeholder.style.cssText = 'padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;';\n                        placeholder.textContent = '[GeoJSON Map - Still loading]';\n                        clonedContainer.parentNode.replaceChild(placeholder, clonedContainer);\n                        continue;\n                    }\n                    \n                    // Rasterize the map to PNG\n                    const dataUrl = await rasterizeGeoJSONMap(liveContainer);\n                    \n                    if (dataUrl) {\n                        // Replace with image\n                        const img = document.createElement('img');\n                        img.src = dataUrl;\n                        img.style.cssText = 'width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 4px; margin: 0.5em 0;';\n                        img.alt = 'GeoJSON Map';\n                        clonedContainer.parentNode.replaceChild(img, clonedContainer);\n                    } else {\n                        // Fallback placeholder\n                        const placeholder = document.createElement('div');\n                        placeholder.style.cssText = 'padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;';\n                        placeholder.textContent = '[GeoJSON Map - Interactive content not available in copy]';\n                        clonedContainer.parentNode.replaceChild(placeholder, clonedContainer);\n                    }\n                    \n                } catch (error) {\n                    console.error('Failed to process GeoJSON container:', error);\n                    // Replace with placeholder\n                    const placeholder = document.createElement('div');\n                    placeholder.style.cssText = 'padding: 12px; background-color: #f0f0f0; border: 1px solid #ccc; text-align: center; margin: 0.5em 0; border-radius: 4px;';\n                    placeholder.textContent = '[GeoJSON Map - Interactive content not available in copy]';\n                    clonedContainer.parentNode.replaceChild(placeholder, clonedContainer);\n                }\n            }\n        }\n        \n        \n        /* OLD PROCESSING REMOVED - using squibview's simpler approach above\n                    const tempDiv = document.createElement('div');\n                    tempDiv.innerHTML = svgStr;\n                    const tempSvg = tempDiv.querySelector('svg');\n                    if (tempSvg) {\n                        // Ensure SVG has the namespace\n                        if (!tempSvg.hasAttribute('xmlns')) {\n                            tempSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n                        }\n                        tempSvg.setAttribute('width', width.toString());\n                        tempSvg.setAttribute('height', height.toString());\n                        // Also set viewBox if not present\n                        if (!tempSvg.hasAttribute('viewBox')) {\n                            tempSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);\n                        }\n                        svgStr = new XMLSerializer().serializeToString(tempSvg);\n                    }\n                    \n                    // Scale math images - MathJax viewBox dimensions are very large\n                    const targetMaxWidth = 300;   // Target max width for math images  \n                    const targetMaxHeight = 100;  // Target max height for math images\n                    \n                    // Apply base scale factor for MathJax SVGs which have oversized viewBox\n                    let scaleFactor = 0.10; // Base scale as per squibview\n                    \n                    let finalWidth = width * scaleFactor;\n                    let finalHeight = height * scaleFactor;\n                    \n                    // If still too large after base scaling, scale down further\n                    if (finalWidth > targetMaxWidth || finalHeight > targetMaxHeight) {\n                        const additionalScale = Math.min(targetMaxWidth / finalWidth, targetMaxHeight / finalHeight);\n                        finalWidth *= additionalScale;\n                        finalHeight *= additionalScale;\n                    }\n                    \n                    console.log('Math scaling:', {\n                        original: { width, height },\n                        scaleFactor: scaleFactor,\n                        final: { finalWidth, finalHeight }\n                    });\n                    \n                    // Create canvas (no scaling - exactly like squibview)\n                    const canvas = document.createElement('canvas');\n                    canvas.width = finalWidth;\n                    canvas.height = finalHeight;\n                    const ctx = canvas.getContext('2d');\n                    \n                    // White background\n                    ctx.fillStyle = '#FFFFFF';\n                    ctx.fillRect(0, 0, canvas.width, canvas.height);\n                    \n                    // Try blob URL approach like squibview  \n                    const svgBlob = new Blob([svgStr], { type: \"image/svg+xml;charset=utf-8\" });\n                    const blobUrl = URL.createObjectURL(svgBlob);\n                    \n                    const img = new Image();\n                    const dataUrl = await new Promise((resolve, reject) => {\n                        img.onload = function() {\n                            console.log('SVG Image loaded:', {\n                                naturalWidth: img.naturalWidth,\n                                naturalHeight: img.naturalHeight,\n                                width: img.width,\n                                height: img.height\n                            });\n                            try {\n                                // Draw the image to fill the entire canvas\n                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n                                \n                                // Check what was drawn - sample a few pixels\n                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n                                \n                                // Count non-white pixels to see if anything was drawn\n                                let nonWhiteCount = 0;\n                                for (let i = 0; i < imageData.data.length; i += 4) {\n                                    const r = imageData.data[i];\n                                    const g = imageData.data[i + 1];\n                                    const b = imageData.data[i + 2];\n                                    if (r !== 255 || g !== 255 || b !== 255) {\n                                        nonWhiteCount++;\n                                    }\n                                }\n                                \n                                console.log('Canvas pixel analysis:', {\n                                    canvasSize: { width: canvas.width, height: canvas.height },\n                                    nonWhitePixels: nonWhiteCount,\n                                    totalPixels: imageData.data.length / 4,\n                                    percentNonWhite: (nonWhiteCount / (imageData.data.length / 4) * 100).toFixed(2) + '%'\n                                });\n                                \n                                // Clean up blob URL\n                                URL.revokeObjectURL(blobUrl);\n                                \n                                // Convert canvas to data URL\n                                const pngDataUrl = canvas.toDataURL('image/png', 1.0);\n                                resolve(pngDataUrl);\n                            } catch (e) {\n                                console.error('Error drawing MathJax SVG:', e);\n                                URL.revokeObjectURL(blobUrl);\n                                reject(e);\n                            }\n                        };\n                        \n                        img.onerror = (e) => {\n                            console.error('Failed to load MathJax SVG:', e);\n                            console.error('SVG that failed (first 500 chars):', svgStr.substring(0, 500));\n                            URL.revokeObjectURL(blobUrl);\n                            reject(new Error('Failed to load SVG'));\n                        };\n                        \n                        img.src = blobUrl;\n                    });\n                    \n                    // Replace math element with img tag\n                    const imgElement = document.createElement('img');\n                    imgElement.src = dataUrl;\n                    imgElement.width = finalWidth;\n                    imgElement.height = finalHeight;\n                    imgElement.style.width = finalWidth + 'px';\n                    imgElement.style.height = finalHeight + 'px';\n                    imgElement.style.verticalAlign = 'middle';\n                    imgElement.style.margin = '0.5em';\n                    imgElement.alt = 'Math equation';\n                    imgElement.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                    \n                    console.log('Math converted to image:', {\n                        dataUrlLength: dataUrl.length,\n                        width: finalWidth,\n                        height: finalHeight\n                    });\n                    \n                    mathEl.parentNode.replaceChild(imgElement, mathEl);\n                } catch (err) {\n                    console.warn('Failed to convert math element:', err);\n                }\n            }\n        }\n        \n        // Skip the fallback processing since we already handled all math containers above\n        /* Removed duplicate math processing\n        for (const mathEl of mathElements) {\n            try {\n                \n                // Look for SVG in the math container (in case MathJax already processed it)\n                // MathJax might have placed an mjx-container inside our container\n                let svg = mathEl.querySelector('svg');\n                if (!svg) {\n                    const mjxContainer = mathEl.querySelector('mjx-container');\n                    if (mjxContainer) {\n                        svg = mjxContainer.querySelector('svg');\n                    }\n                }\n                \n                if (svg) {\n                    // Handle SVG-based math (MathJax) - use same approach as mjx-container\n                    const serializer = new XMLSerializer();\n                    let svgStr = serializer.serializeToString(svg);\n                    \n                    // Get dimensions from SVG\n                    const widthAttr = svg.getAttribute('width');\n                    const heightAttr = svg.getAttribute('height');\n                    \n                    let width, height;\n                    \n                    // Use viewBox dimensions first (actual coordinate system)\n                    if (svg.viewBox && svg.viewBox.baseVal) {\n                        width = svg.viewBox.baseVal.width;\n                        height = svg.viewBox.baseVal.height;\n                    } else if (widthAttr && widthAttr.includes('ex')) {\n                        width = parseFloat(widthAttr) * 8; // 1ex ≈ 8px\n                        height = heightAttr ? parseFloat(heightAttr) * 8 : 50;\n                    } else if (widthAttr) {\n                        width = parseFloat(widthAttr);\n                        height = heightAttr ? parseFloat(heightAttr) : 50;\n                    } else {\n                        width = 200;\n                        height = 50;\n                    }\n                    \n                    // Ensure SVG has explicit pixel dimensions\n                    const tempDiv = document.createElement('div');\n                    tempDiv.innerHTML = svgStr;\n                    const tempSvg = tempDiv.querySelector('svg');\n                    if (tempSvg) {\n                        tempSvg.setAttribute('width', width.toString());\n                        tempSvg.setAttribute('height', height.toString());\n                        if (!tempSvg.hasAttribute('viewBox')) {\n                            tempSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);\n                        }\n                        svgStr = new XMLSerializer().serializeToString(tempSvg);\n                    }\n                            \n                    // Scale down math images (same as mjx-container approach)\n                    const targetMaxWidth = 300;\n                    const targetMaxHeight = 100;\n                    \n                    // Apply base scale factor for MathJax SVGs\n                    let scaleFactor = 0.10;\n                    \n                    let finalWidth = width * scaleFactor;\n                    let finalHeight = height * scaleFactor;\n                    \n                    // If still too large after base scaling, scale down further\n                    if (finalWidth > targetMaxWidth || finalHeight > targetMaxHeight) {\n                        const additionalScale = Math.min(targetMaxWidth / finalWidth, targetMaxHeight / finalHeight);\n                        finalWidth *= additionalScale;\n                        finalHeight *= additionalScale;\n                    }\n                    \n                    const scale = 2;\n                    \n                    const canvas = document.createElement('canvas');\n                    canvas.width = finalWidth * scale;\n                    canvas.height = finalHeight * scale;\n                    const ctx = canvas.getContext('2d');\n                    \n                    // White background (fill entire canvas)\n                    ctx.fillStyle = '#FFFFFF';\n                    ctx.fillRect(0, 0, canvas.width, canvas.height);\n                    \n                    const img = new Image();\n                    const dataUrl = await new Promise((resolve, reject) => {\n                        img.onload = function() {\n                            try {\n                                // Draw to entire canvas\n                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n                                const pngDataUrl = canvas.toDataURL('image/png', 1.0);\n                                resolve(pngDataUrl);\n                            } catch (e) {\n                                console.error('Error drawing fallback MathJax SVG:', e);\n                                reject(e);\n                            }\n                        };\n                        \n                        img.onerror = (e) => {\n                            console.error('Failed to load fallback MathJax SVG:', e);\n                            reject(new Error('Failed to load SVG'));\n                        };\n                        \n                        // Use data URL\n                        const svgDataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);\n                        img.src = svgDataUrl;\n                    });\n                    \n                    const replacementImg = document.createElement('img');\n                    replacementImg.src = dataUrl;\n                    replacementImg.style.verticalAlign = 'middle';\n                    replacementImg.style.margin = '0.5em';\n                    replacementImg.alt = 'Math equation';\n                    replacementImg.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                    \n                    mathEl.parentNode.replaceChild(replacementImg, mathEl);\n                } else {\n                    // Handle HTML-based math (KaTeX) - use html2canvas approach\n                    // For now, add inline styles to make it copy better\n                    const katexEl = mathEl.querySelector('.katex');\n                    if (katexEl) {\n                        // Add inline styles for better copying\n                        katexEl.style.fontSize = '1.21em';\n                        katexEl.style.textAlign = 'center';\n                        katexEl.style.margin = '0.5em';\n                        katexEl.style.display = 'inline-block';\n                        \n                        // Make sure all child elements have proper styles\n                        katexEl.querySelectorAll('*').forEach(el => {\n                            const computed = window.getComputedStyle(el);\n                            if (computed.fontFamily) el.style.fontFamily = computed.fontFamily;\n                            if (computed.fontSize) el.style.fontSize = computed.fontSize;\n                            if (computed.fontStyle) el.style.fontStyle = computed.fontStyle;\n                            if (computed.fontWeight) el.style.fontWeight = computed.fontWeight;\n                        });\n                    }\n                }\n                \n            } catch (error) {\n                console.error('Failed to convert math element:', error);\n            }\n        }\n        */\n        \n        // 6. Process GeoJSON/Leaflet maps - capture as single image (compose tiles + overlays)\n        const mapContainers = clone.querySelectorAll('[data-qd-lang=\"geojson\"]');\n        for (const container of mapContainers) {\n            try {\n                const containerId = container.id;\n                const originalContainer = containerId ? previewPanel.querySelector(`#${containerId}`) : null;\n                if (!originalContainer) continue;\n                const leafletContainer = originalContainer.querySelector('.leaflet-container');\n                if (!leafletContainer) continue;\n\n                const dpr = Math.max(1, window.devicePixelRatio || 1);\n                const width = leafletContainer.clientWidth || 600;\n                const height = leafletContainer.clientHeight || 400;\n                const canvas = document.createElement('canvas');\n                canvas.width = Math.round(width * dpr);\n                canvas.height = Math.round(height * dpr);\n                const ctx = canvas.getContext('2d');\n                ctx.scale(dpr, dpr);\n                ctx.fillStyle = '#FFFFFF';\n                ctx.fillRect(0, 0, width, height);\n\n                const leafRect = leafletContainer.getBoundingClientRect();\n\n                // Draw tiles (snap to integer pixels to avoid seams)\n                const tiles = Array.from(leafletContainer.querySelectorAll('img.leaflet-tile'));\n                for (const tile of tiles) {\n                    try {\n                        const r = tile.getBoundingClientRect();\n                        const x = Math.round(r.left - leafRect.left);\n                        const y = Math.round(r.top - leafRect.top);\n                        const w = Math.round(r.width);\n                        const h = Math.round(r.height);\n                        const overlaps = !(r.right <= leafRect.left || r.left >= leafRect.right || r.bottom <= leafRect.top || r.top >= leafRect.bottom);\n                        const style = window.getComputedStyle(tile);\n                        if (w > 0 && h > 0 && overlaps && style.display !== 'none' && style.visibility !== 'hidden') {\n                            ctx.drawImage(tile, x, y, w + 1, h + 1);\n                        }\n                    } catch (e) {\n                        console.warn('Failed to draw tile:', e);\n                    }\n                }\n\n                // Draw SVG overlays (paths, markers)\n                const overlaySvgs = originalContainer.querySelectorAll('.leaflet-overlay-pane svg');\n                for (const svg of overlaySvgs) {\n                    try {\n                        const svgStr = new XMLSerializer().serializeToString(svg);\n                        const dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);\n                        const img = new Image();\n                        await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; img.src = dataUrl; });\n                        const r = svg.getBoundingClientRect();\n                        const x = Math.round(r.left - leafRect.left);\n                        const y = Math.round(r.top - leafRect.top);\n                        const w = Math.round(r.width);\n                        const h = Math.round(r.height);\n                        const overlaps = !(r.right <= leafRect.left || r.left >= leafRect.right || r.bottom <= leafRect.top || r.top >= leafRect.bottom);\n                        if (w > 0 && h > 0 && overlaps) ctx.drawImage(img, x, y, w, h);\n                    } catch (e) {\n                        console.warn('Failed to draw overlay SVG:', e);\n                    }\n                }\n\n                // Draw marker icons (PNG/SVG img elements)\n                const markerIcons = originalContainer.querySelectorAll('.leaflet-marker-pane img.leaflet-marker-icon');\n                for (const icon of markerIcons) {\n                    try {\n                        const r = icon.getBoundingClientRect();\n                        const x = Math.round(r.left - leafRect.left);\n                        const y = Math.round(r.top - leafRect.top);\n                        const w = Math.round(r.width);\n                        const h = Math.round(r.height);\n                        const overlaps = !(r.right <= leafRect.left || r.left >= leafRect.right || r.bottom <= leafRect.top || r.top >= leafRect.bottom);\n                        const style = window.getComputedStyle(icon);\n                        if (w > 0 && h > 0 && overlaps && style.display !== 'none' && style.visibility !== 'hidden') {\n                            ctx.drawImage(icon, x, y, w, h);\n                        }\n                    } catch (e) {\n                        console.warn('Failed to draw marker icon:', e);\n                    }\n                }\n\n                // Try to produce a data URL (may fail if canvas tainted by CORS tiles)\n                let mapDataUrl = '';\n                try {\n                    mapDataUrl = canvas.toDataURL('image/png', 1.0);\n                } catch (e) {\n                    console.warn('Map canvas tainted; falling back to placeholder');\n                }\n\n                const img = document.createElement('img');\n                if (mapDataUrl) {\n                    img.src = mapDataUrl;\n                    img.width = width;\n                    img.height = height;\n                    img.setAttribute('width', String(width));\n                    img.setAttribute('height', String(height));\n                    img.style.width = width + 'px';\n                    img.style.height = height + 'px';\n                    img.style.display = 'block';\n                    img.style.border = '1px solid #ddd';\n                    img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                    img.alt = 'Map';\n                } else {\n                    img.alt = 'Map';\n                    img.style.width = width + 'px';\n                    img.style.height = height + 'px';\n                    img.style.border = '1px solid #ddd';\n                    img.style.backgroundColor = '#f0f0f0';\n                }\n\n                container.parentNode.replaceChild(img, container);\n            } catch (err) {\n                console.warn('Failed to process map container:', err);\n            }\n        }\n        \n        // 7. Process HTML fence blocks - render the HTML content and process images\n        const htmlContainers = clone.querySelectorAll('.qde-html-container');\n        for (const container of htmlContainers) {\n            try {\n                // Get the original source HTML\n                const source = container.getAttribute('data-qd-source');\n                \n                // Check if there's a pre element (fallback display) or actual HTML content\n                const pre = container.querySelector('pre');\n                \n                if (source) {\n                    // Parse the source HTML\n                    const tempDiv = document.createElement('div');\n                    tempDiv.innerHTML = source;\n                    \n                    // Process all images in the HTML block\n                    const htmlImages = tempDiv.querySelectorAll('img');\n                    for (const img of htmlImages) {\n                        // Preserve original dimensions from HTML attributes\n                        const widthAttr = img.getAttribute('width');\n                        const heightAttr = img.getAttribute('height');\n                        \n                        if (widthAttr) {\n                            img.width = parseInt(widthAttr);\n                            img.style.width = widthAttr.includes('%') ? widthAttr : `${img.width}px`;\n                        }\n                        if (heightAttr) {\n                            img.height = parseInt(heightAttr);\n                            img.style.height = heightAttr.includes('%') ? heightAttr : `${img.height}px`;\n                        }\n                        \n                        // Convert to data URL using canvas (like squibview)\n                        if (img.src && !img.src.startsWith('data:')) {\n                            try {\n                                // Use canvas to convert image to data URL (avoids CORS issues)\n                                const canvas = document.createElement('canvas');\n                                const ctx = canvas.getContext('2d');\n                                \n                                // Create new image and wait for it to load\n                                const tempImg = new Image();\n                                tempImg.crossOrigin = 'anonymous';\n                                \n                                await new Promise((resolve, reject) => {\n                                    tempImg.onload = function() {\n                                        console.log('HTML fence image loaded:', {\n                                            naturalWidth: tempImg.naturalWidth,\n                                            naturalHeight: tempImg.naturalHeight,\n                                            imgWidth: img.width,\n                                            imgHeight: img.height,\n                                            widthAttr: widthAttr,\n                                            heightAttr: heightAttr\n                                        });\n                                        \n                                        // Calculate dimensions preserving aspect ratio\n                                        let displayWidth = 0;\n                                        let displayHeight = 0;\n                                        \n                                        // Use the width specified in HTML (e.g. width=\"250\")\n                                        if (widthAttr && !widthAttr.includes('%')) {\n                                            displayWidth = parseInt(widthAttr);\n                                        }\n                                        \n                                        // Use the height if specified\n                                        if (heightAttr && !heightAttr.includes('%')) {\n                                            displayHeight = parseInt(heightAttr);\n                                        }\n                                        \n                                        console.log('Parsed dimensions from HTML:', { displayWidth, displayHeight });\n                                        \n                                        // If only width is specified, calculate height based on aspect ratio\n                                        if (displayWidth > 0 && displayHeight === 0) {\n                                            if (tempImg.naturalWidth > 0) {\n                                                const aspectRatio = tempImg.naturalHeight / tempImg.naturalWidth;\n                                                displayHeight = Math.round(displayWidth * aspectRatio);\n                                                console.log('Calculated height from aspect ratio:', displayHeight);\n                                            }\n                                        }\n                                        // If only height is specified, calculate width based on aspect ratio\n                                        else if (displayHeight > 0 && displayWidth === 0) {\n                                            if (tempImg.naturalHeight > 0) {\n                                                const aspectRatio = tempImg.naturalWidth / tempImg.naturalHeight;\n                                                displayWidth = Math.round(displayHeight * aspectRatio);\n                                                console.log('Calculated width from aspect ratio:', displayWidth);\n                                            }\n                                        }\n                                        // If neither specified, use natural dimensions\n                                        else if (displayWidth === 0 && displayHeight === 0) {\n                                            displayWidth = tempImg.naturalWidth || 250;\n                                            displayHeight = tempImg.naturalHeight || 200;\n                                            console.log('Using natural dimensions');\n                                        }\n                                        \n                                        console.log('Final dimensions for canvas:', { displayWidth, displayHeight });\n                                        \n                                        canvas.width = displayWidth;\n                                        canvas.height = displayHeight;\n                                        \n                                        // Draw image to canvas\n                                        ctx.drawImage(tempImg, 0, 0, displayWidth, displayHeight);\n                                        \n                                        // Convert to data URL\n                                        const dataUrl = canvas.toDataURL('image/png', 1.0);\n                                        \n                                        // Update original image\n                                        img.src = dataUrl;\n                                        img.width = displayWidth;\n                                        img.height = displayHeight;\n                                        img.setAttribute('width', displayWidth.toString());\n                                        img.setAttribute('height', displayHeight.toString());\n                                        img.style.width = displayWidth + 'px';\n                                        img.style.height = displayHeight + 'px';\n                                        \n                                        resolve();\n                                    };\n                                    \n                                    tempImg.onerror = function() {\n                                        console.warn('Failed to load HTML fence image:', img.src);\n                                        reject(new Error('Image load failed'));\n                                    };\n                                    \n                                    // Set source - resolve relative paths\n                                    if (img.src.startsWith('http') || img.src.startsWith('//')) {\n                                        tempImg.src = img.src;\n                                    } else {\n                                        // Relative path - let browser resolve it\n                                        const absoluteImg = new Image();\n                                        absoluteImg.src = img.src;\n                                        tempImg.src = absoluteImg.src;\n                                    }\n                                });\n                            } catch (err) {\n                                console.warn('Failed to convert HTML fence image:', img.src, err);\n                            }\n                        }\n                        \n                        // Add v:shapes for Word compatibility\n                        img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                    }\n                    \n                    // Replace container content with processed HTML (whether it had pre or not)\n                    container.innerHTML = tempDiv.innerHTML;\n                } else if (!pre) {\n                    // Container has rendered HTML already, process its images directly\n                    const htmlImages = container.querySelectorAll('img');\n                    for (const img of htmlImages) {\n                        // Same image processing as above\n                        const widthAttr = img.getAttribute('width');\n                        const heightAttr = img.getAttribute('height');\n                        \n                        if (widthAttr) {\n                            img.width = parseInt(widthAttr);\n                            img.style.width = widthAttr.includes('%') ? widthAttr : `${img.width}px`;\n                        }\n                        if (heightAttr) {\n                            img.height = parseInt(heightAttr);\n                            img.style.height = heightAttr.includes('%') ? heightAttr : `${img.height}px`;\n                        }\n                        \n                        if (img.src && !img.src.startsWith('data:')) {\n                            try {\n                                // Use same canvas approach as above\n                                const canvas = document.createElement('canvas');\n                                const ctx = canvas.getContext('2d');\n                                const tempImg = new Image();\n                                tempImg.crossOrigin = 'anonymous';\n                                \n                                await new Promise((resolve, reject) => {\n                                    tempImg.onload = function() {\n                                        // Calculate dimensions preserving aspect ratio\n                                        let displayWidth = img.width || 0;\n                                        let displayHeight = img.height || 0;\n                                        \n                                        // If only width is specified, calculate height based on aspect ratio\n                                        if (displayWidth && !displayHeight) {\n                                            const aspectRatio = tempImg.naturalHeight / tempImg.naturalWidth;\n                                            displayHeight = Math.round(displayWidth * aspectRatio);\n                                        }\n                                        // If only height is specified, calculate width based on aspect ratio\n                                        else if (displayHeight && !displayWidth) {\n                                            const aspectRatio = tempImg.naturalWidth / tempImg.naturalHeight;\n                                            displayWidth = Math.round(displayHeight * aspectRatio);\n                                        }\n                                        // If neither specified, use natural dimensions\n                                        else if (!displayWidth && !displayHeight) {\n                                            displayWidth = tempImg.naturalWidth || 250;\n                                            displayHeight = tempImg.naturalHeight || Math.round(250 * (tempImg.naturalHeight / tempImg.naturalWidth));\n                                        }\n                                        \n                                        canvas.width = displayWidth;\n                                        canvas.height = displayHeight;\n                                        ctx.drawImage(tempImg, 0, 0, displayWidth, displayHeight);\n                                        \n                                        const dataUrl = canvas.toDataURL('image/png', 1.0);\n                                        img.src = dataUrl;\n                                        img.width = displayWidth;\n                                        img.height = displayHeight;\n                                        img.setAttribute('width', displayWidth.toString());\n                                        img.setAttribute('height', displayHeight.toString());\n                                        img.style.width = displayWidth + 'px';\n                                        img.style.height = displayHeight + 'px';\n                                        \n                                        resolve();\n                                    };\n                                    \n                                    tempImg.onerror = function() {\n                                        console.warn('Failed to load HTML fence image:', img.src);\n                                        reject(new Error('Image load failed'));\n                                    };\n                                    \n                                    if (img.src.startsWith('http') || img.src.startsWith('//')) {\n                                        tempImg.src = img.src;\n                                    } else {\n                                        const absoluteImg = new Image();\n                                        absoluteImg.src = img.src;\n                                        tempImg.src = absoluteImg.src;\n                                    }\n                                });\n                            } catch (err) {\n                                console.warn('Failed to convert HTML fence image:', img.src, err);\n                            }\n                        }\n                        \n                        img.setAttribute('v:shapes', 'image' + Math.random().toString(36).substr(2, 9));\n                    }\n                }\n            } catch (err) {\n                console.warn('Failed to process HTML container:', err);\n            }\n        }\n        \n        // 8. Tables are already HTML tables from the built-in renderer\n        // No processing needed\n        \n        // Wrap in proper HTML structure for rich text editors\n        const fragment = clone.innerHTML;\n        const htmlContent = `\n            <!DOCTYPE html>\n            <html xmlns:v=\"urn:schemas-microsoft-com:vml\"\n                  xmlns:o=\"urn:schemas-microsoft-com:office:office\"\n                  xmlns:w=\"urn:schemas-microsoft-com:office:word\">\n              <head>\n                <meta charset=\"utf-8\">\n                <style>\n                  /* Table styling */\n                  table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }\n                  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }\n                  th { background-color: #f0f0f0; font-weight: bold; }\n                  \n                  /* Code block styling */\n                  pre { background-color: #f4f4f4; padding: 1em; border-radius: 4px; overflow-x: auto; }\n                  code { font-family: monospace; background-color: #f4f4f4; padding: 0.2em 0.4em; border-radius: 3px; }\n                  \n                  /* Image handling */\n                  img { display: block; max-width: 100%; height: auto; margin: 0.5em 0; }\n                  \n                  /* Blockquote */\n                  blockquote { border-left: 4px solid #ddd; margin-left: 0; padding-left: 1em; color: #666; }\n                  \n                  /* Math equations centered like squibview */\n                  .math-display { text-align: center; margin: 1em 0; }\n                  .math-display img { display: inline-block; margin: 0 auto; }\n                </style>\n              </head>\n              <body><!--StartFragment-->${fragment}<!--EndFragment--></body>\n            </html>`;\n        \n        // Get plain text version\n        const text = clone.textContent || clone.innerText || '';\n        \n        // Get platform for clipboard strategy (like squibview)\n        const platform = getPlatform();\n        \n        if (platform === 'macos') {\n            // macOS approach (like squibview)\n            try {\n                await navigator.clipboard.write([\n                    new ClipboardItem({\n                        'text/html': new Blob([htmlContent], { type: 'text/html' }),\n                        'text/plain': new Blob([text], { type: 'text/plain' })\n                    })\n                ]);\n                return { success: true, html: htmlContent, text };\n            } catch (modernErr) {\n                console.warn('Modern clipboard API failed, trying Safari fallback:', modernErr);\n                // Safari fallback (selection-based HTML of fragment)\n                if (copyToClipboard(fragment)) {\n                    return { success: true, html: htmlContent, text };\n                }\n                throw new Error('Fallback copy failed');\n            }\n        } else {\n            // Windows/Linux approach (like squibview)\n            const tempDiv = document.createElement('div');\n            tempDiv.style.position = 'fixed';\n            tempDiv.style.left = '-9999px';\n            tempDiv.style.top = '0';\n            // Use fragment for selection-based fallback copy\n            tempDiv.innerHTML = fragment;\n            document.body.appendChild(tempDiv);\n            \n            try {\n                await navigator.clipboard.write([\n                    new ClipboardItem({\n                        'text/html': new Blob([htmlContent], { type: 'text/html' }),\n                        'text/plain': new Blob([text], { type: 'text/plain' })\n                    })\n                ]);\n                return { success: true, html: htmlContent, text };\n            } catch (modernErr) {\n                console.warn('Modern clipboard API failed, trying execCommand fallback:', modernErr);\n                const selection = window.getSelection();\n                const range = document.createRange();\n                range.selectNodeContents(tempDiv);\n                selection.removeAllRanges();\n                selection.addRange(range);\n                \n                const successful = document.execCommand('copy');\n                if (!successful) {\n                    throw new Error('Fallback copy failed');\n                }\n                return { success: true, html: htmlContent, text };\n            } finally {\n                if (tempDiv && tempDiv.parentNode) {\n                    document.body.removeChild(tempDiv);\n                }\n            }\n        }\n        \n    } catch (err) {\n        console.error('Failed to copy rendered content:', err);\n        throw err;\n    }\n}\n\n","/**\n * Quikdown Editor - A drop-in markdown editor control\n * @version 1.0.5\n * @license BSD-2-Clause\n */\n\nimport quikdown_bd from './quikdown_bd.js';\nimport { getRenderedContent } from './quikdown_edit_copy.js';\n\n// Default options\nconst DEFAULT_OPTIONS = {\n    mode: 'split',          // 'source' | 'preview' | 'split'\n    showToolbar: true,\n    showRemoveHR: false,    // Show button to remove horizontal rules (---) \n    theme: 'auto',          // 'light' | 'dark' | 'auto'\n    lazy_linefeeds: false,\n    inline_styles: false,   // Use CSS classes (false) or inline styles (true)\n    debounceDelay: 20,      // Reduced from 100ms for better responsiveness\n    placeholder: 'Start typing markdown...',\n    plugins: {\n        highlightjs: false,\n        mermaid: false\n    },\n    customFences: {}, // { 'language': (code, lang) => html }\n    enableComplexFences: true // Enable CSV tables, math rendering, SVG, etc.\n};\n\n/**\n * Quikdown Editor - A complete markdown editing solution\n */\nclass QuikdownEditor {\n    constructor(container, options = {}) {\n        // Resolve container\n        this.container = typeof container === 'string' \n            ? document.querySelector(container) \n            : container;\n            \n        if (!this.container) {\n            throw new Error('QuikdownEditor: Invalid container');\n        }\n        \n        // Merge options\n        this.options = { ...DEFAULT_OPTIONS, ...options };\n        \n        // State\n        this._markdown = '';\n        this._html = '';\n        this.currentMode = this.options.mode;\n        this.updateTimer = null;\n        \n        // Initialize\n        this.initPromise = this.init();\n    }\n    \n    /**\n     * Initialize the editor\n     */\n    async init() {\n        // Load plugins if requested\n        await this.loadPlugins();\n        \n        // Build UI\n        this.buildUI();\n        \n        // Attach event listeners\n        this.attachEvents();\n        \n        // Apply initial theme\n        this.applyTheme();\n        \n        // Set initial mode\n        this.setMode(this.currentMode);\n        \n        // Set initial content if provided\n        if (this.options.initialContent) {\n            this.setMarkdown(this.options.initialContent);\n        }\n    }\n    \n    /**\n     * Build the editor UI\n     */\n    buildUI() {\n        // Clear container\n        this.container.innerHTML = '';\n        \n        // Add editor class\n        this.container.classList.add('qde-container');\n        \n        // Create toolbar if enabled\n        if (this.options.showToolbar) {\n            this.toolbar = this.createToolbar();\n            this.container.appendChild(this.toolbar);\n        }\n        \n        // Create editor area\n        this.editorArea = document.createElement('div');\n        this.editorArea.className = 'qde-editor';\n        \n        // Create source panel\n        this.sourcePanel = document.createElement('div');\n        this.sourcePanel.className = 'qde-source';\n        \n        this.sourceTextarea = document.createElement('textarea');\n        this.sourceTextarea.className = 'qde-textarea';\n        this.sourceTextarea.placeholder = this.options.placeholder;\n        this.sourcePanel.appendChild(this.sourceTextarea);\n        \n        // Create preview panel\n        this.previewPanel = document.createElement('div');\n        this.previewPanel.className = 'qde-preview';\n        this.previewPanel.contentEditable = true;\n        \n        // Add panels to editor\n        this.editorArea.appendChild(this.sourcePanel);\n        this.editorArea.appendChild(this.previewPanel);\n        this.container.appendChild(this.editorArea);\n        \n        // Add built-in styles if not already present\n        this.injectStyles();\n    }\n    \n    /**\n     * Create toolbar\n     */\n    createToolbar() {\n        const toolbar = document.createElement('div');\n        toolbar.className = 'qde-toolbar';\n        \n        // Mode buttons\n        const modes = ['source', 'split', 'preview'];\n        const modeLabels = { source: 'Source', split: 'Split', preview: 'Rendered' };\n        modes.forEach(mode => {\n            const btn = document.createElement('button');\n            btn.className = 'qde-btn';\n            btn.dataset.mode = mode;\n            btn.textContent = modeLabels[mode];\n            btn.title = `Switch to ${modeLabels[mode]} view`;\n            toolbar.appendChild(btn);\n        });\n        \n        // Spacer\n        const spacer = document.createElement('span');\n        spacer.className = 'qde-spacer';\n        toolbar.appendChild(spacer);\n        \n        // Copy buttons\n        const copyButtons = [\n            { action: 'copy-markdown', text: 'Copy MD', title: 'Copy markdown to clipboard' },\n            { action: 'copy-html', text: 'Copy HTML', title: 'Copy HTML to clipboard' },\n            { action: 'copy-rendered', text: 'Copy Rendered', title: 'Copy rich text to clipboard' }\n        ];\n        \n        copyButtons.forEach(({ action, text, title }) => {\n            const btn = document.createElement('button');\n            btn.className = 'qde-btn';\n            btn.dataset.action = action;\n            btn.textContent = text;\n            btn.title = title;\n            toolbar.appendChild(btn);\n        });\n        \n        // Remove HR button (if enabled)\n        if (this.options.showRemoveHR) {\n            const removeHRBtn = document.createElement('button');\n            removeHRBtn.className = 'qde-btn';\n            removeHRBtn.dataset.action = 'remove-hr';\n            removeHRBtn.textContent = 'Remove HR';\n            removeHRBtn.title = 'Remove all horizontal rules (---) from markdown';\n            toolbar.appendChild(removeHRBtn);\n        }\n        \n        return toolbar;\n    }\n    \n    /**\n     * Inject built-in styles\n     */\n    injectStyles() {\n        if (document.getElementById('qde-styles')) return;\n        \n        const style = document.createElement('style');\n        style.id = 'qde-styles';\n        style.textContent = `\n            .qde-container {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n                border: 1px solid #ddd;\n                border-radius: 4px;\n                overflow: hidden;\n                background: white;\n            }\n            \n            .qde-toolbar {\n                display: flex;\n                align-items: center;\n                padding: 8px;\n                background: #f5f5f5;\n                border-bottom: 1px solid #ddd;\n                gap: 4px;\n            }\n            \n            .qde-btn {\n                padding: 6px 12px;\n                border: 1px solid #ccc;\n                background: white;\n                border-radius: 3px;\n                cursor: pointer;\n                font-size: 14px;\n                transition: all 0.2s;\n            }\n            \n            .qde-btn:hover {\n                background: #e9e9e9;\n                border-color: #999;\n            }\n            \n            .qde-btn.active {\n                background: #007bff;\n                color: white;\n                border-color: #0056b3;\n            }\n            \n            .qde-spacer {\n                flex: 1;\n            }\n            \n            .qde-editor {\n                display: flex;\n                flex: 1;\n                overflow: hidden;\n            }\n            \n            .qde-source, .qde-preview {\n                flex: 1;\n                overflow: auto;\n                padding: 16px;\n            }\n            \n            .qde-source {\n                border-right: 1px solid #ddd;\n            }\n            \n            .qde-textarea {\n                width: 100%;\n                height: 100%;\n                border: none;\n                outline: none;\n                resize: none;\n                font-family: 'Monaco', 'Courier New', monospace;\n                font-size: 14px;\n                line-height: 1.5;\n            }\n            \n            .qde-preview {\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                font-size: 16px;\n                line-height: 1.6;\n                outline: none;\n                cursor: text;  /* Standard text cursor */\n            }\n            \n            /* Fence-specific styles */\n            .qde-svg-container {\n                max-width: 100%;\n                overflow: auto;\n            }\n            \n            .qde-svg-container svg {\n                max-width: 100%;\n                height: auto;\n            }\n            \n            .qde-html-container {\n                /* HTML containers inherit background */\n                margin: 12px 0;\n            }\n            \n            .qde-math-container {\n                text-align: center;\n                margin: 16px 0;\n                overflow-x: auto;\n            }\n            \n            /* All tables in preview (both regular markdown and CSV) */\n            .qde-preview table {\n                width: 100%;\n                border-collapse: collapse;\n                margin: 12px 0;\n                font-size: 14px;\n            }\n            \n            .qde-preview table th,\n            .qde-preview table td {\n                border: 1px solid #ddd;\n                padding: 8px;\n            }\n            \n            /* Support for alignment classes from quikdown */\n            .qde-preview .quikdown-left { text-align: left; }\n            .qde-preview .quikdown-center { text-align: center; }\n            .qde-preview .quikdown-right { text-align: right; }\n            \n            .qde-preview table th {\n                background: #f5f5f5;\n                font-weight: bold;\n            }\n            \n            .qde-preview table tr:nth-child(even) {\n                background: #f9f9f9;\n            }\n            \n            /* Specific to CSV-generated tables */\n            .qde-data-table {\n                /* Can add specific CSV table styles here if needed */\n            }\n            \n            .qde-json {\n                /* Let highlight.js handle styling */\n                overflow-x: auto;\n            }\n            \n            .qde-error {\n                background: #fee;\n                border: 1px solid #fcc;\n                color: #c00;\n                padding: 8px;\n                border-radius: 4px;\n                font-family: monospace;\n                font-size: 12px;\n            }\n            \n            /* Read-only complex fence blocks in preview */\n            .qde-preview [contenteditable=\"false\"] {\n                cursor: auto;  /* Use automatic cursor (arrow for non-text) */\n                user-select: text;\n                position: relative;\n            }\n            \n            /* Ensure proper cursor for editable text elements */\n            .qde-preview p,\n            .qde-preview h1,\n            .qde-preview h2,\n            .qde-preview h3,\n            .qde-preview h4,\n            .qde-preview h5,\n            .qde-preview h6,\n            .qde-preview li,\n            .qde-preview td,\n            .qde-preview th,\n            .qde-preview blockquote,\n            .qde-preview pre[contenteditable=\"true\"],\n            .qde-preview code[contenteditable=\"true\"] {\n                cursor: text;\n            }\n            \n            \n            /* Non-editable complex renderers */\n            .qde-preview .qde-svg-container[contenteditable=\"false\"],\n            .qde-preview .qde-html-container[contenteditable=\"false\"],\n            .qde-preview .qde-math-container[contenteditable=\"false\"],\n            .qde-preview .mermaid[contenteditable=\"false\"] {\n                opacity: 0.98;\n            }\n            \n            /* Subtle hover effect for read-only blocks */\n            .qde-preview [contenteditable=\"false\"]:hover::after {\n                content: \"Read-only\";\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                font-size: 10px;\n                color: #999;\n                background: rgba(255, 255, 255, 0.9);\n                padding: 2px 4px;\n                border-radius: 2px;\n                pointer-events: none;\n            }\n            \n            /* Fix list padding in preview */\n            .qde-preview ul,\n            .qde-preview ol {\n                padding-left: 2em;\n                margin: 0.5em 0;\n            }\n            \n            .qde-preview li {\n                margin: 0.25em 0;\n            }\n            \n            /* Mode-specific visibility */\n            .qde-mode-source .qde-preview { display: none; }\n            .qde-mode-source .qde-source { border-right: none; }\n            .qde-mode-preview .qde-source { display: none; }\n            .qde-mode-split .qde-source,\n            .qde-mode-split .qde-preview { display: block; }\n            \n            /* Dark theme */\n            .qde-dark {\n                background: #1e1e1e;\n                color: #e0e0e0;\n            }\n            \n            .qde-dark .qde-toolbar {\n                background: #2d2d2d;\n                border-color: #444;\n            }\n            \n            .qde-dark .qde-btn {\n                background: #3a3a3a;\n                color: #e0e0e0;\n                border-color: #555;\n            }\n            \n            .qde-dark .qde-btn:hover {\n                background: #4a4a4a;\n            }\n            \n            .qde-dark .qde-source {\n                border-color: #444;\n            }\n            \n            .qde-dark .qde-textarea {\n                background: #1e1e1e;\n                color: #e0e0e0;\n            }\n            \n            .qde-dark .qde-preview {\n                background: #1e1e1e;\n                color: #e0e0e0;\n            }\n            \n            /* Dark mode table styles */\n            .qde-dark .qde-preview table th,\n            .qde-dark .qde-preview table td {\n                border-color: #3a3a3a;\n            }\n            \n            .qde-dark .qde-preview table th {\n                background: #2d2d2d;\n            }\n            \n            .qde-dark .qde-preview table tr:nth-child(even) {\n                background: #252525;\n            }\n            \n            /* Mobile responsive */\n            @media (max-width: 768px) {\n                .qde-mode-split .qde-editor {\n                    flex-direction: column;\n                }\n                \n                .qde-mode-split .qde-source {\n                    border-right: none;\n                    border-bottom: 1px solid #ddd;\n                }\n            }\n        `;\n        \n        document.head.appendChild(style);\n    }\n    \n    /**\n     * Attach event listeners\n     */\n    attachEvents() {\n        // Source textarea input\n        this.sourceTextarea.addEventListener('input', () => {\n            this.handleSourceInput();\n        });\n        \n        // Preview contenteditable input\n        this.previewPanel.addEventListener('input', () => {\n            this.handlePreviewInput();\n        });\n        \n        // Toolbar buttons\n        if (this.toolbar) {\n            this.toolbar.addEventListener('click', (e) => {\n                const btn = e.target.closest('.qde-btn');\n                if (!btn) return;\n                \n                if (btn.dataset.mode) {\n                    this.setMode(btn.dataset.mode);\n                } else if (btn.dataset.action) {\n                    this.handleAction(btn.dataset.action);\n                }\n            });\n        }\n        \n        // Keyboard shortcuts\n        document.addEventListener('keydown', (e) => {\n            if (e.ctrlKey || e.metaKey) {\n                switch(e.key) {\n                    case '1':\n                        e.preventDefault();\n                        this.setMode('source');\n                        break;\n                    case '2':\n                        e.preventDefault();\n                        this.setMode('split');\n                        break;\n                    case '3':\n                        e.preventDefault();\n                        this.setMode('preview');\n                        break;\n                }\n            }\n        });\n    }\n    \n    /**\n     * Handle source textarea input\n     */\n    handleSourceInput() {\n        clearTimeout(this.updateTimer);\n        this.updateTimer = setTimeout(() => {\n            this.updateFromMarkdown(this.sourceTextarea.value);\n        }, this.options.debounceDelay);\n    }\n    \n    /**\n     * Handle preview panel input\n     */\n    handlePreviewInput() {\n        clearTimeout(this.updateTimer);\n        this.updateTimer = setTimeout(() => {\n            this.updateFromHTML();\n        }, this.options.debounceDelay);\n    }\n    \n    /**\n     * Update from markdown source\n     */\n    updateFromMarkdown(markdown) {\n        this._markdown = markdown || '';\n        \n        // Show placeholder if empty\n        if (!this._markdown.trim()) {\n            this._html = '';\n            if (this.currentMode !== 'source') {\n                this.previewPanel.innerHTML = '<div style=\"color: #999; font-style: italic; padding: 16px;\">Start typing markdown in the source panel...</div>';\n            }\n        } else {\n            this._html = quikdown_bd(markdown, {\n                fence_plugin: this.createFencePlugin(),\n                lazy_linefeeds: this.options.lazy_linefeeds,\n                inline_styles: this.options.inline_styles\n            });\n            \n            // Update preview if visible\n            if (this.currentMode !== 'source') {\n                this.previewPanel.innerHTML = this._html;\n                // Make all fence blocks non-editable\n                this.makeFencesNonEditable();\n                \n                // Process all math elements with MathJax if loaded (like squibview)\n                if (window.MathJax && window.MathJax.typesetPromise) {\n                    const mathElements = this.previewPanel.querySelectorAll('.math-display');\n                    console.log('Found math elements to process:', mathElements.length);\n                    if (mathElements.length > 0) {\n                        mathElements.forEach(el => {\n                            console.log('Processing math element:', {\n                                id: el.id,\n                                content: el.textContent,\n                                hasInnerHTML: !!el.innerHTML\n                            });\n                        });\n                        window.MathJax.typesetPromise(Array.from(mathElements))\n                            .then(() => {\n                                console.log('MathJax typesetting completed');\n                                mathElements.forEach(el => {\n                                    const mjxContainer = el.querySelector('mjx-container');\n                                    console.log('After typesetting:', {\n                                        id: el.id,\n                                        hasMjxContainer: !!mjxContainer,\n                                        hasSVG: !!el.querySelector('svg')\n                                    });\n                                });\n                            })\n                            .catch(err => {\n                                console.warn('MathJax batch processing failed:', err);\n                            });\n                    }\n                }\n            }\n        }\n        \n        // Trigger change event\n        if (this.options.onChange) {\n            this.options.onChange(this._markdown, this._html);\n        }\n    }\n    \n    /**\n     * Update from HTML preview\n     */\n    updateFromHTML() {\n        // Clone the preview panel to avoid modifying the actual DOM\n        const clonedPanel = this.previewPanel.cloneNode(true);\n        \n        // Pre-process special elements on the clone\n        this.preprocessSpecialElements(clonedPanel);\n        \n        this._html = this.previewPanel.innerHTML;\n        this._markdown = quikdown_bd.toMarkdown(clonedPanel, {\n            fence_plugin: this.createFencePlugin()\n        });\n        \n        // Update source if visible\n        if (this.currentMode !== 'preview') {\n            this.sourceTextarea.value = this._markdown;\n        }\n        \n        // Trigger change event\n        if (this.options.onChange) {\n            this.options.onChange(this._markdown, this._html);\n        }\n    }\n    \n    /**\n     * Pre-process special elements before markdown conversion\n     */\n    preprocessSpecialElements(panel) {\n        if (!panel) return;\n        \n        // Restore non-editable complex fences from their data attributes\n        const complexFences = panel.querySelectorAll('[contenteditable=\"false\"][data-qd-source]');\n        complexFences.forEach(element => {\n            const source = element.getAttribute('data-qd-source');\n            const fence = element.getAttribute('data-qd-fence') || '```';\n            const lang = element.getAttribute('data-qd-lang') || '';\n            \n            // Create a pre element with the original source\n            const pre = document.createElement('pre');\n            pre.setAttribute('data-qd-fence', fence);\n            if (lang) pre.setAttribute('data-qd-lang', lang);\n            const code = document.createElement('code');\n            // The source is already the original unescaped content when using setAttribute\n            // No need to unescape since browser handles it automatically\n            code.textContent = source;\n            pre.appendChild(code);\n            \n            // Replace the complex element with pre\n            element.parentNode.replaceChild(pre, element);\n        });\n        \n        // Convert CSV tables back to CSV fence blocks (these ARE editable)\n        const csvTables = panel.querySelectorAll('table.qde-csv-table[data-qd-lang]');\n        csvTables.forEach(table => {\n            const lang = table.getAttribute('data-qd-lang');\n            if (!lang || !['csv', 'psv', 'tsv'].includes(lang)) return;\n            \n            const delimiter = lang === 'csv' ? ',' : lang === 'psv' ? '|' : '\\t';\n            \n            // Extract data from table\n            let csv = '';\n            \n            // Get headers\n            const headers = [];\n            const headerCells = table.querySelectorAll('thead th');\n            headerCells.forEach(th => {\n                const text = th.textContent.trim();\n                // Quote if contains delimiter or quotes\n                const needsQuoting = text.includes(delimiter) || text.includes('\"') || text.includes('\\n');\n                headers.push(needsQuoting ? `\"${text.replace(/\"/g, '\"\"')}\"` : text);\n            });\n            csv += headers.join(delimiter) + '\\n';\n            \n            // Get rows\n            const rows = table.querySelectorAll('tbody tr');\n            rows.forEach(tr => {\n                const cells = [];\n                tr.querySelectorAll('td').forEach(td => {\n                    const text = td.textContent.trim();\n                    const needsQuoting = text.includes(delimiter) || text.includes('\"') || text.includes('\\n');\n                    cells.push(needsQuoting ? `\"${text.replace(/\"/g, '\"\"')}\"` : text);\n                });\n                csv += cells.join(delimiter) + '\\n';\n            });\n            \n            // Create a pre element with the CSV data\n            const pre = document.createElement('pre');\n            pre.setAttribute('data-qd-fence', '```');\n            pre.setAttribute('data-qd-lang', lang);\n            const code = document.createElement('code');\n            code.textContent = csv.trim();\n            pre.appendChild(code);\n            \n            // Replace table with pre\n            table.parentNode.replaceChild(pre, table);\n        });\n    }\n    \n    /**\n     * Create fence plugin for syntax highlighting\n     */\n    createFencePlugin() {\n        const render = (code, lang) => {\n            // Check custom fences first (they take precedence)\n            if (this.options.customFences && this.options.customFences[lang]) {\n                try {\n                    return this.options.customFences[lang](code, lang);\n                } catch (err) {\n                    console.error(`Custom fence plugin error for ${lang}:`, err);\n                    return `<pre><code class=\"language-${lang}\">${this.escapeHtml(code)}</code></pre>`;\n                }\n            }\n            \n            // For bidirectional editing, only apply syntax highlighting\n            // Skip complex transformations that break round-trip conversion\n            const skipComplexRendering = !this.options.enableComplexFences;\n            \n            if (!skipComplexRendering) {\n                // Built-in lazy loading fence handlers (disabled for now)\n                switch(lang) {\n                    case 'svg':\n                        return this.renderSVG(code);\n                        \n                    case 'html':\n                        return this.renderHTML(code);\n                        \n                    case 'math':\n                    case 'katex':\n                    case 'tex':\n                    case 'latex':\n                        return this.renderMath(code, lang);\n                        \n                    case 'csv':\n                    case 'psv':\n                    case 'tsv':\n                        return this.renderTable(code, lang);\n                        \n                    case 'json':\n                    case 'json5':\n                        return this.renderJSON(code, lang);\n                        \n                    case 'mermaid':\n                        if (window.mermaid) {\n                            return this.renderMermaid(code);\n                        }\n                        break;\n                        \n                    case 'geojson':\n                        return this.renderGeoJSON(code);\n                        \n                    case 'stl':\n                        return this.renderSTL(code);\n                }\n            }\n            \n            // Syntax highlighting support - keep editable for bidirectional\n            if (window.hljs && lang && hljs.getLanguage(lang)) {\n                const highlighted = hljs.highlight(code, { language: lang }).value;\n                // Don't add contenteditable=\"false\" - the bidirectional system can extract text from the highlighted code\n                return `<pre data-qd-fence=\"\\`\\`\\`\" data-qd-lang=\"${lang}\"><code class=\"hljs language-${lang}\">${highlighted}</code></pre>`;\n            }\n            \n            // Default: let quikdown handle it\n            return undefined;\n        };\n        \n        // Reverse function to extract raw source from rendered HTML\n        const reverse = (element) => {\n            // Get the language from data attribute\n            const lang = element.getAttribute('data-qd-lang') || '';\n            let content = '';\n            \n            // For syntax-highlighted code, extract the raw text\n            if (element.querySelector('code.hljs')) {\n                const code = element.querySelector('code.hljs');\n                content = code.textContent || code.innerText || '';\n            }\n            // For other code blocks, just get the text content\n            else if (element.querySelector('code')) {\n                const codeEl = element.querySelector('code');\n                content = codeEl.textContent || codeEl.innerText || '';\n            }\n            // Fallback to element text\n            else {\n                content = element.textContent || element.innerText || '';\n            }\n            \n            // Return in the format quikdown_bd expects\n            return {\n                content: content,\n                lang: lang,\n                fence: '```'\n            };\n        };\n        \n        // Return object format for v1.1.0 API with both render and reverse\n        return { render, reverse };\n    }\n    \n    /**\n     * Render SVG content\n     */\n    renderSVG(code) {\n        try {\n            // Basic SVG validation\n            const parser = new DOMParser();\n            const doc = parser.parseFromString(code, 'image/svg+xml');\n            const parseError = doc.querySelector('parsererror');\n            \n            if (parseError) {\n                throw new Error('Invalid SVG');\n            }\n            \n            // Sanitize SVG by removing script tags and event handlers\n            const svg = doc.documentElement;\n            svg.querySelectorAll('script').forEach(el => el.remove());\n            \n            // Remove event handlers\n            const walker = document.createTreeWalker(svg, NodeFilter.SHOW_ELEMENT);\n            let node;\n            while (node = walker.nextNode()) {\n                for (let i = node.attributes.length - 1; i >= 0; i--) {\n                    const attr = node.attributes[i];\n                    if (attr.name.startsWith('on') || attr.value.includes('javascript:')) {\n                        node.removeAttribute(attr.name);\n                    }\n                }\n            }\n            \n            // Create container element programmatically to avoid attribute escaping issues\n            const container = document.createElement('div');\n            container.className = 'qde-svg-container';\n            container.contentEditable = 'false';\n            container.setAttribute('data-qd-fence', '```');\n            container.setAttribute('data-qd-lang', 'svg');\n            container.setAttribute('data-qd-source', code);  // No escaping needed when using setAttribute!\n            container.innerHTML = new XMLSerializer().serializeToString(svg);\n            \n            // Return the HTML string\n            return container.outerHTML;\n        } catch (err) {\n            const errorContainer = document.createElement('pre');\n            errorContainer.className = 'qde-error';\n            errorContainer.contentEditable = 'false';\n            errorContainer.setAttribute('data-qd-fence', '```');\n            errorContainer.setAttribute('data-qd-lang', 'svg');\n            errorContainer.textContent = `Invalid SVG: ${err.message}`;\n            return errorContainer.outerHTML;\n        }\n    }\n    \n    /**\n     * Render HTML content with DOMPurify if available\n     */\n    renderHTML(code) {\n        const id = `html-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n        \n        // If DOMPurify is loaded, use it\n        if (window.DOMPurify) {\n            const clean = DOMPurify.sanitize(code);\n            \n            // Create container programmatically\n            const container = document.createElement('div');\n            container.className = 'qde-html-container';\n            container.contentEditable = 'false';\n            container.setAttribute('data-qd-fence', '```');\n            container.setAttribute('data-qd-lang', 'html');\n            container.setAttribute('data-qd-source', code);\n            container.innerHTML = clean;\n            \n            return container.outerHTML;\n        }\n        \n        // Try to lazy load DOMPurify\n        this.lazyLoadLibrary(\n            'DOMPurify',\n            () => window.DOMPurify,\n            'https://unpkg.com/dompurify/dist/purify.min.js'\n        ).then(loaded => {\n            if (loaded) {\n                const element = document.getElementById(id);\n                if (element) {\n                    const clean = DOMPurify.sanitize(code);\n                    element.innerHTML = clean;\n                    // Update attributes after loading\n                    element.setAttribute('data-qd-source', code);\n                    element.setAttribute('data-qd-fence', '```');\n                    element.setAttribute('data-qd-lang', 'html');\n                }\n            }\n        });\n        \n        // Return placeholder with bidirectional attributes - non-editable\n        const placeholder = document.createElement('div');\n        placeholder.id = id;\n        placeholder.className = 'qde-html-container';\n        placeholder.contentEditable = 'false';\n        placeholder.setAttribute('data-qd-fence', '```');\n        placeholder.setAttribute('data-qd-lang', 'html');\n        placeholder.setAttribute('data-qd-source', code);\n        const pre = document.createElement('pre');\n        pre.textContent = code;\n        placeholder.appendChild(pre);\n        \n        return placeholder.outerHTML;\n    }\n    \n    /**\n     * Render math with MathJax (SVG output for better copy support)\n     */\n    renderMath(code, lang) {\n        const id = `math-${Math.random().toString(36).substring(2, 15)}`;\n        \n        // Create container exactly like squibview\n        const container = document.createElement('div');\n        container.id = id;\n        container.className = 'math-display';\n        container.contentEditable = 'false';\n        container.setAttribute('data-source-type', 'math');\n        \n        // Format content for MathJax (display mode with $$) - exactly like squibview\n        const singleLineContent = code.replace(/\\r?\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n        container.textContent = `$$${singleLineContent}$$`;\n        \n        // Add centering style\n        container.style.textAlign = 'center';\n        container.style.margin = '1em 0';\n        \n        console.log('Creating math container:', {\n            id: id,\n            content: singleLineContent,\n            containerHTML: container.outerHTML\n        });\n        \n        // Ensure MathJax will be loaded (if not already)\n        if (!window.MathJax || !window.MathJax.typesetPromise) {\n            this.ensureMathJaxLoaded();\n        }\n        \n        // MathJax will be processed in batch after preview update\n        return container.outerHTML;\n    }\n    \n    /**\n     * Ensures MathJax is loaded (but doesn't process elements)\n     */\n    ensureMathJaxLoaded() {\n        if (typeof window.MathJax === 'undefined' && !window.mathJaxLoading) {\n            window.mathJaxLoading = true;\n            \n            // Configure MathJax before loading\n            if (!window.MathJax) {\n                window.MathJax = {\n                    loader: { load: ['input/tex', 'output/svg'] },\n                    tex: { \n                        packages: { '[+]': ['ams'] },\n                        inlineMath: [['$', '$'], ['\\\\(', '\\\\)']],\n                        displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']],\n                        processEscapes: true\n                    },\n                    svg: {\n                        fontCache: 'global',\n                        scale: 1\n                    },\n                    startup: { typeset: false }\n                };\n            }\n            \n            const script = document.createElement('script');\n            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js';\n            script.async = true;\n            script.onload = () => {\n                window.mathJaxLoading = false;\n                console.log('MathJax loaded successfully');\n                \n                // Process any existing math elements (like squibview)\n                if (window.MathJax && window.MathJax.typesetPromise) {\n                    const mathElements = document.querySelectorAll('.math-display');\n                    if (mathElements.length > 0) {\n                        window.MathJax.typesetPromise(Array.from(mathElements)).catch(err => {\n                            console.warn('Initial MathJax processing failed:', err);\n                        });\n                    }\n                }\n            };\n            script.onerror = () => {\n                window.mathJaxLoading = false;\n                console.error('Failed to load MathJax');\n            };\n            document.head.appendChild(script);\n        }\n    }\n    \n    /**\n     * DEPRECATED - Ensures MathJax is loaded and typesets the math element\n     */\n    async ensureMathJaxAndTypeset(id, code, lang) {\n        if (typeof window.MathJax === 'undefined') {\n            if (window.mathJaxLoading) return;\n            window.mathJaxLoading = true;\n            \n            // Configure MathJax before loading script to ensure SVG output\n            if (!window.MathJax) {\n                window.MathJax = {\n                    loader: { load: ['input/tex', 'output/svg'] },\n                    tex: { \n                        packages: { '[+]': ['ams'] },\n                        inlineMath: [['$', '$'], ['\\\\(', '\\\\)']],\n                        displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']],\n                        processEscapes: true\n                    },\n                    svg: {\n                        fontCache: 'global',\n                        scale: 1\n                    },\n                    startup: { typeset: false }\n                };\n            }\n            \n            const script = document.createElement('script');\n            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js';\n            script.async = true;\n            script.onload = () => {\n                window.mathJaxLoading = false;\n                console.log('MathJax loaded, processing element:', id);\n                // Process the element after a small delay to ensure it's in the DOM\n                setTimeout(() => {\n                    const element = document.getElementById(id);\n                    if (element && window.MathJax && window.MathJax.typesetPromise) {\n                        console.log('Processing lazy-loaded MathJax for:', id, element.textContent);\n                        window.MathJax.typesetPromise([element]).then(() => {\n                            console.log('MathJax lazy processing complete for:', id);\n                        }).catch(err => {\n                            console.warn('MathJax rendering failed:', err);\n                            element.innerHTML = `<pre class=\"qde-error\">Math rendering failed: ${this.escapeHtml(err.message)}</pre>`;\n                        });\n                    } else {\n                        console.warn('Element not found after MathJax load:', id);\n                    }\n                }, 100);\n            };\n            script.onerror = () => {\n                window.mathJaxLoading = false;\n                console.error('Failed to load MathJax');\n            };\n            document.head.appendChild(script);\n        } else if (window.MathJax && window.MathJax.typesetPromise) {\n            // MathJax is loaded, process the element after a delay\n            setTimeout(() => {\n                const element = document.getElementById(id);\n                if (element) {\n                    console.log('Processing already-loaded MathJax for:', id, element.textContent);\n                    window.MathJax.typesetPromise([element]).then(() => {\n                        console.log('MathJax processing complete (already loaded) for:', id);\n                    }).catch(err => {\n                        console.warn('MathJax rendering failed:', err);\n                        element.innerHTML = `<pre class=\"qde-error\">Math rendering failed: ${this.escapeHtml(err.message)}</pre>`;\n                    });\n                } else {\n                    console.warn('Element not found for MathJax processing:', id);\n                }\n            }, 100);\n        }\n    }\n    \n    /**\n     * Render CSV/PSV/TSV as HTML table\n     */\n    renderTable(code, lang) {\n        const escapedCode = this.escapeHtml(code);\n        try {\n            const delimiter = lang === 'csv' ? ',' : lang === 'psv' ? '|' : '\\t';\n            const lines = code.trim().split('\\n');\n            \n            if (lines.length === 0) {\n                return `<pre data-qd-fence=\"\\`\\`\\`\" data-qd-lang=\"${lang}\" data-qd-source=\"${escapedCode}\">${escapedCode}</pre>`;\n            }\n            \n            // CSV tables CAN be editable - we'll convert HTML table back to CSV\n            // Don't need data-qd-source since we convert the table structure back to CSV\n            let html = `<table class=\"qde-data-table qde-csv-table\" data-qd-fence=\"\\`\\`\\`\" data-qd-lang=\"${lang}\">`;\n            \n            // Parse header\n            const header = this.parseCSVLine(lines[0], delimiter);\n            html += '<thead><tr>';\n            header.forEach(cell => {\n                html += `<th>${this.escapeHtml(cell.trim())}</th>`;\n            });\n            html += '</tr></thead>';\n            \n            // Parse body\n            if (lines.length > 1) {\n                html += '<tbody>';\n                for (let i = 1; i < lines.length; i++) {\n                    const row = this.parseCSVLine(lines[i], delimiter);\n                    html += '<tr>';\n                    row.forEach(cell => {\n                        html += `<td>${this.escapeHtml(cell.trim())}</td>`;\n                    });\n                    html += '</tr>';\n                }\n                html += '</tbody>';\n            }\n            \n            html += '</table>';\n            return html;\n        } catch (err) {\n            return `<pre data-qd-fence=\"\\`\\`\\`\" data-qd-lang=\"${lang}\" data-qd-source=\"${escapedCode}\">${escapedCode}</pre>`;\n        }\n    }\n    \n    /**\n     * Parse CSV line handling quoted values\n     */\n    parseCSVLine(line, delimiter) {\n        const result = [];\n        let current = '';\n        let inQuotes = false;\n        \n        for (let i = 0; i < line.length; i++) {\n            const char = line[i];\n            const nextChar = line[i + 1];\n            \n            if (char === '\"') {\n                if (inQuotes && nextChar === '\"') {\n                    current += '\"';\n                    i++; // Skip next quote\n                } else {\n                    inQuotes = !inQuotes;\n                }\n            } else if (char === delimiter && !inQuotes) {\n                result.push(current);\n                current = '';\n            } else {\n                current += char;\n            }\n        }\n        \n        result.push(current);\n        return result;\n    }\n    \n    /**\n     * Render JSON with syntax highlighting\n     */\n    renderJSON(code, lang) {\n        // If highlight.js is available, use it for all JSON\n        if (window.hljs && hljs.getLanguage('json')) {\n            try {\n                // Try to format if valid JSON\n                let toHighlight = code;\n                try {\n                    const data = JSON.parse(code);\n                    toHighlight = JSON.stringify(data, null, 2);\n                } catch (e) {\n                    // Use original if not valid JSON\n                }\n                \n                const highlighted = hljs.highlight(toHighlight, { language: 'json' }).value;\n                return `<pre class=\"qde-json\" data-qd-fence=\"\\`\\`\\`\" data-qd-lang=\"${lang}\"><code class=\"hljs language-json\">${highlighted}</code></pre>`;\n            } catch (e) {\n                // Fall through if highlighting fails\n            }\n        }\n        \n        // No highlighting available - return plain\n        return `<pre class=\"qde-json\" data-qd-fence=\"\\`\\`\\`\" data-qd-lang=\"${lang}\">${this.escapeHtml(code)}</pre>`;\n    }\n    \n    /**\n     * Render GeoJSON map\n     */\n    renderGeoJSON(code) {\n        // Generate unique map ID (following SquibView pattern)\n        const mapId = `map-${Math.random().toString(36).substr(2, 15)}`;\n        \n        // Function to render the map\n        const renderMap = () => {\n            const container = document.getElementById(mapId + '-container');\n            if (!container || !window.L) return;\n            \n            try {\n                const data = JSON.parse(code);\n                \n                // Clear container and set deterministic size for rasterization\n                const mapDiv = document.createElement('div');\n                mapDiv.id = mapId;\n                mapDiv.style.cssText = 'width: 100%; height: 300px;';\n                container.innerHTML = '';\n                container.appendChild(mapDiv);\n                \n                // Create the map\n                const map = L.map(mapId);\n                \n                // Store back-reference for capture (per Gem's guide)\n                container._map = map; // Avoid window pollution\n                \n                // Add tile layer with CORS support\n                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                    attribution: '',\n                    crossOrigin: 'anonymous' // Important for canvas capture\n                });\n                tileLayer.addTo(map);\n                \n                // Add GeoJSON layer\n                const geoJsonLayer = L.geoJSON(data);\n                geoJsonLayer.addTo(map);\n                \n                // Fit bounds if valid\n                if (geoJsonLayer.getBounds().isValid()) {\n                    map.fitBounds(geoJsonLayer.getBounds());\n                } else {\n                    map.setView([0, 0], 2);\n                }\n                \n                // Store references for copy-time capture\n                container._tileLayer = tileLayer;\n                container._geoJsonLayer = geoJsonLayer;\n                \n                // Optional: Wait for tiles to load for better capture\n                tileLayer.on('load', () => {\n                    container.setAttribute('data-tiles-loaded', 'true');\n                });\n                \n            } catch (err) {\n                container.innerHTML = `<pre class=\"qde-error\">GeoJSON error: ${this.escapeHtml(err.message)}</pre>`;\n            }\n        };\n        \n        // Check if Leaflet is already loaded\n        if (window.L) {\n            // Render after DOM update\n            setTimeout(renderMap, 0);\n        } else {\n            // Lazy load Leaflet only if not already loading\n            if (!window._qde_leaflet_loading) {\n                window._qde_leaflet_loading = this.lazyLoadLibrary(\n                    'Leaflet',\n                    () => window.L,\n                    'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',\n                    'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'\n                ).catch(err => {\n                    console.warn('Failed to load Leaflet:', err);\n                    // Clear the loading promise so it can be retried\n                    window._qde_leaflet_loading = null;\n                    return false;\n                });\n            }\n            \n            window._qde_leaflet_loading.then(loaded => {\n                if (loaded) {\n                    renderMap();\n                } else {\n                    const element = document.getElementById(id);\n                    if (element) {\n                        element.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #666;\">Failed to load map library</div>';\n                    }\n                }\n            }).catch(() => {\n                // Error already handled above\n            });\n        }\n        \n        // Return container following SquibView pattern\n        const container = document.createElement('div');\n        container.className = 'geojson-container';\n        container.id = mapId + '-container';\n        container.style.cssText = 'width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 4px; margin: 0.5em 0; background: #f0f0f0;';\n        container.contentEditable = 'false';\n        \n        // Preserve source for copy-time identification (per Gem's guide)\n        container.setAttribute('data-source-type', 'geojson');\n        container.setAttribute('data-original-source', this.escapeHtml(code));\n        \n        // For bidirectional editing\n        container.setAttribute('data-qd-fence', '```');\n        container.setAttribute('data-qd-lang', 'geojson');\n        container.setAttribute('data-qd-source', code);\n        \n        container.textContent = 'Loading map...';\n        \n        return container.outerHTML;\n    }\n    \n    /**\n     * Render STL 3D model\n     */\n    renderSTL(code) {\n        const id = `qde-stl-viewer-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n        \n        // Function to render the 3D model\n        const render3D = () => {\n            const element = document.getElementById(id);\n            if (!element) return;\n            \n            // Check if Three.js is available\n            if (typeof window.THREE === 'undefined') {\n                element.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #666;\">Three.js library not loaded. Add &lt;script src=\"https://unpkg.com/three@0.147.0/build/three.min.js\"&gt;&lt;/script&gt; to your HTML.</div>';\n                return;\n            }\n            \n            try {\n                const THREE = window.THREE;\n                \n                // Create scene\n                const scene = new THREE.Scene();\n                scene.background = new THREE.Color(0xf0f0f0);\n                \n                // Create camera\n                const camera = new THREE.PerspectiveCamera(75, element.clientWidth / 400, 0.1, 1000);\n                \n                // Create renderer\n                const renderer = new THREE.WebGLRenderer({ antialias: true });\n                renderer.setSize(element.clientWidth, 400);\n                element.innerHTML = '';\n                element.appendChild(renderer.domElement);\n                \n                // Store Three.js references for copy functionality (like squibview)\n                element._threeScene = scene;\n                element._threeCamera = camera;\n                element._threeRenderer = renderer;\n                \n                // Parse STL data (ASCII format)\n                const geometry = this.parseSTL(code);\n                const material = new THREE.MeshLambertMaterial({ color: 0x0066ff });\n                const mesh = new THREE.Mesh(geometry, material);\n                scene.add(mesh);\n                \n                // Add lighting\n                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);\n                scene.add(ambientLight);\n                \n                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);\n                directionalLight.position.set(1, 1, 1).normalize();\n                scene.add(directionalLight);\n                \n                // Position camera based on object bounds\n                const box = new THREE.Box3().setFromObject(mesh);\n                const center = box.getCenter(new THREE.Vector3());\n                const size = box.getSize(new THREE.Vector3());\n                const maxDim = Math.max(size.x, size.y, size.z);\n                \n                camera.position.set(center.x + maxDim, center.y + maxDim, center.z + maxDim);\n                camera.lookAt(center);\n                \n                // Animate\n                const animate = () => {\n                    requestAnimationFrame(animate);\n                    mesh.rotation.y += 0.01;\n                    renderer.render(scene, camera);\n                };\n                animate();\n            } catch (err) {\n                console.error('STL rendering error:', err);\n                element.innerHTML = `<pre class=\"qde-error\">STL error: ${this.escapeHtml(err.message)}</pre>`;\n            }\n        };\n        \n        // Render after DOM update\n        setTimeout(render3D, 0);\n        \n        // Return placeholder with data-stl-id for copy functionality\n        return `<div id=\"${id}\" class=\"qde-stl-container\" data-stl-id=\"${id}\" data-qd-fence=\"\\`\\`\\`\" data-qd-lang=\"stl\" data-qd-source=\"${this.escapeHtml(code)}\" contenteditable=\"false\" style=\"height: 400px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;\">Loading 3D model...</div>`;\n    }\n    \n    /**\n     * Parse ASCII STL format\n     * @param {string} stlData - The STL file content\n     * @returns {THREE.BufferGeometry} - The parsed geometry\n     */\n    parseSTL(stlData) {\n        const THREE = window.THREE;\n        const geometry = new THREE.BufferGeometry();\n        const vertices = [];\n        const normals = [];\n        \n        const lines = stlData.split('\\n');\n        let currentNormal = null;\n        \n        for (let line of lines) {\n            line = line.trim();\n            \n            if (line.startsWith('facet normal')) {\n                const parts = line.split(/\\s+/);\n                currentNormal = [parseFloat(parts[2]), parseFloat(parts[3]), parseFloat(parts[4])];\n            } else if (line.startsWith('vertex')) {\n                const parts = line.split(/\\s+/);\n                vertices.push(parseFloat(parts[1]), parseFloat(parts[2]), parseFloat(parts[3]));\n                if (currentNormal) {\n                    normals.push(currentNormal[0], currentNormal[1], currentNormal[2]);\n                }\n            }\n        }\n        \n        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));\n        geometry.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));\n        \n        return geometry;\n    }\n    \n    /**\n     * Render Mermaid diagram\n     */\n    renderMermaid(code) {\n        const id = `mermaid-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n        setTimeout(() => {\n            const element = document.getElementById(id);\n            if (element && window.mermaid) {\n                mermaid.render(id + '-svg', code).then(result => {\n                    element.innerHTML = result.svg;\n                }).catch(err => {\n                    element.innerHTML = `<pre>Error rendering diagram: ${err.message}</pre>`;\n                });\n            }\n        }, 0);\n        \n        // Create container programmatically\n        const container = document.createElement('div');\n        container.id = id;\n        container.className = 'mermaid';\n        container.contentEditable = 'false';\n        container.setAttribute('data-qd-source', code);\n        container.setAttribute('data-qd-fence', '```');\n        container.setAttribute('data-qd-lang', 'mermaid');\n        container.textContent = 'Loading diagram...';\n        \n        return container.outerHTML;\n    }\n    \n    /**\n     * Escape HTML for attributes\n     */\n    escapeHtml(text) {\n        return (text ?? \"\").replace(/[&\"'<>]/g, m => \n            ({'&':'&amp;','\"':'&quot;',\"'\":'&#39;','<':'&lt;','>':'&gt;'}[m]));\n    }\n    \n    /**\n     * Make complex fence blocks non-editable\n     */\n    makeFencesNonEditable() {\n        if (!this.previewPanel) return;\n        \n        // Only make specific complex fence types non-editable\n        // SVG, HTML, Math, Mermaid already have contenteditable=\"false\" set\n        // Syntax-highlighted code also has it set\n        \n        // Don't make regular code blocks or tables non-editable\n        // They can be edited and properly round-trip\n    }\n    \n    /**\n     * Load plugins dynamically\n     */\n    async loadPlugins() {\n        const promises = [];\n        \n        // Load highlight.js (check if already loaded)\n        if (this.options.plugins.highlightjs && !window.hljs) {\n            promises.push(\n                this.loadScript('https://unpkg.com/@highlightjs/cdn-assets/highlight.min.js'),\n                this.loadCSS('https://unpkg.com/@highlightjs/cdn-assets/styles/github.min.css')\n            );\n        }\n        \n        // Load mermaid (check if already loaded)\n        if (this.options.plugins.mermaid && !window.mermaid) {\n            promises.push(\n                this.loadScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(() => {\n                    if (window.mermaid) {\n                        mermaid.initialize({ startOnLoad: false });\n                    }\n                })\n            );\n        }\n        \n        await Promise.all(promises);\n    }\n    \n    /**\n     * Lazy load library if not already loaded\n     */\n    async lazyLoadLibrary(name, check, scriptUrl, cssUrl = null) {\n        // Check if library is already loaded\n        if (check()) {\n            return true;\n        }\n        \n        try {\n            const promises = [];\n            \n            // Load script\n            if (scriptUrl) {\n                promises.push(this.loadScript(scriptUrl));\n            }\n            \n            // Load CSS if provided\n            if (cssUrl) {\n                promises.push(this.loadCSS(cssUrl));\n            }\n            \n            await Promise.all(promises);\n            \n            // Verify library loaded\n            return check();\n        } catch (err) {\n            console.error(`Failed to load ${name}:`, err);\n            return false;\n        }\n    }\n    \n    /**\n     * Load external script\n     */\n    loadScript(src) {\n        return new Promise((resolve, reject) => {\n            const script = document.createElement('script');\n            script.src = src;\n            script.onload = resolve;\n            script.onerror = reject;\n            document.head.appendChild(script);\n        });\n    }\n    \n    /**\n     * Load external CSS\n     */\n    loadCSS(href) {\n        return new Promise((resolve) => {\n            const link = document.createElement('link');\n            link.rel = 'stylesheet';\n            link.href = href;\n            link.onload = resolve;\n            document.head.appendChild(link);\n            // Resolve anyway after timeout (CSS doesn't always fire onload)\n            setTimeout(resolve, 1000);\n        });\n    }\n    \n    /**\n     * Apply theme\n     */\n    applyTheme() {\n        const theme = this.options.theme;\n        \n        if (theme === 'auto') {\n            // Check system preference\n            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\n            this.container.classList.toggle('qde-dark', isDark);\n            \n            // Listen for changes\n            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {\n                this.container.classList.toggle('qde-dark', e.matches);\n            });\n        } else {\n            this.container.classList.toggle('qde-dark', theme === 'dark');\n        }\n    }\n    \n    /**\n     * Set lazy linefeeds option\n     * @param {boolean} enabled - Whether to enable lazy linefeeds\n     */\n    setLazyLinefeeds(enabled) {\n        this.options.lazy_linefeeds = enabled;\n        // Re-render if we have content\n        if (this._markdown) {\n            this.updateFromSource();\n        }\n    }\n    \n    /**\n     * Get lazy linefeeds option\n     * @returns {boolean}\n     */\n    getLazyLinefeeds() {\n        return this.options.lazy_linefeeds;\n    }\n    \n    /**\n     * Set debounce delay for input updates\n     * @param {number} delay - Delay in milliseconds (0 for instant)\n     */\n    setDebounceDelay(delay) {\n        this.options.debounceDelay = Math.max(0, delay);\n    }\n    \n    /**\n     * Get current debounce delay\n     * @returns {number} Delay in milliseconds\n     */\n    getDebounceDelay() {\n        return this.options.debounceDelay;\n    }\n    \n    /**\n     * Set editor mode\n     */\n    setMode(mode) {\n        if (!['source', 'preview', 'split'].includes(mode)) return;\n        \n        this.currentMode = mode;\n        this.container.className = `qde-container qde-mode-${mode}`;\n        \n        // Update toolbar buttons\n        if (this.toolbar) {\n            this.toolbar.querySelectorAll('.qde-btn[data-mode]').forEach(btn => {\n                btn.classList.toggle('active', btn.dataset.mode === mode);\n            });\n        }\n        \n        // Apply theme class\n        if (this.container.classList.contains('qde-dark')) {\n            this.container.classList.add('qde-dark');\n        }\n        \n        // Make fence blocks non-editable when showing preview\n        if (mode !== 'source') {\n            setTimeout(() => this.makeFencesNonEditable(), 0);\n        }\n        \n        // Trigger mode change event\n        if (this.options.onModeChange) {\n            this.options.onModeChange(mode);\n        }\n    }\n    \n    /**\n     * Handle toolbar actions\n     */\n    handleAction(action) {\n        switch(action) {\n            case 'copy-markdown':\n                this.copy('markdown');\n                break;\n            case 'copy-html':\n                this.copy('html');\n                break;\n            case 'copy-rendered':\n                this.copyRendered();\n                break;\n            case 'remove-hr':\n                this.removeHR();\n                break;\n        }\n    }\n    \n    /**\n     * Copy content to clipboard\n     */\n    async copy(type) {\n        const content = type === 'markdown' ? this._markdown : this._html;\n        \n        try {\n            await navigator.clipboard.writeText(content);\n            \n            // Visual feedback\n            const btn = this.toolbar.querySelector(`[data-action=\"copy-${type}\"]`);\n            if (btn) {\n                const originalText = btn.textContent;\n                btn.textContent = 'Copied!';\n                setTimeout(() => {\n                    btn.textContent = originalText;\n                }, 1500);\n            }\n        } catch (err) {\n            console.error('Failed to copy:', err);\n        }\n    }\n    \n    // Public API\n    \n    /**\n     * Get current markdown\n     */\n    get markdown() {\n        return this._markdown;\n    }\n    \n    /**\n     * Set markdown content\n     */\n    set markdown(value) {\n        this.setMarkdown(value);\n    }\n    \n    /**\n     * Get current HTML\n     */\n    get html() {\n        return this._html;\n    }\n    \n    /**\n     * Get current mode\n     */\n    get mode() {\n        return this.currentMode;\n    }\n    \n    /**\n     * Set markdown content\n     */\n    async setMarkdown(markdown) {\n        // Wait for initialization if needed\n        if (this.initPromise) {\n            await this.initPromise;\n        }\n        \n        this._markdown = markdown;\n        if (this.sourceTextarea) {\n            this.sourceTextarea.value = markdown;\n        }\n        this.updateFromMarkdown(markdown);\n    }\n    \n    /**\n     * Get markdown content\n     */\n    getMarkdown() {\n        return this._markdown;\n    }\n    \n    /**\n     * Get HTML content\n     */\n    getHTML() {\n        return this._html;\n    }\n    \n    /**\n     * Remove all horizontal rules (---) from markdown\n     */\n    async removeHR() {\n        // Remove standalone HR lines (3 or more dashes/underscores/asterisks)\n        // Matches: ---, ___, ***, ----, etc. with optional spaces\n        const cleaned = this._markdown\n            .split('\\n')\n            .filter(line => {\n                // Keep lines that aren't just HR patterns\n                const trimmed = line.trim();\n                // Match HR patterns: 3+ of -, _, or * with optional spaces between\n                return !(/^[-_*](\\s*[-_*]){2,}\\s*$/.test(trimmed));\n            })\n            .join('\\n');\n        \n        // Update the markdown\n        await this.setMarkdown(cleaned);\n        \n        // Visual feedback if toolbar button exists\n        const btn = this.toolbar?.querySelector('[data-action=\"remove-hr\"]');\n        if (btn) {\n            const originalText = btn.textContent;\n            btn.textContent = 'Removed!';\n            setTimeout(() => {\n                btn.textContent = originalText;\n            }, 1500);\n        }\n    }\n    \n    /**\n     * Copy rendered content as rich text\n     */\n    async copyRendered() {\n        try {\n            const result = await getRenderedContent(this.previewPanel);\n            if (result.success) {\n                // Visual feedback\n                const btn = this.toolbar?.querySelector('[data-action=\"copy-rendered\"]');\n                if (btn) {\n                    const originalText = btn.textContent;\n                    btn.textContent = 'Copied!';\n                    setTimeout(() => {\n                        btn.textContent = originalText;\n                    }, 1500);\n                }\n            }\n        } catch (err) {\n            console.error('Failed to copy rendered content:', err);\n        }\n    }\n    \n    /**\n     * Destroy the editor\n     */\n    destroy() {\n        // Clear timers\n        clearTimeout(this.updateTimer);\n        \n        // Clear container\n        this.container.innerHTML = '';\n        this.container.classList.remove('qde-container', 'qde-dark');\n        \n        // Remove injected styles (only if no other editors exist)\n        const otherEditors = document.querySelectorAll('.qde-container');\n        if (otherEditors.length === 0) {\n            const style = document.getElementById('qde-styles');\n            if (style) style.remove();\n        }\n    }\n}\n\n// Export\nexport default QuikdownEditor;\n\n// Export for CommonJS (needed for bundled ESM to work with Jest)\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = QuikdownEditor;\n}\n\n// Also export for UMD builds\nif (typeof window !== 'undefined') {\n    window.QuikdownEditor = QuikdownEditor;\n}"],"names":["CLASS_PREFIX","PLACEHOLDER_CB","ESC_MAP","QUIKDOWN_STYLES","h1","h2","h3","h4","h5","h6","pre","code","blockquote","table","th","td","hr","img","a","strong","em","del","ul","ol","li","quikdown","markdown","options","fence_plugin","inline_styles","bidirectional","lazy_linefeeds","getAttr","styles","tag","additionalStyle","style","includes","replace","trim","endsWith","classAttr","createGetAttr","escapeHtml","text","m","dataQd","marker","sanitizeUrl","url","allowUnsafe","trimmedUrl","lowerUrl","toLowerCase","dangerousProtocols","protocol","startsWith","html","codeBlocks","inlineCodes","match","fence","lang","placeholder","length","langTrimmed","render","push","trimEnd","custom","hasReverse","reverse","lines","split","result","inTable","tableLines","i","line","test","tableHtml","buildTable","join","processTable","hashes","content","level","listStack","indent","Math","floor","isOrdered","listType","listItemContent","taskListClass","taskMatch","checked","taskContent","isChecked","list","pop","type","currentList","liAttr","processLists","alt","src","sanitizedSrc","allow_unsafe_urls","altAttr","srcAttr","href","sanitizedHref","rel","textAttr","prefix","sanitizedUrl","forEach","pattern","blocks","bi","b","offset","substring","RegExp","replacement","block","undefined","langClass","codeAttr","langAttr","fenceAttr","processInlineMarkdown","separatorIndex","headerLines","slice","bodyLines","alignments","map","cell","trimmed","alignStyle","processedCell","quikdown_bd","async","svgToPng","svgElement","needsWhiteBackground","Promise","resolve","reject","svgString","XMLSerializer","serializeToString","canvas","document","createElement","ctx","getContext","Image","isMermaidSvg","closest","classList","contains","hasExplicitDimensions","getAttribute","svgWidth","svgHeight","clientWidth","viewBox","baseVal","width","parseFloat","clientHeight","height","modifiedSvgString","tempDiv","innerHTML","tempSvg","querySelector","setAttribute","toString","scale","onload","fillStyle","fillRect","drawImage","toBlob","blob","err","onerror","svgDataUrl","encodeURIComponent","rasterizeGeoJSONMap","liveContainer","_map","console","warn","mapRect","getBoundingClientRect","round","dpr","window","devicePixelRatio","tiles","querySelectorAll","log","tilePromises","tile","crossOrigin","tileRect","offsetX","left","offsetY","top","all","svgOverlays","svg","svgRect","svgStr","svgBlob","Blob","URL","createObjectURL","revokeObjectURL","Error","markerIcons","markerRect","toDataURL","error","getRenderedContent","previewPanel","mathBlocks","Array","from","some","MathJax","typesetPromise","clone","cloneNode","el","fontWeight","fontStyle","textDecoration","backgroundColor","padding","borderRadius","fontFamily","fontSize","marginTop","marginBottom","borderLeft","marginLeft","paddingLeft","color","border","borderTop","margin","borderCollapse","textAlign","parentElement","tr","lineHeight","whiteSpace","overflowX","appendChild","parentNode","replaceChild","images","naturalWidth","naturalHeight","maxWidth","maxHeight","min","random","substr","response","fetch","maxSize","size","dataUrl","reader","FileReader","onloadend","readAsDataURL","stlContainers","container","containerId","dataset","stlId","originalContainer","renderer","_threeRenderer","scene","_threeScene","camera","_threeCamera","imgWidth","imgHeight","canvasErr","cssText","textContent","mermaidContainers","pngBlob","chartContainers","chartId","svgContainers","mathElements","mathEl","mjxContainer","id","hasMjxContainer","hasSVG","origMath","_","tdiv","ts","hasAttribute","exToPx","val","num","isNaN","String","w","h","wPx","hPx","vw","vh","rect","usedRect","value","e","scaleFactor","scaledWidth","scaledHeight","scaleX","scaleY","max","pixels","getImageData","data","nonWhitePixels","toFixed","imgElement","probe","geojsonContainers","clonedContainer","originalSource","allLiveContainers","candidate","mapContainers","leafletContainer","leafRect","r","x","y","overlaps","right","bottom","getComputedStyle","display","visibility","overlaySvgs","icon","mapDataUrl","htmlContainers","source","htmlImages","widthAttr","heightAttr","parseInt","tempImg","displayWidth","displayHeight","aspectRatio","absoluteImg","fragment","htmlContent","innerText","platform","navigator","userAgent","getPlatform","clipboard","write","ClipboardItem","success","modernErr","position","overflow","body","range","createRange","selectNodeContents","selection","getSelection","removeAllRanges","addRange","execCommand","removeChild","copyToClipboard","emitStyles","theme","themeOverrides","_textColor","css","Object","entries","themedStyle","oldColor","newColor","configure","version","module","exports","keys","key","toMarkdown","htmlOrElement","Element","walkNode","node","parentContext","nodeType","Node","TEXT_NODE","ELEMENT_NODE","tagName","childContent","child","childNodes","parentTag","repeat","boldMarker","emMarker","delMarker","codeMarker","fenceMarker","codeEl","quoteMarker","linkText","walkList","alignData","thead","headerRow","headers","align","tbody","row","cells","walkTable","trailingBlankLines","divLang","divFence","divSource","temp","mermaidPre","preSource","sourceElement","mermaidElement","listNode","depth","index","children","checkbox","itemContent","DEFAULT_OPTIONS","mode","showToolbar","showRemoveHR","debounceDelay","plugins","highlightjs","mermaid","customFences","enableComplexFences","QuikdownEditor","constructor","this","_markdown","_html","currentMode","updateTimer","initPromise","init","loadPlugins","buildUI","attachEvents","applyTheme","setMode","initialContent","setMarkdown","add","toolbar","createToolbar","editorArea","className","sourcePanel","sourceTextarea","contentEditable","injectStyles","modeLabels","preview","btn","title","spacer","action","removeHRBtn","getElementById","head","addEventListener","handleSourceInput","handlePreviewInput","target","handleAction","ctrlKey","metaKey","preventDefault","clearTimeout","setTimeout","updateFromMarkdown","updateFromHTML","createFencePlugin","makeFencesNonEditable","hasInnerHTML","then","catch","onChange","clonedPanel","preprocessSpecialElements","panel","element","delimiter","csv","needsQuoting","renderSVG","renderHTML","renderMath","renderTable","renderJSON","renderMermaid","renderGeoJSON","renderSTL","hljs","getLanguage","highlight","language","doc","DOMParser","parseFromString","documentElement","remove","walker","createTreeWalker","NodeFilter","SHOW_ELEMENT","nextNode","attributes","attr","name","removeAttribute","outerHTML","errorContainer","message","Date","now","DOMPurify","clean","sanitize","lazyLoadLibrary","loaded","singleLineContent","containerHTML","ensureMathJaxLoaded","mathJaxLoading","loader","load","tex","packages","inlineMath","displayMath","processEscapes","fontCache","startup","typeset","script","ensureMathJaxAndTypeset","escapedCode","header","parseCSVLine","current","inQuotes","char","nextChar","toHighlight","JSON","parse","stringify","mapId","renderMap","L","mapDiv","tileLayer","attribution","addTo","geoJsonLayer","geoJSON","getBounds","isValid","fitBounds","setView","_tileLayer","_geoJsonLayer","on","_qde_leaflet_loading","THREE","Scene","background","Color","PerspectiveCamera","WebGLRenderer","antialias","setSize","domElement","geometry","parseSTL","material","MeshLambertMaterial","mesh","Mesh","ambientLight","AmbientLight","directionalLight","DirectionalLight","set","normalize","box","Box3","setFromObject","center","getCenter","Vector3","getSize","maxDim","z","lookAt","animate","requestAnimationFrame","rotation","stlData","BufferGeometry","vertices","normals","currentNormal","parts","Float32BufferAttribute","promises","loadScript","loadCSS","initialize","startOnLoad","check","scriptUrl","cssUrl","link","isDark","matchMedia","matches","toggle","setLazyLinefeeds","enabled","updateFromSource","getLazyLinefeeds","setDebounceDelay","delay","getDebounceDelay","onModeChange","copy","copyRendered","removeHR","writeText","originalText","getMarkdown","getHTML","cleaned","filter","destroy"],"mappings":"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"}